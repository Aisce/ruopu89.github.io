<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/08/LVM逻辑卷/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/08/LVM逻辑卷/" itemprop="url">
                  LVM逻辑卷
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-08 09:29:42" itemprop="dateCreated datePublished" datetime="2018-10-08T09:29:42+08:00">2018-10-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-09 13:12:12" itemprop="dateModified" datetime="2018-10-09T13:12:12+08:00">2018-10-09</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/磁盘/" itemprop="url" rel="index"><span itemprop="name">磁盘</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><ul>
<li><p>MD：在內核中它的所有調配工作由md這個模塊來完成，進而能實現將多個物理設備組合成一個邏輯設備或叫元設備（meta device）。主要用來實現軟RAID： /dev/md#</p>
</li>
<li><p>DM：Device Mapper 設備映射；這種機制也能夠提供將多個物理設備映射成一個邏輯設備，功能比MD強大；由多個子模塊組成，完成多種不同的組織方式。</p>
<p>​              可提供軟RAID，LVM2功能</p>
</li>
<li><p>快照功能：保留數據在你做快照那一刻的狀態，快照一般小於原數據，它只是訪問同一個數據的另一條路徑，與文件軟鏈接相似，默認訪問只有一個路徑，快照是另一條路徑，又不僅限於路徑，它也可以作爲用戶去訪問對應磁盤上它所映射文件的通路。將快照那一刻的狀態保留下來作爲文件的訪問通道，被快照的文件被修改時，先保存一份快照，訪問時看數據是否改變，如果改變就訪問快照裏的數據，沒改變就訪問原數據，所以快照文件很小。快照裏只有一些改變的數據。主要是用來做數據備份的</p>
<p>​       多路徑功能：讓我們實現數據存儲設備的尋路，能通過多种不同的線來完成</p>
</li>
<li><p>LVM 的全名是 Logical Volume Manager，中文可以翻译作逻辑卷轴管理员。LVM 的作用是将几个实体磁盘 通过软件组合成为一块看起来是独立的大磁盘(VG) ，然后将这块大磁盘再经过分割，成为可使用的分割槽 (LV)， 最终就能够挂载使用了。这样的系统可以进行文件通讯员的扩充或缩小与一个称为 PE 的项目有关。 LVM的作用：邏輯設備動態增減</p>
</li>
<li><p>PV：Physical Volume，实体卷轴。磁盘需要调整系统识别码为8e，然后经过pvcreate命令转为LVM最底层的实体卷轴（PV）</p>
</li>
<li><p>VG：Volume Group，卷轴组。LVM的大磁盘就是将许多PV整合成一个VG。每个VG最多仅能包含65534个PE，如果使用LVM的默认参数，则一个VG最大可达256GB容量。</p>
</li>
<li><p>PE：Physical Extend，实体延伸区块。LVM默认使用4MB的PE区块，而LVM的VG最多可以含有65534个PE，因此默认的VG容量是256GB。这个PE是整个LVM最小的储存区块，我们的文件资料都是由写入PE来处理的。调整PE的大小会影响到VG的最大容量。</p>
</li>
<li><p>LV：Logical Volume，逻辑卷轴。VG最终会被切成LV，这个LV就是最后可以被格式化使用的分区。LV的名称通常为/dev/vgname/lvname。LVM的文件系统容量变更是通过交换PE来进行文件转换的，将原来LV内的PE转移到其他装置中就可以降低LV容量，或将其他装置的PE加到此LV中就可以加大容量。</p>
</li>
<li><p>操作流程</p>
</li>
</ul>
<p><img src="/images/LVM/操作流程.gif"></p>
<ul>
<li><p>线性模式 (linear)：假如我将 /dev/hda1, /dev/hdb1 这两个 partition 加入到 VG 当中，并且整个 VG 只有一个 LV 时，那么所谓的线性模式就是：当 /dev/hda1 的容量用完之后，/dev/hdb1 的硬碟才会被使用到， 这也是我们所建议的模式。</p>
</li>
<li><p>交错模式 (triped)：那什么是交错模式？很简单啊，就是我将一笔资料拆成两部分，分别写入 /dev/hda1 与 /dev/hdb1 的意思，感觉上有点像 RAID 0 啦！如此一来，一份资料用两颗硬碟来写入，理论上，读写的效能会比较好。</p>
<p>基本上，LVM 最主要的用处是在实现一个可以弹性调整容量的文件系统上， 而不是在建立一个效能为主的磁盘上，所以，我们应该利用的是 LVM 可以弹性管理整个 partition 大小的用途上，而不是着眼在效能上的。因此， LVM 预设的读写模式是线性模式。 如果你使用 triped 模式，要注意，当任何一个 partition 损坏时，所有的资料都会‘损毁’的。</p>
</li>
<li><p>在增減邏輯卷大小的時候要用到物理邊界，邏輯邊界的概念，物理邊界指磁盤的大小，邏輯邊界指文件系統的大小。創建分區的過程就是創建物理邊界的過程，在物理邊界內部創建文件系統，文件存儲在文件系統上，文件系統邊界叫邏輯邊界，存多少數據取決於物理邊界大小與邏輯邊界大小，邏輯邊界是緊靠在物理邊界大小上創建的。所以擴展時要先擴展物理邊界，然後再擴展邏輯邊界，如果縮減就相反，先縮減文件系統邊界，再縮減物理邊界。</p>
</li>
<li><p>對卷創建快照指給邏輯卷創建快照，但快照卷必須與邏輯卷在同一個卷組中</p>
</li>
</ul>
<h1 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">* pv</span><br><span class="line">pvcreate：#将实体 partition 建立成为 PV </span><br><span class="line">pvremove：#将 PV 属性移除，让该 partition 不具有 PV 属性。刪除PV中的原數據</span><br><span class="line">pvscan：#搜寻目前系统里面任何具有 PV 的磁碟</span><br><span class="line">pvdisplay：#显示出目前系统上面的 PV 状态</span><br><span class="line">pvmove：#移動PV中的數據到其他PV上，就可以拆掉這個磁盤了。</span><br><span class="line"></span><br><span class="line">* vg</span><br><span class="line">vgcreate：#创建VG</span><br><span class="line">	vgcreate [-s N[mgt]] VG名称 PV名称选项与参数：</span><br><span class="line"><span class="meta">	#</span><span class="bash">-s ：后面接 PE 的大小 (size) ，单位可以是 m, g, t (大小写均可)。默認為4MB</span></span><br><span class="line">vgremove：#删除一个VG</span><br><span class="line">vgscan：#搜寻系统上面是否有VG存在</span><br><span class="line">vgextend：#在VG内擴展额外的PV</span><br><span class="line">vgreduce：#在VG内移除PV</span><br><span class="line">vgs：#搜寻VG，简单输出</span><br><span class="line">vgdisplay：#显示目前系统上面的VG状态</span><br><span class="line">vgchange:#设定 VG 是否启动 (active)；      </span><br><span class="line"></span><br><span class="line">* lv</span><br><span class="line">lvcreate：#创建LV</span><br><span class="line">	lvcreate [-L N[mgt]] [-n LV名称] VG名称</span><br><span class="line">	lvcreate [-l N] [-n LV名称] VG名称选项与参数：</span><br><span class="line"><span class="meta">	#</span><span class="bash">-L  ：后面接容量，容量的单位可以是 M,G,T 等，要注意的是，最小单位为 PE，因此这个数量必须要是 PE 的倍数，若不相符，系统会自行计算最相近的容量。</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">-l  ：后面可以接 PE 的‘个数’，而不是容量。若要这么做，得要自行计算 PE 数。</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">-n  ：后面接的就是 LV 的名称</span></span><br><span class="line">lvremove：#删除LV</span><br><span class="line">lvextend：#在LV里面增加容量</span><br><span class="line">lvreduce：#在LV里面减少容量</span><br><span class="line">lvresize：#对LV进行容量大小的调整</span><br><span class="line">lvs</span><br><span class="line">lvdisplay：#显示系统上面的LV状态</span><br><span class="line">       </span><br><span class="line">* 擴展邏輯卷</span><br><span class="line">	lvextend</span><br><span class="line">		-L [+]n /PATH/TO/LV            </span><br><span class="line"><span class="meta">		#</span><span class="bash">擴展物理邊界，有加號表示要再擴展多大，不用加號表示擴展到多大</span></span><br><span class="line">	resize2fs</span><br><span class="line">	resize2fs /PATH/TO/LV n  </span><br><span class="line"><span class="meta">	#</span><span class="bash">擴展邏輯邊界，這裏只能指定擴展到多大，最大不能超過物理邊界。因爲是ext文件系統，其他文件系統不一定要這樣用，或用其他命令。</span></span><br><span class="line">		-p：不用指定擴展多少，能有多大擴多大</span><br><span class="line">	resize2fs -p /PATH/TO/LV       </span><br><span class="line">               </span><br><span class="line">* 縮減邏輯卷</span><br><span class="line">	resize2fs</span><br><span class="line">	resize2fs [-f] [device] [size]选项与参数：</span><br><span class="line"><span class="meta">	#</span><span class="bash">-f      ：强制进行 resize 的动作！</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">[device]：装置的档案名称；</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">[size]  ：可以加也可以不加。如果加上 size 的话，那么就必须要给予一个单位，譬如 M, G 等等。如果没有 size 的话，那么预设使用‘整个 partition’的容量来处理！  </span></span><br><span class="line"><span class="meta">	#</span><span class="bash">縮減邏輯邊界 </span></span><br><span class="line"><span class="meta">	#</span><span class="bash">不能在線縮減，要先卸載，確保縮減後的空間大小依然能存儲原有的所有數據；在縮減前應該先強行檢查文件，以確保文件系統處於一至性狀態</span></span><br><span class="line"> </span><br><span class="line">	lvreduce -L [-]# /PATH/TO/LV       </span><br><span class="line"><span class="meta">	#</span><span class="bash">縮減物理邊界</span></span><br><span class="line"></span><br><span class="line">* 快照卷</span><br><span class="line">1. 生命周期為整個數據時長，在這段時長內，數據的增長量不能超出快照卷大小；大小自己估計，         保險的辦法是和原卷一樣大，或與原卷中數據一樣大</span><br><span class="line">2. 快照卷應該是只讀的</span><br><span class="line">3. 跟原卷在同一卷組內</span><br><span class="line"> </span><br><span class="line">lvcreate</span><br><span class="line">	-s: #指定為快照卷</span><br><span class="line">	-P r|w: #設定是只讀還是讀寫權限，建議爲只讀</span><br><span class="line"> </span><br><span class="line">	lvcreate -L n -n SLV_NAME -s -p r /PATH/TO/LV</span><br><span class="line"><span class="meta">	#</span><span class="bash">-L指定大小，-n指定快照卷名稱，最後指定對哪個邏輯卷創建</span></span><br></pre></td></tr></table></figure>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="创建LVM卷"><a href="#创建LVM卷" class="headerlink" title="创建LVM卷"></a>创建LVM卷</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">* 准备分区</span><br><span class="line">fdisk /dev/sdb</span><br><span class="line"><span class="meta">#</span><span class="bash">分出四个分区，并将分区system ID改为8e。</span></span><br><span class="line">partprobe /dev/sdb</span><br><span class="line">fdisk -l</span><br><span class="line"><span class="meta">#</span><span class="bash">四个分区的system都应该是Linux LVM，改为8及机是为了使LVM的侦测指令可以侦测到partition。不改也可以进行LVM创建。</span></span><br><span class="line">* PV</span><br><span class="line">[root@bogon ~]# pvcreate /dev/sdb&#123;1,2,3,5&#125;</span><br><span class="line">  Physical volume "/dev/sdb1" successfully created.</span><br><span class="line">  Physical volume "/dev/sdb2" successfully created.</span><br><span class="line">  Physical volume "/dev/sdb3" successfully created.</span><br><span class="line">  Physical volume "/dev/sdb5" successfully created.</span><br><span class="line">[root@bogon ~]# pvscan </span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  PV /dev/sdb1                      lvm2 [1.00 GiB]</span><br><span class="line">  PV /dev/sdb3                      lvm2 [1.00 GiB]</span><br><span class="line">  PV /dev/sdb2                      lvm2 [1.00 GiB]</span><br><span class="line">  PV /dev/sdb5                      lvm2 [&lt;9.00 GiB]</span><br><span class="line">  Total: 5 [42.99 GiB] / in use: 1 [&lt;31.00 GiB] / in no VG: 4 [&lt;12.00 GiB]</span><br><span class="line"><span class="meta">#</span><span class="bash">这里分别显示每个PV的信息与系统所有PV的信息。最后一行显示的是：整体PV的量/已经被使用的VG的PV量/剩余的PV量</span></span><br><span class="line">[root@bogon ~]# pvdisplay </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sda2</span><br><span class="line"><span class="meta">  #</span><span class="bash">实际的 partition 装置名称</span></span><br><span class="line">  VG Name               centos</span><br><span class="line"><span class="meta">  #</span><span class="bash">分配到哪个VG的名称</span></span><br><span class="line">  PV Size               &lt;31.00 GiB / not usable 3.00 MiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">容量说明</span></span><br><span class="line">  Allocatable           yes</span><br><span class="line"><span class="meta">  #</span><span class="bash">是否已被分配出去，已分配就是yes，否则是NO。</span></span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">在此PV内的PE的大小</span></span><br><span class="line">  Total PE              7935</span><br><span class="line"><span class="meta">  #</span><span class="bash">共有几个PE</span></span><br><span class="line">  Free PE               1</span><br><span class="line"><span class="meta">  #</span><span class="bash">未被LV用掉的PE</span></span><br><span class="line">  Allocated PE          7934</span><br><span class="line"><span class="meta">  #</span><span class="bash">还可分配出去的PE的数量</span></span><br><span class="line">  PV UUID               4jHxbK-P3Py-rV7o-3o1l-fOQc-LhY0-lvFtJv</span><br><span class="line">  </span><br><span class="line">   </span><br><span class="line">  "/dev/sdb1" is a new physical volume of "1.00 GiB"</span><br><span class="line">  --- NEW Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb1</span><br><span class="line">  VG Name               </span><br><span class="line"><span class="meta">  #</span><span class="bash">因为没有分配到VG，所以这里是空白</span></span><br><span class="line">  PV Size               1.00 GiB</span><br><span class="line">  Allocatable           NO</span><br><span class="line">  PE Size               0   </span><br><span class="line">  Total PE              0</span><br><span class="line">  Free PE               0</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               totx56-SkbA-AXtb-gpUS-MGW2-1rdZ-XTrUQn</span><br><span class="line">  ......</span><br><span class="line"><span class="meta">#</span><span class="bash">由于PE是在建立VG时才给予的参数，因此在这里看到的PV里头的PE都是0，而且也没有多余的PE可供分配</span></span><br><span class="line"></span><br><span class="line">* VG</span><br><span class="line">[root@bogon ~]# vgcreate -s 16M ruopuvg /dev/sdb&#123;1,2,3&#125;</span><br><span class="line">  Volume group "ruopuvg" successfully created</span><br><span class="line">[root@bogon ~]# vgscan </span><br><span class="line">  Reading volume groups from cache.</span><br><span class="line">  Found volume group "ruopuvg" using metadata type lvm2</span><br><span class="line">  Found volume group "centos" using metadata type lvm2</span><br><span class="line">[root@bogon ~]# pvscan</span><br><span class="line">  PV /dev/sdb1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb2   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb3   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  PV /dev/sdb5                      lvm2 [&lt;9.00 GiB]</span><br><span class="line">  Total: 5 [&lt;42.95 GiB] / in use: 4 [&lt;33.95 GiB] / in no VG: 1 [&lt;9.00 GiB]</span><br><span class="line"><span class="meta">#</span><span class="bash">显示有三个PV被用了，sdb5没被用。</span></span><br><span class="line">[root@bogon ~]# vgdisplay </span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        3</span><br><span class="line">  Metadata Sequence No  1</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                0</span><br><span class="line">  Open LV               0</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                3</span><br><span class="line">  Act PV                3</span><br><span class="line">  VG Size               2.95 GiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">整体的VG容量大小</span></span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">PE的大小</span></span><br><span class="line">  Total PE              189</span><br><span class="line"><span class="meta">  #</span><span class="bash">PE的整体数量</span></span><br><span class="line">  Alloc PE / Size       0 / 0   </span><br><span class="line">  Free  PE / Size       189 / 2.95 GiB</span><br><span class="line">  VG UUID               DAWGEA-EGjX-tsd0-DHoL-2MOq-R4SV-VaTHcT</span><br><span class="line"><span class="meta">#</span><span class="bash">最后三行指PE能够使用的情况，由于还未创建LV，所以所有的PE均可自由使用。</span></span><br><span class="line">[root@bogon ~]# vgextend ruopuvg /dev/sdb5</span><br><span class="line">  Volume group "ruopuvg" successfully extended</span><br><span class="line"><span class="meta">#</span><span class="bash">将sdb5加入到刚创建的VG中  </span></span><br><span class="line"></span><br><span class="line">* LV</span><br><span class="line">[root@bogon ~]# lvcreate -l 100 -n ruopulv ruopuvg</span><br><span class="line">  Logical volume "ruopulv" created.</span><br><span class="line"><span class="meta">#</span><span class="bash">分配100个PE给这个LV，也可以用lvcreate -L 2G -n ruopulv ruopuvg来创建LV</span></span><br><span class="line">[root@bogon ~]# ll /dev/ruopuvg/ruopulv </span><br><span class="line">lrwxrwxrwx. 1 root root 7 Oct  9 11:39 /dev/ruopuvg/ruopulv -&gt; ../dm-2</span><br><span class="line">[root@bogon ~]# lvdisplay </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopulv</span><br><span class="line">  LV Name                ruopulv</span><br><span class="line"><span class="meta">  #</span><span class="bash">LV的名称</span></span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                7Nxeng-bsdp-i3OA-ckl2-0YiQ-TOKi-Ng03JH</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-09 11:39:05 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 0</span></span><br><span class="line">  LV Size                1.56 GiB</span><br><span class="line"><span class="meta">  #</span><span class="bash">LV的容量</span></span><br><span class="line">  Current LE             100</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:2</span><br><span class="line"></span><br><span class="line">* 格式化与使用</span><br><span class="line">[root@bogon ~]# mkfs.ext4 /dev/ruopuvg/ruopulv </span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Discarding device blocks: done                            </span><br><span class="line">Filesystem label=</span><br><span class="line">OS type: Linux</span><br><span class="line">Block size=4096 (log=2)</span><br><span class="line">Fragment size=4096 (log=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">102544 inodes, 409600 blocks</span><br><span class="line">20480 blocks (5.00%) reserved for the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=419430400</span><br><span class="line">13 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">7888 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376, 294912</span><br><span class="line"></span><br><span class="line">Allocating group tables: done                            </span><br><span class="line">Writing inode tables: done                            </span><br><span class="line">Creating journal (8192 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done </span><br><span class="line"><span class="meta">#</span><span class="bash">格式化LV</span></span><br><span class="line">[root@bogon ~]# mount /dev/ruopuvg/ruopulv /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">挂载</span></span><br></pre></td></tr></table></figure>
<h2 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# fdisk /dev/sdc</span><br><span class="line"><span class="meta">#</span><span class="bash">新加一块硬盘，创建两个新分区，system ID改为8e</span></span><br><span class="line">[root@bogon ~]# partprobe /dev/sdc</span><br><span class="line">pvcreate /dev/sdc1</span><br><span class="line">[root@bogon ~]# pvcreate /dev/sdc1</span><br><span class="line">  Physical volume "/dev/sdc1" successfully created.</span><br><span class="line">[root@bogon ~]# pvscan </span><br><span class="line">  PV /dev/sdb1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb2   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb3   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb5   VG ruopuvg         lvm2 [8.98 GiB / 7.42 GiB free]</span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  PV /dev/sdc1                      lvm2 [1.00 GiB]</span><br><span class="line">  Total: 6 [43.93 GiB] / in use: 5 [42.93 GiB] / in no VG: 1 [1.00 GiB]</span><br><span class="line"></span><br><span class="line">* 加大VG</span><br><span class="line">[root@bogon ~]# vgextend ruopuvg /dev/sdc1</span><br><span class="line">  Volume group "ruopuvg" successfully extended</span><br><span class="line">[root@bogon ~]# vgdisplay </span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        5</span><br><span class="line">  Metadata Sequence No  4</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                1</span><br><span class="line">  Open LV               1</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                5</span><br><span class="line">  Act PV                5</span><br><span class="line">  VG Size               12.92 GiB</span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              827</span><br><span class="line">  Alloc PE / Size       100 / 1.56 GiB</span><br><span class="line">  Free  PE / Size       727 / &lt;11.36 GiB</span><br><span class="line">  VG UUID               DAWGEA-EGjX-tsd0-DHoL-2MOq-R4SV-VaTHcT</span><br><span class="line"><span class="meta">#</span><span class="bash">整体的VG变大了，PE的数量也增加了</span></span><br><span class="line"></span><br><span class="line">* 加大LV</span><br><span class="line">[root@bogon ~]# lvresize -l +100 /dev/ruopuvg/ruopulv </span><br><span class="line">  Size of logical volume ruopuvg/ruopulv changed from 1.56 GiB (100 extents) to 3.12 GiB (200 extents).</span><br><span class="line">  Logical volume ruopuvg/ruopulv successfully resized.</span><br><span class="line"><span class="meta">#</span><span class="bash">给LV再增加100个PE，也可以使用-L选项</span></span><br><span class="line">[root@bogon ~]# lvdisplay </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopulv</span><br><span class="line">  LV Name                ruopulv</span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                7Nxeng-bsdp-i3OA-ckl2-0YiQ-TOKi-Ng03JH</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-09 11:39:05 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 1</span></span><br><span class="line">  LV Size                3.12 GiB</span><br><span class="line">  Current LE             200</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:2</span><br><span class="line">[root@bogon ~]# df -h /mnt</span><br><span class="line">Filesystem                   Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv  1.6G   38M  1.4G   3% /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">虽然增加了LV的容量，但实际中，LV挂载的分区并未变大</span></span><br><span class="line">[root@bogon ~]# dumpe2fs /dev/ruopuvg/ruopulv </span><br><span class="line">dumpe2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">......</span><br><span class="line">Block count:              409600</span><br><span class="line"><span class="meta">#</span><span class="bash">这个文件系统的block总数</span></span><br><span class="line">......</span><br><span class="line">Blocks per group:         32768</span><br><span class="line"><span class="meta">#</span><span class="bash">多少个block设定成为一个block group</span></span><br><span class="line">[root@bogon ~]# resize2fs /dev/ruopuvg/ruopulv </span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem at /dev/ruopuvg/ruopulv is mounted on /mnt; on-line resizing required</span><br><span class="line">old_desc_blocks = 1, new_desc_blocks = 1</span><br><span class="line">The filesystem on /dev/ruopuvg/ruopulv is now 819200 blocks long.</span><br><span class="line"><span class="meta">#</span><span class="bash">这里使用整个lvresize命令扩容进来的空间，也可以用size来指定扩容多少空间</span></span><br><span class="line">[root@bogon ~]# df -h /mnt</span><br><span class="line">Filesystem                   Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv  3.1G   38M  2.9G   2% /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">使用resize2fs命令后，LV才会真正扩容</span></span><br><span class="line">[root@bogon ~]# ll /mnt</span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x. 80 root root  4096 Oct  9 11:45 etc</span><br><span class="line">drwx------.  2 root root 16384 Oct  9 11:44 lost+found</span><br><span class="line"><span class="meta">#</span><span class="bash">之前复制进去的/etc目录还存在。这样就实现了热扩容</span></span><br></pre></td></tr></table></figure>
<h2 id="缩减"><a href="#缩减" class="headerlink" title="缩减"></a>缩减</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# resize2fs /dev/ruopuvg/ruopulv 1500M</span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem at /dev/ruopuvg/ruopulv is mounted on /mnt; on-line resizing required</span><br><span class="line">resize2fs: On-line shrinking not supported</span><br><span class="line"><span class="meta">#</span><span class="bash">resize2fs命令不能使用小数点，如1.5G，所以这里改为1500M，也就是将LV空间缩减为1500M。另外，使用此命令进行缩减时不能在LV已挂载的情况下做。</span></span><br><span class="line">[root@bogon ~]# umount /mnt</span><br><span class="line">[root@bogon ~]# resize2fs /dev/ruopuvg/ruopulv 1500M</span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Please run 'e2fsck -f /dev/ruopuvg/ruopulv' first.</span><br><span class="line"><span class="meta">#</span><span class="bash">系统要求我们先进行磁盘检查</span></span><br><span class="line">[root@bogon ~]# e2fsck -f /dev/ruopuvg/ruopulv </span><br><span class="line">e2fsck 1.42.9 (28-Dec-2013)</span><br><span class="line">Pass 1: Checking inodes, blocks, and sizes</span><br><span class="line">Pass 2: Checking directory structure</span><br><span class="line">Pass 3: Checking directory connectivity</span><br><span class="line">Pass 4: Checking reference counts</span><br><span class="line">Pass 5: Checking group summary information</span><br><span class="line">/dev/ruopuvg/ruopulv: 2467/197200 files (0.2% non-contiguous), 30101/819200 blocks</span><br><span class="line">[root@bogon ~]# resize2fs /dev/ruopuvg/ruopulv 1500M</span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Resizing the filesystem on /dev/ruopuvg/ruopulv to 384000 (4k) blocks.</span><br><span class="line">The filesystem on /dev/ruopuvg/ruopulv is now 384000 blocks long.</span><br><span class="line">[root@bogon ~]# mount /dev/ruopuvg/ruopulv /mnt</span><br><span class="line">[root@bogon ~]# df -h /mnt</span><br><span class="line">Filesystem                   Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/ruopuvg-ruopulv  1.5G   38M  1.3G   3% /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash">这样就缩减成功了</span></span><br><span class="line">[root@bogon ~]# lvdisplay </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopulv</span><br><span class="line">  LV Name                ruopulv</span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                7Nxeng-bsdp-i3OA-ckl2-0YiQ-TOKi-Ng03JH</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-09 11:39:05 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 1</span></span><br><span class="line">  LV Size                3.12 GiB</span><br><span class="line">  Current LE             200</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:2</span><br><span class="line"><span class="meta">#</span><span class="bash">但此时LV并没有缩减</span></span><br><span class="line">[root@bogon ~]# lvresize -L -1.6G /dev/ruopuvg/ruopulv </span><br><span class="line">  Rounding size to boundary between physical extents: 1.59 GiB.</span><br><span class="line">  WARNING: Reducing active and open logical volume to 1.53 GiB.</span><br><span class="line">  THIS MAY DESTROY YOUR DATA (filesystem etc.)</span><br><span class="line">Do you really want to reduce ruopuvg/ruopulv? [y/n]: y</span><br><span class="line">  Size of logical volume ruopuvg/ruopulv changed from 3.12 GiB (200 extents) to 1.53 GiB (98 extents).</span><br><span class="line">  Logical volume ruopuvg/ruopulv successfully resized.</span><br><span class="line"><span class="meta">#</span><span class="bash">这里将LV缩减1.6G</span></span><br><span class="line">[root@bogon ~]# lvdisplay </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ruopuvg/ruopulv</span><br><span class="line">  LV Name                ruopulv</span><br><span class="line">  VG Name                ruopuvg</span><br><span class="line">  LV UUID                7Nxeng-bsdp-i3OA-ckl2-0YiQ-TOKi-Ng03JH</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time bogon, 2018-10-09 11:39:05 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line"><span class="meta">  #</span><span class="bash"> open                 1</span></span><br><span class="line">  LV Size                1.53 GiB</span><br><span class="line">  Current LE             98</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:2</span><br><span class="line"><span class="meta">#</span><span class="bash">这样LV也缩减完成了。</span></span><br><span class="line">[root@bogon ~]# pvdisplay </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb1</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               1.00 GiB / not usable 16.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              63</span><br><span class="line">  Free PE               63</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               totx56-SkbA-AXtb-gpUS-MGW2-1rdZ-XTrUQn</span><br><span class="line">   </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb2</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               1.00 GiB / not usable 16.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              63</span><br><span class="line">  Free PE               63</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               zL5fa0-hfxX-zfnH-VAGf-Eu09-2uoz-ZNFj12</span><br><span class="line">   </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb3</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               1.00 GiB / not usable 16.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              63</span><br><span class="line">  Free PE               63</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               ljRtmq-e75k-xz00-SJkC-W569-1Ge7-9quZB7</span><br><span class="line">   </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdb5</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               &lt;9.00 GiB / not usable 14.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              575</span><br><span class="line">  Free PE               477</span><br><span class="line">  Allocated PE          98</span><br><span class="line">  PV UUID               CJgQ6x-4oRB-WD3i-bKaf-jRdB-Sz93-Xeoqpm</span><br><span class="line">   </span><br><span class="line">  --- Physical volume ---</span><br><span class="line">  PV Name               /dev/sdc1</span><br><span class="line">  VG Name               ruopuvg</span><br><span class="line">  PV Size               1.00 GiB / not usable 16.00 MiB</span><br><span class="line">  Allocatable           yes </span><br><span class="line">  PE Size               16.00 MiB</span><br><span class="line">  Total PE              63</span><br><span class="line">  Free PE               63</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               lIAqor-XGnw-PTYo-L6yY-ld6y-AeNz-41imsu</span><br><span class="line"><span class="meta">  #</span><span class="bash">可以看到，sdb1,sdb2,sdb3,sdc1的PE都是空闲的了</span></span><br><span class="line">  [root@bogon ~]# pvmove /dev/sdb5 /dev/sdb1</span><br><span class="line">  Insufficient free space: 98 extents needed, but only 63 available</span><br><span class="line">  Unable to allocate mirror extents for ruopuvg/pvmove0.</span><br><span class="line">  Failed to convert pvmove LV to mirrored</span><br><span class="line"><span class="meta">  #</span><span class="bash">如果要转移PE，可以使用此命令，但这里因为一共有98个PE要转移，而sdb1上只有63个PE而无法完成转移</span></span><br><span class="line">  [root@bogon ~]# pvscan </span><br><span class="line">  PV /dev/sdb1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb2   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb3   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb5   VG ruopuvg         lvm2 [8.98 GiB / 7.45 GiB free]</span><br><span class="line">  PV /dev/sdc1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  Total: 6 [&lt;43.92 GiB] / in use: 6 [&lt;43.92 GiB] / in no VG: 0 [0   ]</span><br><span class="line">[root@bogon ~]# vgreduce ruopuvg /dev/sdb1</span><br><span class="line">  Removed "/dev/sdb1" from volume group "ruopuvg"</span><br><span class="line"><span class="meta">#</span><span class="bash">将分区从VG中移除</span></span><br><span class="line">[root@bogon ~]# pvscan </span><br><span class="line">  PV /dev/sdb2   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb3   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sdb5   VG ruopuvg         lvm2 [8.98 GiB / 7.45 GiB free]</span><br><span class="line">  PV /dev/sdc1   VG ruopuvg         lvm2 [1008.00 MiB / 1008.00 MiB free]</span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;31.00 GiB / 4.00 MiB free]</span><br><span class="line">  PV /dev/sdb1                      lvm2 [1.00 GiB]</span><br><span class="line">  Total: 6 [43.93 GiB] / in use: 5 [42.93 GiB] / in no VG: 1 [1.00 GiB]</span><br><span class="line"><span class="meta">#</span><span class="bash">可以看到sdb1已经没有了</span></span><br><span class="line">[root@bogon ~]# pvremove /dev/sdb1</span><br><span class="line">  Labels on physical volume "/dev/sdb1" successfully wiped.</span><br><span class="line"><span class="meta">#</span><span class="bash">最后将sdb1从PV中移除。这样系统以及实际的LV与VG都变小了，sdb1可以进行其他工作了</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/30/jdyc测试环境搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/30/jdyc测试环境搭建/" itemprop="url">
                  jdyc测试环境搭建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-30 10:56:33 / 修改時間：11:59:11" itemprop="dateCreated datePublished" datetime="2018-09-30T10:56:33+08:00">2018-09-30</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/test/" itemprop="url" rel="index"><span itemprop="name">test</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h1><p>IP：10.5.5.242</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ansible</span><br><span class="line">vim /etc/ansible/hosts</span><br><span class="line">	[ansible]</span><br><span class="line">    10.5.5.242</span><br><span class="line"></span><br><span class="line">    [web]</span><br><span class="line">    10.5.5.223</span><br><span class="line"></span><br><span class="line">    [netty]</span><br><span class="line">    10.5.5.221</span><br><span class="line">    10.5.5.222</span><br><span class="line"></span><br><span class="line">    [wechat]</span><br><span class="line">    10.5.5.224</span><br><span class="line">    10.5.5.227</span><br><span class="line"></span><br><span class="line">    [processor]</span><br><span class="line">    10.5.5.228</span><br><span class="line">    10.5.5.229</span><br><span class="line"></span><br><span class="line">    [mysql]</span><br><span class="line">    10.5.5.238</span><br><span class="line">    10.5.5.239</span><br><span class="line"></span><br><span class="line">    [kafka]</span><br><span class="line">    10.5.5.232</span><br><span class="line">    10.5.5.233</span><br><span class="line">    10.5.5.234</span><br><span class="line"></span><br><span class="line">    [redis]</span><br><span class="line">    10.5.5.235</span><br><span class="line">    10.5.5.236</span><br><span class="line">    10.5.5.237</span><br><span class="line"></span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 10.5.5.237</span><br><span class="line"><span class="meta">#</span><span class="bash">将密钥复制到ansible中加入的所有主机，实现无密钥登录</span></span><br><span class="line">ansible web,wechat,processor -m shell -a "yum install -y java-1.8.0-openjdk-devel"</span><br><span class="line">ansible web,wechat,processor -m shell -a "rpm -q java-1.8.0-openjdk-devel"</span><br><span class="line">ansible redis -m shell -a "yum install -y epel-release"</span><br><span class="line">ansible redis -m shell -a "yum install -y redis"</span><br><span class="line">ansible web,wechat,processor -m shell -a "yum install -y epel-release"</span><br><span class="line">ansible web,wechat,processor -m shell -a "yum install -y nginx"</span><br><span class="line"></span><br><span class="line">* web</span><br><span class="line">mkdir -pv /root/nginx/&#123;web,wechat&#125;</span><br><span class="line">vim /root/nginx/web/web.conf</span><br><span class="line">	proxy_cache_path /etc/nginx/cache levels=1:2:2 keys_zone=web_cache:10m max_size=2g;</span><br><span class="line">    server&#123;</span><br><span class="line">       server_name web.jdyichong.com;</span><br><span class="line">       index index.html index.htm;</span><br><span class="line">       charset utf-8;</span><br><span class="line">       proxy_cache web_cache;</span><br><span class="line">       proxy_cache_key $request_uri;</span><br><span class="line">       proxy_cache_methods GET HEAD;</span><br><span class="line">       proxy_cache_min_uses 1;</span><br><span class="line">       proxy_cache_valid 200 302 10m;</span><br><span class="line">       proxy_cache_valid 400 1m;</span><br><span class="line">       proxy_cache_use_stale http_502;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">            proxy_pass http://10.5.5.223:8081;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">ansible web -m copy -a "src=/root/nginx/web/web.conf dest=/etc/nginx/conf.d"</span><br><span class="line">ansible web -m command -a "systemctl start nginx"</span><br><span class="line">ansible web -m command -a "systemctl enable nginx"</span><br><span class="line"><span class="meta">#</span><span class="bash">设置web服务器上的nginx启动并加入开机启动。测试时这里有报错，不能启动nginx，原因是使用了OpenVZ的模板，此模板中安装了httpd服务，并且开机启动，需要关闭。</span></span><br></pre></td></tr></table></figure>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><p>IP：10.5.5.223</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/iptables使用方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/iptables使用方法/" itemprop="url">
                  iptables使用方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-27 10:49:11" itemprop="dateCreated datePublished" datetime="2018-09-27T10:49:11+08:00">2018-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-29 16:24:36" itemprop="dateModified" datetime="2018-09-29T16:24:36+08:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="防火墙概念"><a href="#防火墙概念" class="headerlink" title="防火墙概念"></a>防火墙概念</h1><blockquote>
<p>&emsp;&emsp;iptables是工作在linux内核中的网络防火墙，iptables和netfilter是一组工具，真正起到防火墙作用的是netfilter，netfilter是内核中的一個過濾框架，iptables是一個生成防火牆規則，並能將其符加在netfilter上，真正實現數據報文過濾、NAT、mangle等規則生成的工具。</p>
<p>&emsp;&emsp;防火牆工作在主機或網絡的邊緣，對進出的數據報文進行檢查監控，按事先定義的規則進行相應處理。防火牆可以是硬件或軟件，規則實施防火，規則包括匹配標準和處理辦法。</p>
<p>&emsp;Framework:</p>
<p>&emsp;默認規則：</p>
<p>&emsp;如果防火牆默認是全部開放的，那就用堵的辦法</p>
<p>&emsp;如果防火牆默認是全部關閉的，那就用通的辦法</p>
<p>&emsp;&emsp;防火牆規則必須放在內核上，因爲我們是不能和內核打交道的，有人在內核的TCP/IP協議棧上開放了幾個位置，開放給用戶空間的應用程序</p>
<p>&emsp;&emsp;netfile就是內核中可以放規則的位置；iptables是工作在用戶空間可以寫規則並可通過系統調用放置在內核相應位置的應用程序；報文流向有三種：進來的，出去的和轉發的，在/proc/sys/net/ipv4/ip_forward中就是定義是否轉發的；根據IP地址完成路由表中的路由決策，無論從哪進來的只要到了TCPIP協議棧後的下一個就是路由決策</p>
</blockquote>
<h1 id="iptables概念"><a href="#iptables概念" class="headerlink" title="iptables概念"></a>iptables概念</h1><blockquote>
<ul>
<li><p>hook function：鈎子函數，有五個位置。分別是input（進）, output（出）, forward（轉發）, prerouting（路由做出前）, postrouting（路由之後再發出）</p>
</li>
<li><p>鈎子函數的規則鏈：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；</p>
</li>
<li><p>filter（過濾）：表：INPUT，OUTPUT，FORWARD；</p>
</li>
<li><p>nat（地址轉換）：表：PREROUTING，POSTROUTING，OUTPUT；</p>
</li>
<li><p>mangle（拆開、修改、封裝報文首部）：表：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；</p>
</li>
<li><p>過濾與mangle是不能放在一起的；</p>
</li>
<li><p>raw()：表：PREROUTING，OUTPUT</p>
</li>
<li>IINPUT、OUTPUT是從內核空間到用戶空間實現過濾的，是主機防火牆設置，通過本機轉發的通過FORWARD鏈，是網絡防火牆的設置。路由的轉發功能可以是一臺主機上的兩個網段的地址.一臺交換機上可以配置多個網段的地址，但它們之間不能通信，但如果不同網段的主機的網關指向了一臺網關服務器上一塊網卡的兩個不同網段的地址，且服務器上開通了路由的功能，那麼就可以通信了；因爲IP地址不是屬於網卡的，而是屬於主機的，所以一塊網卡可以邊接兩個網絡</li>
<li>啓用了ip_forward鏈，默認所有報文都要轉發</li>
<li><p>應該隔離可以被公網訪問的主機與不能被公網訪問的主機，如在網關服務器上放三塊網卡，其中一塊是面對互聯網的，另一塊是面對內網的，最後一塊面對服務器，開放互聯網訪問時只能從面對互聯網的網卡到面對服務器的網卡；所有在面對內網網卡上的報文要想進來必須得是一個響應，其他不允許，網關服務器被叫做三宿主的主機</p>
</li>
<li><p>netfilter:是一個框架，在TCP/IP協議橈上有5個鈎子函數分別對應5個規則鏈，工作在內核中。不能手動向netfilter中添加數據，要用iptables編寫規則送達netfilter的某個鏈上，但它必須先屬於某張表。默認表是filter，還有nat、mangle表</p>
</li>
<li><p>目標地址轉換在進入時改，源地址轉換在出去的時候改。</p>
</li>
<li><p>可以使用自定義鏈，但只在被默認鏈調用時才能發揮作用，而且如果沒有自定義鏈中的任何規則匹配，還應該有返回機制。用戶可以刪除自定義的空鏈，默認鏈不能刪除。</p>
</li>
<li><p>每個規則都有兩個內置的計數器，一個記錄被匹配的報文個數，一個記錄被匹配的報文大小之和</p>
</li>
<li><p>NAT：Network Address Translation</p>
</li>
<li>DNAT：目標地址轉換，轉換IP報文中的目標IP地址。目標地址轉換DNAT，指在返回結果時將地址轉換爲請求的地址。如一臺服務器上沒有服務，但将其設置成轉換到后端兩臺服務器的地址，一臺80一臺21,用户訪問時訪問的是這臺沒有服務的主機，但返回結果是有服務的兩臺主機的內容，在返回結果時就要將地址轉換成沒有服務的主機的IP。也就是当用户访问一个地址时，这个地址本没有服务，但可将此请求转到相应的地址服务上，并在服务返回结果时自动将源地址转为用户请求的地址，这就是目标地址转换。源地址转换与目标地址转换效果相反。我们只操作一半，另一半转换由服务器自动完成</li>
<li>SNAT：源地址轉換，轉換IP報文中的源IP地址（可在POSTROUTING或OUTPUT上做，對網關來講只在POSTROUTING上作）。雖然稱爲源地址轉換，但目標IP地址也會轉換，只不過回程的目標地址會轉換</li>
<li>在互聯網上發送報文的時候，無論經過任何路由設備源IP與目標IP是不會改變的</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向了這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>涉及到轉發與本機無關時一定是在FORWARD鏈上做</li>
<li>iptables在二三四層上進行過濾</li>
<li></li>
</ul>
</blockquote>
<h2 id="四表五链"><a href="#四表五链" class="headerlink" title="四表五链"></a>四表五链</h2><ul>
<li><p>filter表——过滤数据包</p>
</li>
<li><p>Nat表——用于网络地址转换（IP、端口）</p>
</li>
<li><p>Mangle表——修改数据包的服务类型、TTL、并且可以配置路由实现QOS</p>
</li>
<li><p>Raw表——决定数据包是否被状态跟踪机制处理</p>
</li>
</ul>
<ul>
<li>INPUT链——进来的数据包应用此规则链中的策略</li>
<li>OUTPUT链——外出的数据包应用此规则链中的策略</li>
<li>FORWARD链——转发数据包时应用此规则链中的策略</li>
<li>PREROUTING链——对数据包作路由选择前应用此链中的规则（所有的数据包进来的时侯都先由这个链处理）</li>
<li>POSTROUTING链——对数据包作路由选择后应用此链中的规则（所有的数据包出来的时侯都先由这个链处理）</li>
</ul>
<p><img src="/images/iptables/四表五链详细.jpg" alt=""></p>
<p><img src="/images/iptables/四表五链.png" alt=""></p>
<p><img src="/images/iptables/四表五链鸟哥.jpg" alt=""></p>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><p>NEW：新連接請求。主机连接目标主机，在目标主机上看到的第一个想要连接的包<br>ESTABLISHED：已建立的連接。主机已与目标主机进行通信，判断标准只要目标主机回应了第一个包，就进入该状态。<br>INVALID：非法連接請求。无效的封包，例如数据破损的封包状态<br>RELATED：相關聯的。主机已与目标主机进行通信，目标主机发起新的链接方式，例如ftp</p>
<h1 id="规则及语法"><a href="#规则及语法" class="headerlink" title="规则及语法"></a>规则及语法</h1><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t TABLE] COMMAND CHAIN [num] 匹配條件 -j 處理動作</span><br></pre></td></tr></table></figure>
<h2 id="規則：匹配標準"><a href="#規則：匹配標準" class="headerlink" title="規則：匹配標準"></a>規則：匹配標準</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">通用匹配：自身能夠檢查</span><br><span class="line">    -s, --src</span><br><span class="line">    #指定源地址</span><br><span class="line">    -d, --dst</span><br><span class="line">    #指定目標地址       </span><br><span class="line">    -p &#123;tcp|udp|icmp&#125;</span><br><span class="line">    #指定協議</span><br><span class="line">    -i eth* </span><br><span class="line">    #指定數據報文流入的接口，可用於自定義鏈，和以下鏈PREROUTING，INPUT，FORWARD</span><br><span class="line">    -o INTERFACE</span><br><span class="line">    #指定數據報文流出的接口，可用於標準定義的鏈和以下鏈OUTPUT,POSTROUTING,FORWARD</span><br><span class="line"></span><br><span class="line">擴展匹配：依賴模塊才能檢查，在/lib/iptables下的.so擴展模塊</span><br><span class="line">	隱含擴展：不用特別指明由哪個模塊進行的擴展，因爲此時使用-p &#123;tcp|udp|icmp&#125;</span><br><span class="line">	-p tcp</span><br><span class="line">		--sport PORT [-PORT]</span><br><span class="line"><span class="meta">		#</span><span class="bash">源端口；可使用連續端口</span></span><br><span class="line">		--dport PORT [-PORT]</span><br><span class="line"><span class="meta">		#</span><span class="bash">目標端口</span></span><br><span class="line">		--tcp-flags mask comp</span><br><span class="line"><span class="meta">		#</span><span class="bash">只檢查mask指定的標志位，是逗號分隔的標志位列表；comp：此列表中出現的標記位必須爲1；comp中沒出現，而mask中出現的，必須爲0；如：</span></span><br><span class="line">		--tcp-flags SYN，FIN，ACK，RST SYN，ACK 等同 --syn選項</span><br><span class="line"><span class="meta">		#</span><span class="bash">檢查tcp報文的 SYN，FIN，ACK，RST標志位，這些標志位中只能是SYN，ACK爲1，其他爲0</span></span><br><span class="line">		--syn：三次握手的第一次</span><br><span class="line">	-p icmp</span><br><span class="line">		--icmp-type</span><br><span class="line"><span class="meta">		#</span><span class="bash">icmp協議報文的類型，主要有0和8兩種,我們ping別人的時候出去的是8進來的是0,別人ping我們的時候進來的是8出去的是0</span></span><br><span class="line">		0：echo-reply	</span><br><span class="line"><span class="meta">		#</span><span class="bash">響應報文</span></span><br><span class="line">		8：echo-request    </span><br><span class="line"><span class="meta">		#</span><span class="bash">請求報文</span></span><br><span class="line">	-p udp</span><br><span class="line">		--sport</span><br><span class="line">		--dport</span><br><span class="line"></span><br><span class="line">	顯式擴展：必須指明由哪個模塊進行的擴展，在iptables中使用-m選項可完成此功能</span><br><span class="line">	-m EXTESTION_NAME -specific-opt(-m 擴展名 擴展選項)</span><br><span class="line">		* state：#狀態擴展</span><br><span class="line">			--state</span><br><span class="line">			結合ip_conntrack追蹤會話的狀態，有四種，跟據IP、連接追蹤</span><br><span class="line">			NEW：#新連接請求</span><br><span class="line">			ESTABLISHED：#已建立的連接</span><br><span class="line">			INVALID：#非法連接請求</span><br><span class="line">			RELATED：#相關聯的</span><br><span class="line">		例：</span><br><span class="line">		-m state --state NEW -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">只檢查NEW狀態，狀態爲NEW的可以通過</span></span><br><span class="line">		-m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">狀態爲NEW和ESTABLISHED的全部放行，與地址，協誶無關</span></span><br><span class="line"></span><br><span class="line">		* multiport：#多端口匹配擴展，可實現離散的多端口匹配</span><br><span class="line">			--source-ports：#源端口</span><br><span class="line">			--destination-ports：#目標端口</span><br><span class="line">			--ports：#不論是上面兩種哪一種端口；另外多個端口可用逗號隔開，但最多只能有15個</span><br><span class="line">		例：</span><br><span class="line">		-m multiport --destination-ports 21,22,80 -j ACCEPT</span><br><span class="line">			</span><br><span class="line">		* iprange：#指定IP範圍</span><br><span class="line">			--src-range</span><br><span class="line">			--dst-range</span><br><span class="line">		例：</span><br><span class="line">		iptables -A INPUT -p tcp -m iprange --src-range 172.16.100.3-172.16.100.100 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT			</span><br><span class="line"><span class="meta">		#</span><span class="bash">源IP是100.3到100的，可以訪問目標端口22,狀態要是NEW或ESTABLISHED</span></span><br><span class="line"></span><br><span class="line">		* connlimit：#連接數限定，也就是線程數，如只能使用5個連接請求</span><br><span class="line">			! --connlimit-above n：#connlimit的上限，但這裏是達到n個</span><br><span class="line">		例：本機的web服務器最多允許同時發起兩個請求進來</span><br><span class="line">        iptables -A INPUT -d 172.16.100.7 -p tcp --dport 80 -m connlimit ! --connlimit-above 2 -j ACCEPT</span><br><span class="line">        #這是沒達到2個就允許，所以一般要在--connlimit-above前加！號。如果不加！号，可改ACCEPT的狀態爲DROP或REJECT了</span><br><span class="line"></span><br><span class="line">		* limit</span><br><span class="line">        	--limit RATE：給的是一個速率，如每秒多少人</span><br><span class="line">            --limit-burst：給的是一個上限，第一批可放行多少個</span><br><span class="line">		例：</span><br><span class="line">		iptables -I INPUT -d 172.16.100.7 -p tcp --dport 22 -m limit --limit 3/minute --limit-burst 3 -j ACCEPT	</span><br><span class="line"><span class="meta">		#</span><span class="bash">每分鍾放行3個，最多一次擁入3個</span></span><br><span class="line">		iptables -R INPUT 3 -d 172.6.100.7 -p icmp --icmp-type 8 -m limit --limit 5/minute --limit-burst 6 -j ACCEPT		</span><br><span class="line"><span class="meta">		#</span><span class="bash">修改第三條規則爲限定每分種5個ping請求，但前6個是很快的</span></span><br><span class="line">		測試，連續打開多個ssh連接服務器</span><br><span class="line"></span><br><span class="line">		* string </span><br><span class="line">        	--algo &#123;bm|kmp&#125;：#指定算法</span><br><span class="line">            --string "STRING"：#指定字符串，支持正則</span><br><span class="line">        例：</span><br><span class="line">        vim /var/www/html/test.html</span><br><span class="line">        	h7n9 </span><br><span class="line">            hello world</span><br><span class="line">		iptables -I INPUT -d 172.16.100.7 -m string --algo kmp --string "h7n9" -j REJECT</span><br><span class="line"><span class="meta">		#</span><span class="bash">上面這條是匹配不到的，因爲當用戶的請求中沒有h7n9，請求頁面時，我們響應的報文是從OUTPUT響應出去的，所以應將規則寫在OUTPUT上</span></span><br><span class="line">		iptables -R OUTPUT 1 -s 172.16.100.7 -m string --algo kmp --string "h7n9" -j REJECT</span><br><span class="line"><span class="meta">		#</span><span class="bash">不能訪問有h7n9的頁面 ,-R選項是修改之意。</span></span><br><span class="line"><span class="meta">		#</span><span class="bash">iptables -L -n -v顯示信息中的pkts是匹配到的規則</span></span><br></pre></td></tr></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">管理規則</span><br><span class="line">    -A：#附加一條規則，在鏈的尾部追加</span><br><span class="line">    -I CHAIN [num]：#插入一條規則，可以指定添加在什麼位置，插入爲對應CHAIN上的第num條，如果省略num則插入爲第一條</span><br><span class="line">    -D CHAIN [num]：#刪除指定鏈中的第num條規則；</span><br><span class="line">    -R CHAIN [num]：#替換指定的規則</span><br><span class="line"></span><br><span class="line">管理鏈</span><br><span class="line">    -F [CHAIN]：#flush：清空指定規則鏈，如果省略CHAIN，則可以實現刪除對應表中的所有鏈</span><br><span class="line">    -p CHAIN：#設定指定鏈的默認策略</span><br><span class="line">    -N：#自定義一個新的空鏈</span><br><span class="line">    -X：#刪除一個自定議的空鏈</span><br><span class="line">    -Z：#置零指定鏈中所有規則的計數器</span><br><span class="line">    -E：#重命名自定義的鏈</span><br><span class="line"></span><br><span class="line">查看類</span><br><span class="line">    -L：#顯示指定表中的規則</span><br><span class="line">    -n：#以數字格式顯示主機地址和端口號，與-L一起使用</span><br><span class="line">    -v：#顯示鏈及規則的詳細信息</span><br><span class="line">    -vv：#顯示更詳細的信息</span><br><span class="line">    -x：#顯示計數器的精確值</span><br><span class="line">    --line-numbers：#顯示規則號碼</span><br></pre></td></tr></table></figure>
<h2 id="動作（target）"><a href="#動作（target）" class="headerlink" title="動作（target）"></a>動作（target）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-j TARGET:跳轉</span><br><span class="line">    ACCEPT：#放行</span><br><span class="line">    DROP：#丟棄</span><br><span class="line">    REJECT：#拒絕</span><br><span class="line">    DNAT：#目標地址轉換</span><br><span class="line">    SNAT：#源地址轉換</span><br><span class="line">    REDIRECT：#端口重定向</span><br><span class="line">    MASQUERADE：#地址僞裝</span><br><span class="line">    LOG：#記錄日志</span><br><span class="line">    MARK：#給報文加上標記</span><br><span class="line">注：只要有允許或拒絕，是做過濾的，一定在filter表上</span><br><span class="line"></span><br><span class="line">-j SNAT：#源地址轉換</span><br><span class="line">	--to-source：#轉換成哪個源地址</span><br><span class="line">	</span><br><span class="line">-j MASQUERADE		</span><br><span class="line"><span class="meta">#</span><span class="bash">外網地址是動態獲取時用此選項，它不需要—to-source選項，可以自動查到上外網的地址。</span></span><br><span class="line"></span><br><span class="line">-j DNAT</span><br><span class="line">	--to-destination IP[:port]</span><br></pre></td></tr></table></figure>
<h2 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables規則保存位置，/etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables.tus		</span><br><span class="line"><span class="meta">#</span><span class="bash">保存方法</span></span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables.tus		</span><br><span class="line"><span class="meta">#</span><span class="bash">此爲載入方法</span></span><br></pre></td></tr></table></figure>
<h1 id="例"><a href="#例" class="headerlink" title="例"></a>例</h1><h2 id="查看规则"><a href="#查看规则" class="headerlink" title="查看规则"></a>查看规则</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">例：</span><br><span class="line">	iptables -L -n			</span><br><span class="line"><span class="meta">	#</span><span class="bash">默認顯示filter表</span></span><br><span class="line">	iptables -t filter -L -n</span><br><span class="line">	iptables -t nat -L -n</span><br><span class="line">	iptables -t mangle -L -n</span><br><span class="line"><span class="meta">	#</span><span class="bash">顯示內容中的Chain INPUT一項中沒有寫哪個表，默認就是filter表中的規則，policy表示默認策略，ACCEPT表示其爲默認值時只拒絕已知的壞蛋，如果是DROP就是只接受已知的好人。pkts表示被某一條規則所匹配到的數據包的個數，bytes表示字節數</span></span><br></pre></td></tr></table></figure>
<h2 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -t filter -A OUTPUT -s 172.16.100.7 -d 172.16.0.0/16 -p tcp --sport 22 -j ACCEPT</span><br><span class="line">yum install -y httpd vsftpd mysql-server </span><br><span class="line">service httpd start		</span><br><span class="line"><span class="meta">#</span><span class="bash">啓動服務</span></span><br><span class="line">browser測試是否可以打開ip地址</span><br><span class="line"><span class="meta">#</span><span class="bash">修改默認設置爲都不能訪問本機，之前寫的兩條可以訪問本機22端口ssh服務的規則是爲了不讓遠程連接斷開，如果先寫下面的默認規則會使遠程連接斷開，造成麻煩</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -L -n</span><br><span class="line"><span class="meta">#</span><span class="bash">允計所有外部主機訪問本機的80端口，如果web服務比ssh服務訪問量大要放在其上面，所以這裏用-I選項，默認插入在第一行。當地址爲0.0.0.0的時候可以不寫，所以這裏沒有寫-s選項</span></span><br><span class="line">iptables -I INPUT -d 172.16.100.7 -p tcp --dport 80 -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">進規則</span></span><br><span class="line">iptables -L -n		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看規則</span></span><br><span class="line">iptables -L OUTPUT -s 172.16.100.7 -p tcp --sport 80 -j ACCEPT     </span><br><span class="line"><span class="meta">#</span><span class="bash">出規則</span></span><br><span class="line">echo hello &gt; /var/www/html/index.html		</span><br><span class="line"><span class="meta">#</span><span class="bash">添加默認網頁並測試</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因ping請求使用的是icmp協議，所以這時是不能ping通的。因爲ping命令要先從OUTPUT鏈出去再從INPUT鏈進來，所以用本機ping 127.0.0.1也是不通的</span></span><br><span class="line">iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -i lo -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">-i選項是指定從哪個接口流入的請求</span></span><br><span class="line">iptables -A OUTPUT -s 127.0.0.1 -d 127.0.0.1 -o lo -j ACCEPT  </span><br><span class="line"><span class="meta">#</span><span class="bash">-o選項指定從哪個接口流出</span></span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p icmp --icmp-type 8 -j ACCEPT</span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p icmp --icmp-type 0 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">ping別人的時候，出去的是8,進來的是0，別人ping我們的時候，進來的是8,出去的是0；這樣就可以實現我們ping外面的主機了，但別人是ping不了我們的</span></span><br></pre></td></tr></table></figure>
<h2 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">來自172.16.0.0/16網段的報文無論訪問本機哪個地址都被丟棄。-A表示添加一條規則</span></span><br><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7  -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">來自172.16.0.0/16網段訪問100.7的經過INPUT鏈的都被丟棄</span></span><br><span class="line"></span><br><span class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.7 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -t filter -A OUTPUT -s 172.16.100.7 -d 172.16.0.0/16 -p tcp --sport 22 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##這兩條命令第一條是進第二條是出，在寫規則時一定要把進出都寫上，意思是放行172.16.0.0/16網段的地址訪問172.16.100.7的22號端口ssh服務</span></span></span><br><span class="line"></span><br><span class="line">iptables -L -n -v</span><br><span class="line"><span class="meta">#</span><span class="bash">lsmod命令可以查看啓動的模塊，這裏查看iptables模塊是否啓動，四個表：iptable_mangle、iptable_nat、iptable_raw、iptable_filter</span></span><br><span class="line">modprobe -r 模塊名			</span><br><span class="line"><span class="meta">#</span><span class="bash">注銷或裝載一個模塊</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables不是服務，但有服務腳本；服務腳本的主要作用在於管理保存規則，它保存在內核的內存空間上。可以使用lsmod查看iptables的相關模塊是否加載，啓動與停止服務就是裝載及移除iptables/netfilter相關的內核模塊。模塊一般有：iptables_nat, iptables_filter, iptables_mangle, iptables_raw, ip_nat, ip_conntrack； ip_conntrack是當我們啓用nat功能時，每一個地址轉換的相應的返回的報文是要自動管理的，要追蹤每一個地址轉換的報文的，這就是ip_conntrack的功能。</span></span><br></pre></td></tr></table></figure>
<h2 id="测试3"><a href="#测试3" class="headerlink" title="测试3"></a>测试3</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">我們是一個DNS服務器，用戶請求不是我們負責的域，我們就到互聯網找出結果；默認策略INPUT,OUTPUT,FORWARD都是DORP的話，該怎麼寫規則</span><br><span class="line"><span class="meta">#</span><span class="bash">我們是DNS服務器，應該監聽在UDP的53號端口上，當一個客戶端到我們這來請求解析的時候，我們要允許這個請求進來，源地址是客戶端，目標地址是我們的主機，目標端口是53，這應該放行；出去時原端口是53，目標地址是客戶機；但別人請求的是一個不是我們的主機負責的域時，服務器要去找根，它找根時就不是服務器端了，而是客戶端，這就要放行目標端口；當我們作爲客戶端時與這個服務器就沒關系了。這要寫四條規則，而且這只是UDP，它還要監聽在TCP上，所以一共要写八條规则。</span></span><br><span class="line"></span><br><span class="line">作爲web服務器，只開放80端口的響應與放行就可以避免決大多數的攻擊了，80端口應該是只有別人請求進來，它才響應出去。只有這樣反彈式木馬在沒有人請求時才不能響應出去。這種功能在iptables中叫連接追蹤的功能，叫ip_conntrack，這是一個內核模塊，它能時時記錄着主機上客戶端，服務器端彼此正在建立的連接關系，並能追蹤到哪一個連接與其他連接之間處於什麼狀態並有什麼關系，所以上面的情況就可以判定只允許本地主機出去的連接必須爲某一種狀態，必須處於已經建立的連接，也就是必須是對別人的響應我們才允許出去，如果不是響應是決不放行的，這就靠ip_conntrack實現，ip_conntrack可根據IP報文來追蹤TCP和UDP與ICMP的連接。它可以根據請求方與響應方處理什麼過程。在/proc/sys/net/ipv4/ip_conntrack內核文件，它是位於內存當中的，因爲它在proc系統上，這個文件保存有當前系統上每一個客戶端和當前主機與每一個其他主機所建立的連接關系 </span><br><span class="line">cat /proc/sys/net/ipv4/ip_conntrack</span><br><span class="line"><span class="meta">#</span><span class="bash">顯示內容中每條記錄兩個來回的兩個通道的信息，並保存了當前會話所處的狀態。ip_conntrack的這種功能是靠ip_conntrack模塊實現的</span></span><br><span class="line"><span class="meta">#</span><span class="bash">用iptstate命令也可查看到這些信息</span></span><br><span class="line">iptstate -t		</span><br><span class="line"><span class="meta">#</span><span class="bash">顯示當前所有連接的個數</span></span><br><span class="line"><span class="meta">#</span><span class="bash">/proc/sys/net/ipv4/ip_conntrack_max是設置ip_conntrack的同時追蹤的最大值，默認是32768個，超出的連接會被超時丟棄，使用戶無法連接，如果訪問量過大最好不要啓動此模塊，如果不大最好調大此項的值，這個模塊是追蹤已連接的地址的。在iptables停止的狀態下，如果執行iptables -t nat -L命令就要激活ip_conntrack和nfnetlink模塊。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables重啓會清空規則，重新加載/etc/sysconfig/iptables目錄中的文件，使用命令service iptables save可以保存規則。</span></span><br><span class="line"></span><br><span class="line">保存規則：</span><br><span class="line">service iptables save		</span><br><span class="line"><span class="meta">#</span><span class="bash">保存規則</span></span><br><span class="line"><span class="meta">#</span><span class="bash">默認保存在/etc/sysconfig/iptables</span></span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables.***		</span><br><span class="line"><span class="meta">#</span><span class="bash">手動指定保存位置</span></span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables.***		</span><br><span class="line"><span class="meta">#</span><span class="bash">因爲手動指定保存位置所以無法加載，要用此條命令指定加載位置</span></span><br></pre></td></tr></table></figure>
<h2 id="開通服務器的sshd-httpd訪問端口"><a href="#開通服務器的sshd-httpd訪問端口" class="headerlink" title="開通服務器的sshd, httpd訪問端口"></a>開通服務器的sshd, httpd訪問端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">一臺服務器，地址172.16.100.7</span><br><span class="line">iptables -F		</span><br><span class="line"><span class="meta">#</span><span class="bash">清空規則</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">放行所有狀態是NEW,ESTABLISHED的訪問22號端口的連接，因爲是進來所以有NEW狀態</span></span><br><span class="line">lsmod | grep ip</span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p tcp --sport 22 -m state –state ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">這是出去所有只有ESTABLISHED已連接狀態</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">改變默認策略爲不允許連接</span></span><br><span class="line">iptables -L -n		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看現在的規則</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">再改80端口爲相同的規則</span></span><br><span class="line">iptstate		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看連接狀態</span></span><br><span class="line">sysctl -w net.ipv4.ip_conntrack_max=65536		</span><br><span class="line"><span class="meta">#</span><span class="bash">改最大值，臨時生效，要永久生效要寫在/etc/sysctl.conf中</span></span><br><span class="line">cat /proc/sys/net/ipv4/ip_conntrack_max		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">在/proc/sys/net/ipv4/netfilter目錄中保存了ip_conntrack的很多設置的值，其中的ip_conntrack_tcp_timeout_established中有tcp連接的保持時間，是120小時，這裏的默認單位的秒，建議將此值改小。ip_conntrack是可以追蹤三種協議tcp，udp，icmp，只是對udp，icmp只追蹤超時。</span></span><br><span class="line"></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p icmp --icmp-type 8 -m state --state NEW,ESTABLISHED -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">進規則</span></span><br><span class="line">iptables -A OUTPUT -s 172.16.100.7 -p icmp --icmp-type 0 -m state --state ESTABLISHED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">出規則</span></span><br><span class="line"><span class="meta">#</span><span class="bash">寫規則時按邏輯寫，像上面兩條是允許外面的主機ping我們的主機，所以要先寫進來的規則再寫出去</span></span><br><span class="line">iptables -L -n --line-numbers		</span><br><span class="line"><span class="meta">#</span><span class="bash">查看規則，--line-numbers是顯示行號</span></span><br><span class="line">iptables -I OUTPUT -s 172.16.100.7 -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">用這一條規則可以檢查所有出去的響應，也就是不用再寫其他出去的規則了，這樣雖然默認的規則是DROP，但這條規則可以規定所有出去的規則</span></span><br><span class="line">iptables -D OUTPUT 2		</span><br><span class="line"><span class="meta">#</span><span class="bash">刪除OUTPUT的第二條</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT		</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">放行本機的回環地址，因爲ftp服務要通過本機回環地址在mysql數據庫中查詢用戶名密碼，所以要放行才能使用ftp服務或iptables對ftp服務的規則才能生效;ftp服務中PORT表示主動模式，PASV表示被動模式，要使用被動模式因端口是隨機的，所以要使用iptables狀態中的RELATED（相關聯的，與之前的命令有關系）狀態在規則中。如：</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -p tcp -m state --state RELATED -j ACCEPT</span><br><span class="line">iptables -R OUTPUT 1 -s 172.16.100.7 -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">修改OUTPUT中的第一條</span></span><br><span class="line">iptables -R INPUT 6 -d 172.16.100.7 -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">修改INPUT中的第六條，因爲第一次加這條規則時沒有指明ESTABLISHED狀態，使ftp服務連接後不能查看數據。最後，要先裝載ip_conntrack_ftp和ip_nat_ftp模塊才可進行下面的步驟，裝載方法如下：</span></span><br><span class="line">vim /etc/sysconfig/iptables-config		</span><br><span class="line"><span class="meta">#</span><span class="bash">編輯此文件</span></span><br><span class="line">	IPTABLES_MODULES="ip_nat_ftp ip_conntrack_ftp"   </span><br><span class="line">iptables -I INPUT -d 172.16.100.7 -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">用這一條規則先來判斷連接的狀態，符合的就放行，這樣可以讓之後的規則不必再寫這兩種狀態</span></span><br><span class="line">service iptables save</span><br><span class="line">vim /etc/sysconfig/iptables		</span><br><span class="line"><span class="meta">#</span><span class="bash">直接編輯此文件來修改規則，刪除INPUT其他規則中的RELATED和ESTABLISHED</span></span><br><span class="line">service iptables reload</span><br><span class="line">iptables -L -n</span><br><span class="line">iptables -I INPUT 2 -d 172.16.100.7 -p tcp -m multiport --destination-ports 21,22,80 -m state --state NEW -j ACCEPT		</span><br><span class="line"><span class="meta">#</span><span class="bash">加入到INPUT中的第二條，只要是21,22,80端口爲NEW狀態的就放行；另外，之前所有命令中都可以用！號取反，如：</span></span><br><span class="line">    -s ！ 172.16.100.7		</span><br><span class="line">    #表示除了100.7都可以</span><br><span class="line">	</span><br><span class="line">	-j TARGET</span><br><span class="line">		LOG：記錄日志信息，log與DROP、ACCEPT使用時要放在前面</span><br><span class="line">            --log-prefix "STRING"		</span><br><span class="line">            #指定LOG日志的前綴</span><br><span class="line"><span class="meta">			#</span><span class="bash">記日志最好加上速率限定，不然記錄太多，產生大量磁盤IO,使性能下降</span></span><br><span class="line">例：</span><br><span class="line">iptables -I INPUT 4 -d 172.16.100.7 -p icmp --icmp-type 8 -j LOG --logprefix "--firewall log for icmp--"</span><br><span class="line"><span class="meta">#</span><span class="bash">記錄ping本機的日志，在日志中加上一個字符串<span class="string">"--firewall log for icmp--"</span></span></span><br></pre></td></tr></table></figure>
<h2 id="自定義規則鏈並在主鏈中被調用"><a href="#自定義規則鏈並在主鏈中被調用" class="headerlink" title="自定義規則鏈並在主鏈中被調用"></a>自定義規則鏈並在主鏈中被調用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">iptables -N clean_in			</span><br><span class="line"><span class="meta">#</span><span class="bash">新建一條叫clean_in的規則鏈，其中references表示引用，也就是被主鏈調用</span></span><br><span class="line">iptables -A clean_in -d 255.255.255.255 -p icmp -j DROP         </span><br><span class="line"><span class="meta">#</span><span class="bash">添加一條規則</span></span><br><span class="line">iptables -L -n –line-numbers</span><br><span class="line">iptables -A clean_in -d 172.168.255.255 -p icmp -j DROP</span><br><span class="line">iptables -A clean_in -p tcp ! --syn -m state --state NEW -j DROP</span><br><span class="line">iptables -A clean_in -p tcp --tcp-flags ALL ALL -j DROP</span><br><span class="line">iptables -A clean_in -p tcp --tcp-flags ALL NONE -j DROP</span><br><span class="line">iptables -A clean_in -d 172.16.100.7 -j RETURN		</span><br><span class="line"><span class="meta">#</span><span class="bash">返回到主鏈上去</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.7 -j clean_in</span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p tcp --dports 53,113,135,137,139,445 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p udp --dports 53,113.135.137.139.445 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -p udp --dport 1026 -j DROP</span><br><span class="line">iptables -A INPUT -i eth0 -m multiport -p tcp --dports 1433,4899 -j DROP</span><br><span class="line">iptables -A INPUT -p icmp -m limit --limit 10/second -j ACCEPT</span><br><span class="line">iptables -I INPUT -j clean_in      </span><br><span class="line"><span class="meta">#</span><span class="bash">無論什麼地址，先交給clean_in處理一遍，clean_in如果沒有問題再返回主鏈第二條進行處理；如果要刪除自定義鏈要先刪除其中的鏈規則，再刪除自定義的鏈</span></span><br></pre></td></tr></table></figure>
<h2 id="利用iptables的recent模块来抵御DOS攻击"><a href="#利用iptables的recent模块来抵御DOS攻击" class="headerlink" title="利用iptables的recent模块来抵御DOS攻击"></a>利用iptables的recent模块来抵御DOS攻击</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ssh远程连接</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 3 -j DROP</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">利用connlimit模块将单IP的并发设置为3，会误杀使用NAT上网的用户，可以根据实际情况增大该值</span></span><br><span class="line"><span class="meta">#</span><span class="bash">利用recent和state模块限制单IP在300s内只能与本机建立3个新连接，被限制五分钟后即可恢复访问</span></span><br><span class="line">下面对最后两名做一个说明：</span><br><span class="line"><span class="meta">#</span><span class="bash">第二句是记录访问tcp22端口的新连接，记录名为SSH。--<span class="built_in">set</span>记录数据包的来源IP，如果IP已经存在将更新已经存在的条目</span></span><br><span class="line"><span class="meta">#</span><span class="bash">第三句是指SSH记录中的IP，300s内发起超过3次连接则拒绝此IP的连接。--update是指每次建立连接都更新列表；--seconds必须与--rcheck或者--update同时使用；--hitcount必须与--rcheck或者--update同时使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">iptables的记录：/proc/net/ipt_recent/SSH</span></span><br><span class="line"><span class="meta">#</span><span class="bash">也可以使用下面的这句记录日志：</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --name SSH --second 300 --hitcount 3 -j LOG --log-prefix "SSH Attack"</span><br></pre></td></tr></table></figure>
<h2 id="测试4"><a href="#测试4" class="headerlink" title="测试4"></a>测试4</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">試驗在虛擬機中建三臺主機，一臺linux主機，一塊網卡橋接；一臺linux路由，一塊網卡橋接，地址172，一塊網卡用HOST ONLY,地址192；一臺win主機，網卡用HOST ONLY；這時linux主機可與linux路由通信，因爲都是橋接網卡；win主機也可與linux路由通信，因爲是HOST ONLY；而且兩臺主機可以ping通路由上的任一個地址，因爲路由上的兩個地址在一臺主機上，即使不在一個網段也可以通信。但linux主機不能與win主機通信，因爲沒有路由，這時改路由的/proc/sys/net/ipv4/ip_forward項爲1，那麼這臺主機就具有了路由功能。再將兩臺主機的網關指向路由的兩個IP地址，這時就能通信了，這時是用不到NAT功能的。因爲要與公網通信，私網地址不能在公網上路由，所以才用NAT；需要轉換時路由的NAT功能會自動完成，在做源地址轉換時也會做目標地址轉換，只是目標地址轉換是自動進行的</span><br></pre></td></tr></table></figure>
<h2 id="源地址转换"><a href="#源地址转换" class="headerlink" title="源地址转换"></a>源地址转换</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.16.100.7	</span><br><span class="line"><span class="meta">#</span><span class="bash">要在nat表中創建，鏈是POSTROUTING。此条命令指對服務器來講，任何源地址是192.168.10.0/24網段的地址都轉換爲172.16.100.7。--to-source選項可指定一個地址範圍，如****-****，兩個地址間用橫線隔開來表示</span></span><br><span class="line">tcpdump -i eth0 -nn -X icmp</span><br><span class="line"><span class="meta">#</span><span class="bash">到10.7抓包</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT –to-source 123.2.3.2</span><br><span class="line"><span class="meta">#</span><span class="bash">在服務器上寫一條規則，讓所有同學可以訪問互聯網的任一網絡，公網IP地址是123.2.3.2</span></span><br></pre></td></tr></table></figure>
<h2 id="测试5"><a href="#测试5" class="headerlink" title="测试5"></a>测试5</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p icmp -j REJECT		</span><br><span class="line"><span class="meta">#</span><span class="bash">禁止192.168.10.0/24網段主機ping外網，此規則只是禁止了主機之間的ping，而沒有進入中間的防火牆服務器，所以不經過INPUT或OUTPUT進入服務器，而只是經過服務器轉發FORWARD</span></span><br></pre></td></tr></table></figure>
<h2 id="测试6"><a href="#测试6" class="headerlink" title="测试6"></a>测试6</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -A FORWARD -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">如果是已建立的連接都放行</span></span><br><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p tcp --dport 80 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">出去的規則，如果訪問的是web服務都放行，這是只能從內網出去的，外網是進不來的</span></span><br><span class="line">IPTABLES -A FORWARD -s 192.168.10.0/24 -p icmp --icmp-type 8 -m state --state NEW -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">放行ping，可以ping其他主機。這是只能從內網出去的，外網是進不來的</span></span><br><span class="line">iptables -A FORWARD -s 192.168.10.0/24 -p tcp --dport 21 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">放行ftp服務</span></span><br><span class="line">iptables -R FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT	</span><br><span class="line"><span class="meta">#</span><span class="bash">用上面兩條規則可開放ftp服務，但不要忘記在/etc/sysconfig/iptables-config中加載ip_nat_ftp和ip_nat模塊</span></span><br></pre></td></tr></table></figure>
<h2 id="目标地址转换"><a href="#目标地址转换" class="headerlink" title="目标地址转换"></a>目标地址转换</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d 172.16.100.7 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.22		</span><br><span class="line"><span class="meta">#</span><span class="bash">目標地址轉換要在PREROUTING上做。訪問172主機80端口都以192的80端口返回結果，且只在請求80服務時才轉發</span></span><br><span class="line">iptables -t nat -R PREROUTING 1 -d 172.16.100.7 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.22:8080	</span><br><span class="line"><span class="meta">#</span><span class="bash">改上一條規則，訪問172主機80端口的訪問結果都以192的8080端口返回，這就是PNAT：Port NAT 端口映射或端口轉換</span></span><br><span class="line">iptables -A FORWARD -m string --algo kmp --string "h7n9" -j DROP		</span><br><span class="line"><span class="meta">#</span><span class="bash">涉及到轉發與本機無關時一定是在FORWARD鏈上。這時沒有寫協議，所以是禁止訪問任何內容中有h7n9的</span></span><br></pre></td></tr></table></figure>
<h2 id="iptables脚本"><a href="#iptables脚本" class="headerlink" title="iptables脚本"></a>iptables脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">ipt=/usr/sbin/iptables</span><br><span class="line">einterface=eth1</span><br><span class="line">iinterface=eth0</span><br><span class="line"></span><br><span class="line">eip=172.16.100.7</span><br><span class="line">iip=192.168.10.6</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t nat -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t filter -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -t mangle -F</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -N clean_up</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -A clean_up -d 255.255.255.255 -p icmp -j DROP</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ipt -A clean_up -j RETURN</span></span><br></pre></td></tr></table></figure>
<h2 id="测试7"><a href="#测试7" class="headerlink" title="测试7"></a>测试7</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j LOG --log-prefix "Denied ICMP:" --log-level 7</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">每秒只响应一次ping，超过的记录日志并丢弃</span></span><br><span class="line">iptables -A INPUT -i eth0 -p icmp --icmp-type echo-request -m statistic --mode nth --every 2 --packet 0 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">每两个<span class="built_in">echo</span>-request就丢弃一个</span></span><br></pre></td></tr></table></figure>
<h2 id="测试8"><a href="#测试8" class="headerlink" title="测试8"></a>测试8</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">不允许接受icmp数据包到本地</span></span><br><span class="line">iptables -A INPUT -p all -m state --state INVALID -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">不允许发送未知数据包到本地</span></span><br><span class="line">iptables -A INPUT all -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">允许已经允许过的连接和被动请求数据包发送到本地</span></span><br><span class="line">iptables -A INPUT -p tcp --syn --dport 22 -m state --state NEW -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">检查该连接中第一个数据包，并检查该数据包是否包含syn标记，符合两项条件才允许进入。</span></span><br><span class="line">iptables -A INPUT -p tcp --syn -m state --state NEW -m multiport --dport 21,22,23,24,25 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">使用Multiport模块一次添加多个端口</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL SYN,FIN -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">检查所有 TCP-Flags，但只有syn及fin两个标记同时为1时，数据包才会被筛选出来</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">检查所有 TCP-Flags中syn及fin两个标记同时为1时，数据包才会被筛选出来</span></span><br></pre></td></tr></table></figure>
<h2 id="数据指添加"><a href="#数据指添加" class="headerlink" title="数据指添加"></a>数据指添加</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /root/mac_list.txt | while read MAC</span><br><span class="line">do     </span><br><span class="line">	MAC=$( echo $MAC | awk '&#123;print $1&#125;' )      </span><br><span class="line">	iptables -t filter -A FORWARD -i eth1 -o eth0 -m mac --mac-source $MAC -j ACCEPT</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="mangle表用法-MARK模块匹配（单数据包）"><a href="#mangle表用法-MARK模块匹配（单数据包）" class="headerlink" title="mangle表用法 MARK模块匹配（单数据包）"></a>mangle表用法 MARK模块匹配（单数据包）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A PREROUTING -p tcp --dport 80 -j MARK --set-mark 80</span><br><span class="line">iptables -A FORWARD -p all -m mark --mark 80 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="管理用户或组模块"><a href="#管理用户或组模块" class="headerlink" title="管理用户或组模块"></a>管理用户或组模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A　OUTPUT -p tcp -m owner --uid--owner tom --dport 80 -j ACCEPT</span><br><span class="line">iptables -A　OUTPUT -p udp -m owner --uid--owner tom --dport 53 -j ACCEPT</span><br><span class="line">iptables -A　OUTPUT -p all -m owner --uid--owner tom -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="使用iprange模块添加ip范围"><a href="#使用iprange模块添加ip范围" class="headerlink" title="使用iprange模块添加ip范围"></a>使用iprange模块添加ip范围</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m iprange --src-range 192.168.0.2-192.168.0.61 -j DROP</span><br><span class="line">iptables -A INPUT -m iprange --dst-range 192.168.0.2-192.168.0.61 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="ttl值匹配模块"><a href="#ttl值匹配模块" class="headerlink" title="ttl值匹配模块"></a>ttl值匹配模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m ttl --ttl-eq 64 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-eq</span> 等于</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-lt</span> 小于</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ttl<span class="_">-gt</span> 大于</span></span><br></pre></td></tr></table></figure>
<h2 id="IPSEC-SPI-值控制模块"><a href="#IPSEC-SPI-值控制模块" class="headerlink" title="IPSEC SPI 值控制模块"></a>IPSEC SPI 值控制模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p ah -m ah --ahspi 300 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p esp -m esp --espspi 200 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="pkttype模块"><a href="#pkttype模块" class="headerlink" title="pkttype模块"></a>pkttype模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -p icmp -m pkttype --pky-type broadcast -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">unicast:数据包发送的对象时特定的，如主机A传输给主机B即为unicast类型</span></span><br><span class="line"><span class="meta">#</span><span class="bash">broadcast:数据包传送的对象为广播地址，如192.168.0.255</span></span><br><span class="line"><span class="meta">#</span><span class="bash">multicast:通常应用于网络的“音频”或“视频”广播，而Multicast数据包的特点是，其Source IP一定介于224.0.0.0/24之间。</span></span><br></pre></td></tr></table></figure>
<h2 id="length模块"><a href="#length模块" class="headerlink" title="length模块"></a>length模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp -type 8 -m length --length 92 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp -type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">MTU=(IP包+ICMP包+DATA)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length 50 匹配MTU值刚好为50字节的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length :100 匹配MTU值小于100个字节的数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--length 50:100 匹配MTU值介于50-100个字节的数据包</span></span><br></pre></td></tr></table></figure>
<h2 id="limit数据包重复率匹配"><a href="#limit数据包重复率匹配" class="headerlink" title="limit数据包重复率匹配"></a>limit数据包重复率匹配</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m limit --limit 6/m --limit-burst 10 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">一分钟进入10个数据包以上，就会限制一分钟进入6个数据包，直到6*10s内没有收到数据包，将会解除</span></span><br></pre></td></tr></table></figure>
<h2 id="recent模块"><a href="#recent模块" class="headerlink" title="recent模块"></a>recent模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m recent --name icmp_db --rcheck --second 60 --hitcount 6 -j DROP</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -m recent --set --name icmp_db</span><br><span class="line">cat /proc/net/xt_recent/icmp_db</span><br><span class="line">modprobe xt_recent ip_list_tot=1024 ip_pkt_list_tot=50</span><br><span class="line"><span class="meta">#</span><span class="bash">ip_list_tot设置ip上限条数，默认100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ip_pkt_list_tot设置数据存储空间，默认20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">--name 设置跟踪数据库的文件名</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--<span class="built_in">set</span>将符合条件的来源数据添加到数据库中，但如果来源端数据已经存在，则更新数据库中的记录信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--rcheck只进行数据库中信息的匹配，并不会对已存在的数据做任何变更操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--update如果来源端的数据已存在，则将其更新；若不存在，则不做任何处理</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--remove如果来源端数据已存在，则将其删除，若不存在，则不做任何处理</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--seconds seconds当事件发生时，只会匹配数据库中前“几秒”内的记录，--seconds必须与--rcheck或--update参数共用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--hitcount hits匹配重复发生次数，必须与--rcheck或--update参数共用</span></span><br></pre></td></tr></table></figure>
<h2 id="string模块-匹配字符串"><a href="#string模块-匹配字符串" class="headerlink" title="string模块 匹配字符串"></a>string模块 匹配字符串</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp -d $WEB_SERVER --dport 80 -m string --algo bm --string "system32" -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">--algo 字符串匹配算法的选择，string模块提供了两种不同的算法，分别是bm(Boyer-Moore)及kmp(Knuth-Pratt-Morris),其中bm算法平均速度会比kmp快，不过，你也不必太在意，因为我们匹配的对象不会太大，因此用哪种都差不多</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--from、--to设置匹配字符串的范围，我们可以使用--from来设置匹配的起点，并以--to来设置匹配的终点，其单位为字节，如--from 10意为从第10个字符串开始匹配，如果没有设置这个参数，那么匹配的范围将是整个数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--string匹配条件，如--string <span class="string">"system32"</span>是指要匹配的字符串为system32</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--hex-string匹配条件，但不同于--string参数的地方在于--hex-string是以16进制的方式进行匹配，特别适合用于非ascii字符串的匹配，其匹配条件的表示方法为--hex-string <span class="string">"|2e2f303132333435|"</span>，请注意实际匹配条件为2e2f303132333435，但其左右要使用<span class="string">"|"</span>符号</span></span><br></pre></td></tr></table></figure>
<h2 id="connlimit模块-匹配连接数"><a href="#connlimit模块-匹配连接数" class="headerlink" title="connlimit模块 匹配连接数"></a>connlimit模块 匹配连接数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --syn -d $Web_Server --dport 80 -m connlimit --connlimit-above 30 --connlimit-mask 32 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--connlimit-above 指定最大连接数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connlimit-mask 此参数为子网络掩码，用于匹配范围，例如 8A 16B 24C 25 1/2个c 32代表单一个IP</span></span><br></pre></td></tr></table></figure>
<h2 id="connbytes模块限制每个连接中所能传输的数据量"><a href="#connbytes模块限制每个连接中所能传输的数据量" class="headerlink" title="connbytes模块限制每个连接中所能传输的数据量"></a>connbytes模块限制每个连接中所能传输的数据量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p tcp -d $Web_Server --dport 80 -m connbytes --connbytes-dir reply --connbytes-mode bytes --connbytes 20971520: -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--connbytes-dir original来源方向 reply应答方向 both双向</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connbytes-mode packets以数据包的数量来计算 bytes以数据量来计算</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--connbytes 10:匹配10个以上的单位量 :50匹配50个一下的单位量 10:50匹配10个-50个之间的单位量</span></span><br></pre></td></tr></table></figure>
<h2 id="quota模块-匹配每个ip限制流量（不会清除纪录，要刷新纪录）"><a href="#quota模块-匹配每个ip限制流量（不会清除纪录，要刷新纪录）" class="headerlink" title="quota模块 匹配每个ip限制流量（不会清除纪录，要刷新纪录）"></a>quota模块 匹配每个ip限制流量（不会清除纪录，要刷新纪录）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --sport 80 -m quota --quota 524288000 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i eth0 -o eth1 -p tcp --sport 80 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="time模块-设置规则生效时间"><a href="#time模块-设置规则生效时间" class="headerlink" title="time模块 设置规则生效时间"></a>time模块 设置规则生效时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -o eth1 -d $SRV_FARM -m time --weekdays Mon,Tue,Wed,Thu,Fri --timestart 09:00 --timestop 21:00 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -o eth1 -d $SRV_FARM -j DROP </span><br><span class="line"><span class="meta">#</span><span class="bash">--datestart:YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--datestop</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--timestart:hh:mm[:ss]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--timestop</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--monthdays:day[,day]...1,2,3,4,5,6,7,8,9,10,31</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--weekdays:day[,day]...Mon,Tue,Wed,Thu,Fri,Sat,Sun</span></span><br></pre></td></tr></table></figure>
<h2 id="connmark模块匹配mark值（整条连接）"><a href="#connmark模块匹配mark值（整条连接）" class="headerlink" title="connmark模块匹配mark值（整条连接）"></a>connmark模块匹配mark值（整条连接）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m connmark --mark 1 -j DROP </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">conntrack模块匹配数据包状态，是state模块的加强版</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctstate:匹配数据包的状态，状态列表分别为NEW,ESTABLISHED,RELATED,INVALID,DNAT,SNAT</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctproto:用于匹配OSI七层中第四层的通信层，其功能与用法就如同iptables中的-p参数，如-p tcp,-p udp,-p 47等。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigsrc匹配连接发起方向的来源端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigdst匹配连接发起方向的目的端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctreplsrc匹配数据包应答方向的来源端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctrepldst匹配数据包应答方向的目的端IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigsrcport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctorigdstport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctreplsrcport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctrepldstport</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[!]--ctexpire连接在Netfilter Conntrack数据库(/porc/net/nf_conntrack)的存活时间，使用方法如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">匹配特定的存活时间--ctexpire time</span></span><br><span class="line"><span class="meta">#</span><span class="bash">匹配特定区间的存活时间--ctexpire time:time</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--ctdir设置要匹配那个方向的数据包，使用方法如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">只匹配连接发起方向的数据包--ctdir ORIGINAL</span></span><br><span class="line"><span class="meta">#</span><span class="bash">只匹配数据包应答方向的数据包--ctdir REPLY</span></span><br><span class="line"><span class="meta">#</span><span class="bash">若没有设置这个参数，默认会匹配双向的所有数据包</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">iptables -F</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 21 -m state --state NEW -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 21 -j DROP </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">iptables -F</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -m conntrack --ctproto tcp --ctorigsrc 192.168.1.0/24 --ctorigdstport 21 --ctstate NEW -j ACCEPT</span><br><span class="line">iptables -A INTPU -p tcp --dport 21 -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="statistic模块进行比例匹配"><a href="#statistic模块进行比例匹配" class="headerlink" title="statistic模块进行比例匹配"></a>statistic模块进行比例匹配</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">以随机方式丢弃50%的数据包</span><br><span class="line">iptables -A INPUT -p icmp -m statistic --mode random --probability 0.5 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">按一定规律在每10个icmp包中丢弃1个icmp包</span></span><br><span class="line">iptables -A INPUT -p icmp -m statistic --mode nth --every 10 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash">--mode:random以随机方式丢弃数据包，nth按一定规律丢弃数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--probability:此参数需结合random模式使用，例如--probability 0.4 即代表丢弃40%的数据，其中的数值为0-1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--every此参数需结合nth模式使用，例如--every 10代表在每10个数据包中要丢弃1个数据包</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--packet此参数需要在nth模式与--every参数结合使用，例如--every 10 --packet5</span></span><br></pre></td></tr></table></figure>
<h2 id="layer7-–-17"><a href="#layer7-–-17" class="headerlink" title="layer7 – 17"></a>layer7 – 17</h2>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/ip命令的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/ip命令的使用/" itemprop="url">
                  ip命令的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-27 08:37:10 / 修改時間：10:33:00" itemprop="dateCreated datePublished" datetime="2018-09-27T08:37:10+08:00">2018-09-27</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y iproute</span><br><span class="line">rpm -qi iproute</span><br><span class="line"><span class="meta">#</span><span class="bash">这个软件的版本与内核版本是一样的，因为它要将信息写入内核</span></span><br></pre></td></tr></table></figure>
<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip [ OPTIONS ] OBJECT &#123; COMMAND | help &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">OBJECT := &#123; link | addr | route | netns &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">OBJECT可简写，各OBJECT的子命令也可简写；</span></span><br></pre></td></tr></table></figure>
<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><h2 id="link"><a href="#link" class="headerlink" title="link"></a>link</h2><h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ip  link  set - change device attributes</span><br><span class="line"><span class="meta">#</span><span class="bash">网络设备配置，<span class="built_in">set</span>是修改设备属性</span></span><br><span class="line">	dev NAME (default)：指明要管理的设备，dev关键字可省略；</span><br><span class="line">	up和down：</span><br><span class="line">	multicast on或multicast off：启用或禁用多播功能；</span><br><span class="line">	name NAME：重命名接口</span><br><span class="line">	mtu NUMBER：设置MTU的大小，默认为1500；</span><br><span class="line">	netns PID：ns为namespace，用于将接口移动到指定的网络名称空间；只能在centos7上做</span><br><span class="line">	address：改地址</span><br><span class="line">ip  link  show  - display device attributes</span><br><span class="line"><span class="meta">#</span><span class="bash">show是显示设备属性的，state是状态。显示的是二层设备属性的，与IP无关</span></span><br><span class="line">ip  link  help -  显示简要使用帮助；</span><br></pre></td></tr></table></figure>
<h3 id="例"><a href="#例" class="headerlink" title="例"></a>例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ip link set eth1 down/up</span><br><span class="line"><span class="meta">#</span><span class="bash">关闭或开启eth1网卡</span></span><br><span class="line">ip link set eth1 multicast off/on</span><br><span class="line"><span class="meta">#</span><span class="bash">关闭或开启多播功能</span></span><br><span class="line">ip link set eth2 down</span><br><span class="line">ip link set eth1 name eno6668889999</span><br><span class="line"><span class="meta">#</span><span class="bash">先down掉网卡再改名，不然会报错</span></span><br><span class="line">ip netns list</span><br><span class="line"><span class="meta">#</span><span class="bash">查看网络空间名称</span></span><br><span class="line">ip link add mynet</span><br><span class="line"><span class="meta">#</span><span class="bash">添加一个叫mynet的网络空间</span></span><br><span class="line">ip link set eno16777736 netns mynet</span><br><span class="line"><span class="meta">#</span><span class="bash">将16777736放入mynet空间</span></span><br><span class="line">ip netns exec mynet ip link show</span><br><span class="line"><span class="meta">#</span><span class="bash">这时用普通的命令是查看不到16777736网卡的，用此命令才能查看到此网卡，这像是一个虚拟机一样。这是用来创建虚拟网络的</span></span><br><span class="line">ip netns del mynet</span><br><span class="line"><span class="meta">#</span><span class="bash">删除网络空间</span></span><br></pre></td></tr></table></figure>
<h2 id="netns"><a href="#netns" class="headerlink" title="netns"></a>netns</h2><h3 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ip netns：  - manage network namespaces.</span><br><span class="line">				</span><br><span class="line">ip netns list</span><br><span class="line"><span class="meta">#</span><span class="bash">列出所有的netns</span></span><br><span class="line">ip netns add NAME</span><br><span class="line"><span class="meta">#</span><span class="bash">创建指定的netns</span></span><br><span class="line">ip netns del NAME</span><br><span class="line"><span class="meta">#</span><span class="bash">删除指定的netns</span></span><br><span class="line">ip netns exec NAME COMMAND</span><br><span class="line"><span class="meta">#</span><span class="bash">在指定的netns中运行命令</span></span><br></pre></td></tr></table></figure>
<h2 id="address"><a href="#address" class="headerlink" title="address"></a>address</h2><h3 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ip address - protocol address management.</span><br><span class="line">					</span><br><span class="line">ip address add - add new protocol address</span><br><span class="line">ip addr add IFADDR dev IFACE</span><br><span class="line">    [label NAME]：为额外添加的地址指明接口别名；</span><br><span class="line">    [broadcast ADDRESS]：广播地址；会根据IP和NETMASK自动计算得到；</span><br><span class="line">    [scope SCOPE_VALUE]：</span><br><span class="line">        global：全局可用；</span><br><span class="line">        link：接口可用；</span><br><span class="line">        host：仅本机可用；</span><br><span class="line">        </span><br><span class="line">ip address delete - delete protocol address</span><br><span class="line">ip addr  delete  IFADDR  dev  IFACE </span><br><span class="line">							</span><br><span class="line">ip address show - look at protocol addresses</span><br><span class="line">ip addr list  [IFACE]：显示接口的地址；</span><br><span class="line">						</span><br><span class="line">ip address flush - flush protocol addresses</span><br><span class="line">ip addr flush dev IFACE</span><br><span class="line"><span class="meta">#</span><span class="bash">清空接口上的所有地址</span></span><br></pre></td></tr></table></figure>
<h3 id="例-1"><a href="#例-1" class="headerlink" title="例"></a>例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ip addr show</span><br><span class="line"><span class="meta">#</span><span class="bash">显示所有IP地址</span></span><br><span class="line">ip addr list</span><br><span class="line">ifconfig eth1 0</span><br><span class="line"><span class="meta">#</span><span class="bash">删除eth1上的地址</span></span><br><span class="line">ip addr add 192.168.1.22/24 dev eno16777736</span><br><span class="line"><span class="meta">#</span><span class="bash">添加地址，可以在一块网卡上添加多个地址，只有在一个网段的地址上才会有secondary，不同网段不会有。添加的地址用ifconfig是显示不了的，如果要显示需要加接口别名</span></span><br><span class="line">ip addr add 192.168.1.43/24 dev eno16777736 lable eno16777736:0</span><br><span class="line"><span class="meta">#</span><span class="bash">这样用ifconfig就能显示了</span></span><br><span class="line">ip link show</span><br><span class="line"><span class="meta">#</span><span class="bash">这样可以查看到地址</span></span><br><span class="line">ip addr del 192.168.1.43/24 dev eno16777736</span><br><span class="line"><span class="meta">#</span><span class="bash">删除地址</span></span><br><span class="line">ip addr flush dev eth1</span><br><span class="line"><span class="meta">#</span><span class="bash">清空eth1上的所有地址</span></span><br></pre></td></tr></table></figure>
<h2 id="route"><a href="#route" class="headerlink" title="route"></a>route</h2><h3 id="语法-4"><a href="#语法-4" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ip route - routing table management</span><br><span class="line">				</span><br><span class="line">ip route add - add new route</span><br><span class="line"><span class="meta">#</span><span class="bash">添加路由</span></span><br><span class="line">ip route change - change route</span><br><span class="line"><span class="meta">#</span><span class="bash">修改路由</span></span><br><span class="line">ip route delete - delete route</span><br><span class="line">ip  route  del  TYPE PRIFIX</span><br><span class="line"><span class="meta">#</span><span class="bash">删除路由</span></span><br><span class="line">ip route show - list routes</span><br><span class="line"><span class="meta">#</span><span class="bash">显示路由	</span></span><br><span class="line">ip route flush - flush routing tables</span><br><span class="line"><span class="meta">#</span><span class="bash">清空路由表</span></span><br><span class="line">ip route get - get a single route</span><br><span class="line">ip route get TYPE PRIFIX</span><br><span class="line"><span class="meta">#</span><span class="bash">获取单条路由</span></span><br><span class="line">ip route replace - change or add new one</span><br><span class="line"><span class="meta">#</span><span class="bash">替换路由，有老的就改老的，没有就加新的</span></span><br><span class="line">ip route add TYPE PREFIX  via GW  [dev  IFACE]  [src SOURCE_IP]</span><br><span class="line">ip route add default via GW	</span><br><span class="line"><span class="meta">#</span><span class="bash">添加默认网关</span></span><br></pre></td></tr></table></figure>
<h3 id="例-2"><a href="#例-2" class="headerlink" title="例"></a>例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ip route add 192.168.0.0/24 via 10.0.0.1 dev eth1 src 10.0.20.100</span><br><span class="line"><span class="meta">#</span><span class="bash">添加一条到192.168.0.0/24网络的路由，（via是指明下一跳地址的）下一跳的地址是10.0.0.1，设备是eth1，源地址是10.0.20.100。（src指定源地址，源地址应该是本地网卡上的地址中的一个）也就是本机地址是10.0.20.100，如果想到达192的网络，就要通过eth1设备，走10.0.0.1这个网关。</span></span><br><span class="line">ip route delete 192.168.1.0/24</span><br><span class="line">ip route get 192.168.0.0/24</span><br><span class="line">ip route list</span><br><span class="line"><span class="meta">#</span><span class="bash">显示路由</span></span><br><span class="line">ip route add 192.168.122.0/24 via 192.168.1.10 dev eno16777736 src 192.168.1.109</span><br><span class="line"><span class="meta">#</span><span class="bash">有两个虚拟机，分别位于两台主机上，一台主机地址是192.168.1.10，一台是192.168.1.4，10主机上的虚拟机是用NAT方式联网的，地址是192.168.122.103/24；4主机上的虚拟机是桥接联网的，地址是192.168.1.109/24。现在要用109地址ssh登录192.168.122.103.添加路由，意为到192.168.122.0网络的下一跳地址是192.168.1.10，通过本机的eno16777736网卡，源地址是192.168.1.109。加完此条路由后，可以ping通192.168.122.1，但ping 192.168.122.103时显示Destination Port Unreachable。原因是在192.168.1.10的ubuntu主机上有iptables规则，用/sbin/iptables -F清除规则后，暂时解决了问题</span></span><br><span class="line">ip route add default via 172.16.0.1 dev eno16777736</span><br><span class="line"><span class="meta">#</span><span class="bash">添加默认网关</span></span><br><span class="line">ip route delete 192.168.1.0/24</span><br><span class="line"><span class="meta">#</span><span class="bash">删除到192网络的路由</span></span><br><span class="line">ip route show src 172.16.100.6</span><br><span class="line"><span class="meta">#</span><span class="bash">只显示源地址是172的路由条目</span></span><br><span class="line">ip route get 192.168.0.0/24</span><br><span class="line"><span class="meta">#</span><span class="bash">显示到192网络的路由</span></span><br><span class="line">ip route flush 10/8</span><br><span class="line"><span class="meta">#</span><span class="bash">清除10开头的网络路由，如果删除不了，就要将地址写的再详细些</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/21/阿里云创建pptp-vpn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/21/阿里云创建pptp-vpn/" itemprop="url">
                  阿里云创建pptp_vpn
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-21 09:12:17" itemprop="dateCreated datePublished" datetime="2018-09-21T09:12:17+08:00">2018-09-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-29 11:19:22" itemprop="dateModified" datetime="2018-09-29T11:19:22+08:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ppp pptpd</span><br></pre></td></tr></table></figure>
<h2 id="配置pptpd文件"><a href="#配置pptpd文件" class="headerlink" title="配置pptpd文件"></a>配置pptpd文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pptpd.conf</span><br><span class="line">	localip 172.17.89.106</span><br><span class="line">	remoteip 172.17.0.120-123</span><br><span class="line"><span class="meta">#</span><span class="bash">localip 172.17.89.106和remoteip 172.17.0.120-123分别是VPN的网关地址和VPN拨号获取地址段。</span></span><br><span class="line"></span><br><span class="line">vim /etc/ppp/options.pptpd</span><br><span class="line">	ms-dns 223.5.5.5</span><br><span class="line">	ms-dns 223.6.6.6</span><br><span class="line"><span class="meta">#</span><span class="bash">IP 地址 223.5.5.5 和 223.6.6.6是阿里云的公共 DNS 服务器地址，您可以根据需要调整为其它公共 DNS 服务地址。</span></span><br><span class="line"></span><br><span class="line">vim /etc/ppp/chap-secrets</span><br><span class="line">	test    *       123456     *</span><br><span class="line"><span class="meta">#</span><span class="bash">设置 pptpd 的用户名和密码。根据需要添加账号，一行只添加一个用户账号。按照 用户名 pptpd 密码 IP地址 的格式输入，每一项用空格隔开。保存后退出。示例：<span class="built_in">test</span> pptpd 123456 *，其中 * 表示所有IP。</span></span><br><span class="line"></span><br><span class="line">vim /etc/ppp/ip-up</span><br><span class="line">	ifconfig ppp0 mtu 1472</span><br><span class="line"><span class="meta">#</span><span class="bash">设置最大传输单元 MTU，在命令符 [ -x /etc/ppp/ip-up.local ] &amp;&amp; /etc/ppp/ip-up.local “<span class="variable">$@</span>” 下面添加 ifconfig ppp0 mtu 1472。</span></span><br></pre></td></tr></table></figure>
<h2 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">	net.ipv4.ip_forward = 1</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta">#</span><span class="bash">临时生效</span></span><br></pre></td></tr></table></figure>
<h2 id="添加防火墙规则"><a href="#添加防火墙规则" class="headerlink" title="添加防火墙规则"></a>添加防火墙规则</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j MASQUERADE</span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/255.255.255.0 -j SNAT --to-source 123.127.82.11</span><br><span class="line"><span class="meta">#</span><span class="bash">添加 NAT 转发规则，其中123.127.82.11为您的实例公网 IP 地址</span></span><br><span class="line">iptables-save</span><br></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start pptpd</span><br><span class="line">systemctl enable pptpd</span><br></pre></td></tr></table></figure>
<h1 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h1><h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ppp pptp pptp-setup</span><br></pre></td></tr></table></figure>
<h2 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pptpsetup --create test --server 123.127.82.11 --username test --password 123456 --encrypt --start</span><br><span class="line"><span class="meta">#</span><span class="bash">创建后会自动连接</span></span><br><span class="line">vim /etc/ppp/options.pptpd</span><br><span class="line">	require-mppe-128</span><br><span class="line"><span class="meta">#</span><span class="bash">如果有报错，要加入这一行。</span></span><br></pre></td></tr></table></figure>
<h2 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 实际情况，因为测试发现连接VPN后，可以连接kafka，但硬件设备不能向netty发送数据。但不连接VPN时，硬件设备可以向netty发送数据，但连接不上阿里云的kafka。判断认为，这是由于使用了阿里云提供的添加路由的方法，替换了默认网关。所以有此现象。重新调整了添加路由的命令如下</span><br><span class="line">ip route add 172.17.0.0/16 via 172.17.89.106 dev ppp0</span><br><span class="line"><span class="meta">#</span><span class="bash">添加一条路由，到172.17.0.0/16网络，下一跳地址是172.17.89.106，设备是ppp0。使用via指定下一跳地址。</span></span><br><span class="line">* 阿里云方法，实际中这样是不行的</span><br><span class="line">ip route replace default dev ppp0</span><br><span class="line"><span class="meta">#</span><span class="bash">测试发现，要先连接VPN，再添加路由。如果VPN断开，要重新添加路由。添加后会有三条信息加入，如下第一条和最后两条</span></span><br><span class="line">[root@bogon ~]# ip route l</span><br><span class="line">default dev ppp0 scope link </span><br><span class="line">default via 10.5.5.1 dev ens160 proto static metric 100 </span><br><span class="line">10.5.5.0/24 dev ens160 proto kernel scope link src 10.5.5.25 metric 100 </span><br><span class="line">113.52.7.78 via 10.5.5.1 dev ens160 src 10.5.5.25 </span><br><span class="line">172.17.89.106 dev ppp0 proto kernel scope link src 172.17.0.120</span><br></pre></td></tr></table></figure>
<h2 id="添加命令"><a href="#添加命令" class="headerlink" title="添加命令"></a>添加命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/doc/ppp-2.4.5/scripts/pon /usr/sbin</span><br><span class="line">cp /usr/share/doc/ppp-2.4.5/scripts/poff /usr/sbin</span><br><span class="line">chmod +x /usr/sbin/pon /usr/sbin/poff</span><br></pre></td></tr></table></figure>
<h2 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pon test</span><br><span class="line"><span class="meta">#</span><span class="bash">连接vpn</span></span><br><span class="line">poff test</span><br><span class="line"><span class="meta">#</span><span class="bash">关闭vpn连接</span></span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://help.aliyun.com/knowledge_detail/41345.html?spm=5176.11065259.1996646101.searchclickresult.7c0b72c0WCltyE&amp;accounttraceid=1de748fe-9665-48c9-972a-021e6cfdf811#CentOSVPNclient" target="_blank" rel="noopener">https://help.aliyun.com/knowledge_detail/41345.html?spm=5176.11065259.1996646101.searchclickresult.7c0b72c0WCltyE&amp;accounttraceid=1de748fe-9665-48c9-972a-021e6cfdf811#CentOSVPNclient</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/20/docker使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/20/docker使用/" itemprop="url">
                  docker使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-20 14:26:06" itemprop="dateCreated datePublished" datetime="2018-09-20T14:26:06+08:00">2018-09-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-09 13:19:56" itemprop="dateModified" datetime="2018-10-09T13:19:56+08:00">2018-10-09</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基本运行方式"><a href="#基本运行方式" class="headerlink" title="基本运行方式"></a>基本运行方式</h1><h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker search centos</span><br><span class="line"><span class="meta">#</span>搜索centos镜像</span><br><span class="line">NAME                               DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">centos                             The official build of CentOS.                   4726                [OK]                </span><br><span class="line">ansible/centos7-ansible            Ansible on Centos7                              118                                     [OK]</span><br><span class="line">jdeathe/centos-ssh                 CentOS-6 6.10 x86_64 / CentOS-7 7.5.1804 x86…   99                                      [OK]</span><br><span class="line">consol/centos-xfce-vnc             Centos container with "headless" VNC session…   63                                      [OK]</span><br><span class="line">imagine10255/centos6-lnmp-php56    centos6-lnmp-php56                              45                                      [OK]</span><br></pre></td></tr></table></figure>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull guyton/centos6</span><br><span class="line"><span class="meta">#</span>下载guyton/centos6镜像，官方没有普通的centos6镜像</span><br></pre></td></tr></table></figure>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -it guyton/centos6 bash</span><br><span class="line"><span class="meta">#</span>这是最简单的运行方式。此命令可以运行多次，每运行一次，就是创建一个新的容器。选项功能如下</span><br><span class="line"><span class="meta">#</span>-i：交互式操作；-t：终端。我们这里打算进入bash执行一些命令并查看返回结果，因此我们需要交互式终端。bash：放在镜像名后的是命令，这里我们希望有个交互式 Shell，因此用的是 bash 。</span><br></pre></td></tr></table></figure>
<h2 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">* 查看正在运行的容器</span><br><span class="line">docker@boot2docker:~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">1cd2b28b4f21        guyton/centos6      "bash"              24 seconds ago      Up 23 seconds                           zen_lamarr</span><br><span class="line">418cbf256f89        guyton/centos6      "bash"              5 minutes ago       Up 5 minutes                            sad_haibt</span><br><span class="line"><span class="meta">#</span>因为运行了两次docker run -it guyton/centos6 bash，所以这里有两个容器</span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="meta">#</span>标题含义：</span><br><span class="line"><span class="meta">#</span>CONTAINER ID:容器的唯一表示ID。</span><br><span class="line"><span class="meta">#</span>IMAGE:创建容器时使用的镜像。</span><br><span class="line"><span class="meta">#</span>COMMAND:容器最后运行的命令。</span><br><span class="line"><span class="meta">#</span>CREATED:创建容器的时间。</span><br><span class="line"><span class="meta">#</span>STATUS:容器状态。</span><br><span class="line"><span class="meta">#</span>PORTS:对外开放的端口。</span><br><span class="line"><span class="meta">#</span>NAMES:容器名。可以和容器ID一样唯一标识容器，同一台宿主机上不允许有同名容器存在，否则会冲突。</span><br><span class="line">=======================================================================================</span><br><span class="line">* 查看所有容器</span><br><span class="line">docker@boot2docker:~$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES</span><br><span class="line">1cd2b28b4f21        guyton/centos6      "bash"              2 minutes ago       Exited (0) 8 seconds ago                       zen_lamarr</span><br><span class="line">f2da3e7678a4        guyton/centos6      "bash"              4 minutes ago       Exited (0) 2 minutes ago                       festive_davinci</span><br><span class="line">418cbf256f89        guyton/centos6      "bash"              7 minutes ago       Up 7 minutes                                   sad_haibt</span><br><span class="line"><span class="meta">#</span>可从STATUS列看出只有一个运行，另外两个已停止</span><br><span class="line"></span><br><span class="line">* 查看最新创建的容器，只列出最后创建的</span><br><span class="line">docker@boot2docker:~$ docker ps -l</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES</span><br><span class="line">1cd2b28b4f21        guyton/centos6      "bash"              5 minutes ago       Exited (0) 3 minutes ago                       zen_lamarr</span><br><span class="line"></span><br><span class="line">* 列出最后创建的x个容器</span><br><span class="line">docker@boot2docker:~$ docker ps -n=2</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES</span><br><span class="line">1cd2b28b4f21        guyton/centos6      "bash"              6 minutes ago       Exited (0) 4 minutes ago                       zen_lamarr</span><br><span class="line">f2da3e7678a4        guyton/centos6      "bash"              8 minutes ago       Exited (0) 6 minutes ago                       festive_davinci</span><br><span class="line"><span class="meta">#</span>:-n=x选项，会列出最后创建的x个容器</span><br></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* 语法：</span><br><span class="line">docker start docker_name</span><br><span class="line">docker start docker_ID</span><br><span class="line"></span><br><span class="line">* 例：</span><br><span class="line">docker@boot2docker:~$ docker start f2da3e7678a4</span><br><span class="line">f2da3e7678a4</span><br><span class="line">docker@boot2docker:~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">f2da3e7678a4        guyton/centos6      "bash"              10 minutes ago      Up 2 seconds                            festive_davinci</span><br><span class="line">418cbf256f89        guyton/centos6      "bash"              14 minutes ago      Up 13 minutes                           sad_haibt</span><br><span class="line">docker@boot2docker:~$ docker start zen_lamarr</span><br><span class="line">zen_lamarr</span><br><span class="line">docker@boot2docker:~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">1cd2b28b4f21        guyton/centos6      "bash"              9 minutes ago       Up 4 seconds                            zen_lamarr</span><br><span class="line">f2da3e7678a4        guyton/centos6      "bash"              11 minutes ago      Up About a minute                       festive_davinci</span><br><span class="line">418cbf256f89        guyton/centos6      "bash"              15 minutes ago      Up 15 minutes                           sad_haibt</span><br><span class="line"><span class="meta">#</span>第一个是通过ID启动的，第二个通过name启动</span><br></pre></td></tr></table></figure>
<h2 id="终止"><a href="#终止" class="headerlink" title="终止"></a>终止</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 语法：</span><br><span class="line">docker stop [NAME]/[CONTAINER ID]:将容器退出。</span><br><span class="line">docker kill [NAME]/[CONTAINER ID]:强制停止一个容器。</span><br></pre></td></tr></table></figure>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 语法</span><br><span class="line">docker rm [NAME]/[CONTAINER ID]:不能够删除一个正在运行的容器，会报错。需要先停止容器。</span><br><span class="line"></span><br><span class="line">* 例：</span><br><span class="line">docker rm 'docker ps -a -q'</span><br><span class="line"><span class="meta">#</span>-a标志列出所有容器，-q标志只列出容器的ID，然后传递给rm命令，依次删除容器。</span><br><span class="line"><span class="meta">#</span>一次性删除：docker本身没有提供一次性删除操作，但是可以使用如上命令实现</span><br></pre></td></tr></table></figure>
<h2 id="进入"><a href="#进入" class="headerlink" title="进入"></a>进入</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker@boot2docker:~$ docker attach 1cd2b28b4f21</span><br><span class="line"><span class="meta">#</span>使用attach通过ID进入docker</span><br><span class="line"></span><br><span class="line">docker@boot2docker:~$ docker exec -it f2da3e7678a4 /bin/bash</span><br><span class="line"><span class="meta">#</span>使用exec参数进入</span><br></pre></td></tr></table></figure>
<h2 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. exit（命令）：退出后，这个容器也就消失了，容器销毁ps查不到</span><br><span class="line">2. Ctrl+D（快捷方式）：退出后，这个容器也就消失了,容器销毁ps查不到	</span><br><span class="line">3. 先按Ctrl+P;再按Ctrl+Q（快捷方式）：退出容器，ps能查到，还在后台运行</span><br></pre></td></tr></table></figure>
<h2 id="端口暴露"><a href="#端口暴露" class="headerlink" title="端口暴露"></a>端口暴露</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P training/webapp</span><br><span class="line"><span class="meta">#</span>docker自动在host上打开49000到49900的端口，映射到容器（由镜像指定，或者--expose参数指定）的暴露端口</span><br><span class="line">docker run -d -p 5000:80 training/webapp</span><br><span class="line"><span class="meta">#</span>host上5000号端口，映射到容器暴露的80端口</span><br><span class="line">docker run -d -p 127.0.0.1:5000:80 training/webapp</span><br><span class="line"><span class="meta">#</span>host上127.0.0.1:5000号端口，映射到容器暴露的80端口</span><br><span class="line">docker run -d -p 127.0.0.1::5000 training/webapp</span><br><span class="line"><span class="meta">#</span>host上127.0.0.1:随机端口，映射到容器暴露的80端口</span><br><span class="line">docker run -d -p 127.0.0.1:5000:5000/udp training/webapp</span><br><span class="line"><span class="meta">#</span>绑定udp端口</span><br><span class="line">docker run -it --privileged --name test --hostname test -p 8080:80 centos</span><br><span class="line"><span class="meta">#</span>测试发现，在创建时要使用-it选项，不然之后使用docker start 命令是不能启动容器的，原因待查。--name指定容器名，--hostname指定容器内的主机名</span><br><span class="line">=======================================================================================</span><br><span class="line">docker run选项：</span><br><span class="line">Usage: docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</span><br><span class="line">  -a, --attach=[]            登录容器（以docker run -d启动的容器）</span><br><span class="line">  -c, --cpu-shares=0         设置容器CPU权重，在CPU共享场景使用</span><br><span class="line">  --cap-add=[]               添加权限，权限清单详见：http://linux.die.net/man/7/capabilities</span><br><span class="line">  --cap-drop=[]              删除权限，权限清单详见：http://linux.die.net/man/7/capabilities</span><br><span class="line">  --cidfile=""               运行容器后，在指定文件中写入容器PID值，一种典型的监控系统用法</span><br><span class="line">  --cpuset=""                设置容器可以使用哪些CPU，此参数可以用来容器独占CPU</span><br><span class="line">  -d, --detach=false         指定容器运行于前台还是后台，-d表示在后台运行</span><br><span class="line">  --device=[]                添加主机设备给容器，相当于设备直通</span><br><span class="line">  --dns=[]                   指定容器的dns服务器</span><br><span class="line">  --dns-search=[]            指定容器的dns搜索域名，写入到容器的/etc/resolv.conf文件</span><br><span class="line">  -e, --env=[]               指定环境变量，容器中可以使用该环境变量</span><br><span class="line">  --entrypoint=""            覆盖image的入口点</span><br><span class="line">  --env-file=[]              指定环境变量文件，文件格式为每行一个环境变量</span><br><span class="line">  --expose=[]                指定容器暴露的端口，即修改镜像的暴露端口</span><br><span class="line">  -h, --hostname=""          指定容器的主机名</span><br><span class="line">  -i, --interactive=false    打开STDIN，用于控制台交互</span><br><span class="line">  --link=[]                  指定容器间的关联，使用其他容器的IP、env等信息</span><br><span class="line">  --lxc-conf=[]              指定容器的配置文件，只有在指定--exec-driver=lxc时使用</span><br><span class="line">  -m, --memory=""            指定容器的内存上限</span><br><span class="line">  --name=""                  指定容器名字，后续可以通过名字进行容器管理，links特性需要使用名字</span><br><span class="line">  --net="bridge"             容器网络设置，待详述</span><br><span class="line">  -P, --publish-all=false    指定容器暴露的端口，待详述</span><br><span class="line">  -p, --publish=[]           指定容器暴露的端口，待详述</span><br><span class="line">  --privileged=false         指定容器是否为特权容器，特权容器拥有所有的capabilities</span><br><span class="line">  --restart=""               指定容器停止后的重启策略，待详述</span><br><span class="line">  --rm=false                 指定容器停止后自动删除容器(不支持以docker run -d启动的容器)</span><br><span class="line">  --sig-proxy=true           设置由代理接受并处理信号，但是SIGCHLD、SIGSTOP和SIGKILL不能被代理</span><br><span class="line">  -t, --tty=false            分配tty设备，该可以支持终端登录</span><br><span class="line">  -u, --user=""              指定容器的用户</span><br><span class="line">  -v, --volume=[]            给容器挂载存储卷，挂载到容器的某个目录</span><br><span class="line">  --volumes-from=[]          给容器挂载其他容器上的卷，挂载到容器的某个目录</span><br><span class="line">  -w, --workdir=""           指定容器的工作目录</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx1 -p 8081:80 -itd nginx</span><br><span class="line"><span class="meta">#</span>创建容器，暴露端口。之后可以通过192.168.99.100:8081访问nginx测试页</span><br><span class="line">docker exec -it nginx1 /bin/bash</span><br><span class="line"><span class="meta">#</span>进入nginx1容器中</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/20/Docker安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/20/Docker安装/" itemprop="url">
                  docker安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-20 13:01:32" itemprop="dateCreated datePublished" datetime="2018-09-20T13:01:32+08:00">2018-09-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-09 13:19:47" itemprop="dateModified" datetime="2018-10-09T13:19:47+08:00">2018-10-09</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Windows7"><a href="#Windows7" class="headerlink" title="Windows7"></a>Windows7</h1><ol>
<li>下载DockerToolbox，地址：<a href="https://github.com/docker/toolbox/releases" target="_blank" rel="noopener">https://github.com/docker/toolbox/releases</a></li>
<li>安装中，如果VirualBox和Git已经安装，可以不选</li>
</ol>
<p><img src="\images\docker\docker1.jpg" alt=""></p>
<ol start="3">
<li>安装完成后，桌面上会多出3各图标，如下。其中VirtualBox提供了linux虚拟机的运行环境，Docker Quickstart Terminal用于快速介入linux虚拟机，提供命令行交互，Kitematic是docker GUI很少用到。</li>
</ol>
<p><img src="\images\docker\docker2.jpg" alt=""></p>
<ol start="4">
<li>使用命令创建default虚拟机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">打开cmd</span><br><span class="line">docker-machine create default</span><br></pre></td></tr></table></figure>
<p><img src="\images\docker\docker3.jpg" alt=""></p>
<p>启动时会进行Docker环境的初始化，会在VirtualBox中自动创建名字为default的linux虚拟机，在此过程中会用到boot2docker.iso镜像文件。默认情况下，启动程序会从GitHub上下载此文件的最新版，但由于文件相对较大且速度不给力，多数情况下会下载失败，造成Docker环境无法启动。解决办法：其实DockerToolbox安装文件自带了boot2docker.iso镜像文件，位于安装目录下（如C:\Program Files\Docker Toolbox） ，将此文件拷至C:\Users\Administrator.docker\machine\cache目录下，然后在<strong>网络断开</strong>的情况下重新启动，便可初始化成功。</p>
<ol start="5">
<li>查看default虚拟机的IP地址，使用Xshell连接</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">打开cmd</span><br><span class="line">docker-machine ls</span><br><span class="line"><span class="meta">#</span>查看default地址</span><br><span class="line"><span class="meta">#</span>登录default信息</span><br><span class="line"><span class="meta">#</span>用户名：docker</span><br><span class="line"><span class="meta">#</span>密码：tcuser</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>更改虚拟磁盘存储位置</li>
</ol>
<p>虚拟机的默认存储位置是C:\Users\Administrator.docker\machine\machines ，后期docke镜像文件会不断增加，为了给系统盘减负，最好将磁盘移动到其他位置。</p>
<ul>
<li>首先通过PowerShell或cmd终端中执行【docker-machine stop default】命令停止default虚拟机。</li>
</ul>
<p><img src="\images\docker\docker4.jpg" alt=""></p>
<ul>
<li>通过VirtualBox”管理”–&gt;”虚拟介质管理”界面对虚拟磁盘进行复制。之后添加新磁盘，删除旧磁盘即可</li>
</ul>
<p><img src="\images\docker\docker5.jpg" alt=""></p>
<p><img src="\images\docker\docker6.jpg" alt=""></p>
<p><img src="\images\docker\docker7.jpg" alt=""></p>
<p><img src="\images\docker\docker8.jpg" alt=""></p>
<p><img src="\images\docker\docker9.jpg" alt=""></p>
<p><img src="\images\docker\docker10.jpg" alt=""></p>
<p><img src="\images\docker\docker11.jpg" alt=""></p>
<p><img src="\images\docker\docker12.jpg" alt=""></p>
<p><img src="\images\docker\docker13.jpg" alt=""></p>
<p><img src="\images\docker\docker14.jpg" alt=""></p>
<p><img src="\images\docker\docker15.jpg" alt=""></p>
<ol start="7">
<li>配置镜像加速器</li>
</ol>
<p>登录阿里云<a href="https://cr.console.aliyun.com，点击右侧的镜像加速器，复制地址。最后用命令修改镜像地址即可" target="_blank" rel="noopener">https://cr.console.aliyun.com，点击右侧的镜像加速器，复制地址。最后用命令修改镜像地址即可</a></p>
<p><img src="\images\docker\docker16.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">登录虚拟机default</span><br><span class="line">sudo sed -i "s|EXTRA_ARGS='|EXTRA_ARGS='--registry-mirror=加速地址 |g" /var/lib/boot2docker/profile</span><br><span class="line"><span class="meta">#</span>修改后，可调整default的硬件配置，如CPU，memory，disk等，disk可以不用复制，创建一个新的，大一点的空间。另外，不可取消光驱的启动，因为启动时要用到boot2docker.iso文件</span><br><span class="line">打开cmd</span><br><span class="line">docker-machine restart default</span><br><span class="line"><span class="meta">#</span>重启docker服务</span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://www.cnblogs.com/canger/p/9028723.html" target="_blank" rel="noopener">https://www.cnblogs.com/canger/p/9028723.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/18/阿里云日志文件备份/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/阿里云日志文件备份/" itemprop="url">
                  阿里云日志文件备份
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-18 16:09:41" itemprop="dateCreated datePublished" datetime="2018-09-18T16:09:41+08:00">2018-09-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-19 09:29:06" itemprop="dateModified" datetime="2018-09-19T09:29:06+08:00">2018-09-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>密钥访问</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 准备备份日志的服务器</span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.2.250</span><br></pre></td></tr></table></figure>
<ul>
<li>脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim /root/sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    #</span><br><span class="line">    nettylog=/apps/echarging/log/nettylog</span><br><span class="line">    processorlog=/apps/echarging/log/processor_1_log</span><br><span class="line">    nettyback=/home/nettylog</span><br><span class="line">    processorback=/home/processorlog1</span><br><span class="line">    nettybackR=/home/logbackup/nettylog</span><br><span class="line">    processorbackR=/home/logbackup/processorlog1</span><br><span class="line"></span><br><span class="line">    cd $nettylog</span><br><span class="line">    find ./ -name netty.log-`date -d yesterday +%F`."*".log -exec cp &#123;&#125; $nettyback \;</span><br><span class="line">    tar -zcf $nettyback/netty-log.`date -d yesterday +%F`.tar.gz $nettyback/*.log</span><br><span class="line">    scp $nettyback/netty-log.`date -d yesterday +%F`.tar.gz 192.168.2.250:$nettybackR</span><br><span class="line">    rm -rf $nettyback/*</span><br><span class="line"></span><br><span class="line">    cd $processorlog</span><br><span class="line">    find ./ -name processor_1.log-`date -d yesterday +%F`."*".log -exec cp &#123;&#125; $processorback \;</span><br><span class="line">    tar -zcf $processorback/processor_1.log-`date -d yesterday +%F`.tar.gz $processorback/*.log</span><br><span class="line">    scp $processorback/processor_1.log-`date  -d yesterday +%F`.tar.gz 192.168.2.250:$processorbackR</span><br><span class="line">    rm -rf $processorback/*</span><br><span class="line"><span class="meta">#</span><span class="bash">本打算使用find ./ -name processor_1.log-`date -d yesterday +%F`.<span class="string">"*"</span>.<span class="built_in">log</span> -<span class="built_in">exec</span> tar -zcf processor_log-`date -d yesterday +%F`.tar.gz &#123;&#125; \;命令来直接打包，但测试发现打出的包中只有find查到的最后一个文件。所以将命令改为了两条，先将找到的文件移到一个临时目录，再打包发送。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>定时任务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line">	* 4 * * * /bin/bash /root/sh/scplog.sh</span><br><span class="line">crontab -l</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/18/阿里云RDS数据库备份下载/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/阿里云RDS数据库备份下载/" itemprop="url">
                  阿里云RDS数据库备份下载
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-18 10:20:56 / 修改時間：10:52:10" itemprop="dateCreated datePublished" datetime="2018-09-18T10:20:56+08:00">2018-09-18</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>下载RDS数据备份或日志备份</p>
<ol>
<li>登录RDS管理控制台</li>
<li>选择目标实例所在地域。</li>
<li>单击目标实例的ID，进入基本信息页面</li>
<li>在左侧导航栏中，选择备份恢复，进入备份恢复页面</li>
<li>选择数据备份标签页</li>
<li>选择查询的时间范围，然后单击查询。</li>
<li>在数据备份列表中，找到要下载的数据备份，并单击其对应的下载</li>
<li>在实例备份文件下载窗口，单击复制外网地址，获取数据备份文件外网下载地址。这里可以直接下载到本地，也可以通过内网或外网地址下载</li>
<li>登录云服务器ECS</li>
<li>下载数据备份文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -c '&lt;数据备份文件内网或外网下载地址&gt;' -O &lt;自定义文件名&gt;.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash">-c：启用断点续传模式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-O：将下载的结果保存为指定的文件（建议使用URL中包含的文件名）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">说明：若提示显示100%进度，则表示文件下载完成。</span></span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/mysql备份与还原/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/17/mysql备份与还原/" itemprop="url">
                  mysql备份与还原
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-17 14:08:03" itemprop="dateCreated datePublished" datetime="2018-09-17T14:08:03+08:00">2018-09-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-29 16:25:38" itemprop="dateModified" datetime="2018-09-29T16:25:38+08:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="mysqldump"><a href="#mysqldump" class="headerlink" title="mysqldump"></a>mysqldump</h1><h2 id="mysqldump备份恢复"><a href="#mysqldump备份恢复" class="headerlink" title="mysqldump备份恢复"></a>mysqldump备份恢复</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf.d/server.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    log_bin = mysql_bin</span><br><span class="line"><span class="meta">#</span><span class="bash">开启二进制日志</span></span><br><span class="line">vim /root/.my.cnf</span><br><span class="line">	[client]</span><br><span class="line">    user = 'root'</span><br><span class="line">    password = 'centos'</span><br><span class="line">    host = 'localhost'</span><br><span class="line"><span class="meta">#</span><span class="bash">实现免用户名密码登录</span></span><br><span class="line">mysql -uroot -p &lt; /root/jiaowu.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">将jiaowu.sql文件导入到数据库中</span></span><br><span class="line">mysql</span><br><span class="line">SHOW DATABASES;</span><br><span class="line"><span class="meta">#</span><span class="bash">有jiaowu库了</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看二进制日志位置</span></span><br><span class="line">FLUSH TABLES WITH READ LOCK;</span><br><span class="line"><span class="meta">#</span><span class="bash">再打开一个终端执行此命令，刷新表並且以只讀的方式鎖定所有表，這時再備分</span></span><br><span class="line">mysqldump -uroot -p jiaowu &gt; /tmp/jiaowu.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">导出jiaowu库</span></span><br><span class="line">FLUSH LOGS;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line"><span class="meta">#</span><span class="bash">備份完成後立即釋放鎖</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看二进制日志位置，只取滾動後新建的日志</span></span><br></pre></td></tr></table></figure>
<h2 id="mysqldump命令选项"><a href="#mysqldump命令选项" class="headerlink" title="mysqldump命令选项"></a>mysqldump命令选项</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p jiaowu &gt; /root/jiaowu-`date +%F-%H-%M-%S`.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">備份</span></span><br><span class="line">mysqldump -uroot -p --master-data=2 jiaowu &gt; /root/jiaowu-`date +%F-%H-%M-%S`.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">用了第二條命令會在備份的文件中有CHANGE MASTER TO NASTER_LOG_FILE=`mysql-bin.000008, MASTER_LOG_POS=107`指明現在的日志名稱及位置</span></span><br><span class="line">mysqldump -uroot -p --lock-all-tables --flush-logs --all-databases &gt; /root/all.sql  </span><br><span class="line"><span class="meta">#</span><span class="bash">因為不是所有庫都是InnoDB引擎的，所以要用--lock-all-tables選項，之後備份所有庫，還可以加上--master-data=2選項</span></span><br><span class="line">mysqldump -uroot -p --lock-all-tables --flush-logs --all-databases --master-data=2 &gt; /root/all.sql</span><br><span class="line">less /root/all.sql         </span><br><span class="line"><span class="meta">#</span><span class="bash">查看</span></span><br><span class="line">=======================================================================================</span><br><span class="line">mysqldump</span><br><span class="line">    --master-data=n	    n=&#123;0、1、2&#125;</span><br><span class="line">        0表示不記錄二進制日志文件记录位置</span><br><span class="line">        1表示以CHNAGER MASTER TO的方式記錄位置，可用於恢復後直接啟動從服務器</span><br><span class="line">        2表示以CHNAGER MASTER TO的方式記錄位置，但默認被注釋了</span><br><span class="line">    --lock-all-tables：備份前鎖定所有表</span><br><span class="line">    --flush-logs：備份前鎖完表執行日志滾動             flush滾動</span><br><span class="line">    #如果指定庫中的表類型均為InnoDB，可使用--single-transaction啟動熱備，這時就不用鎖定表了--lock-all-tables，這個過程可能很長</span><br><span class="line">    * 備份多個庫</span><br><span class="line">    --all-databases：備份所有庫</span><br><span class="line">    --databases DB_NAME,DB_NAME,…：備份指定庫              </span><br><span class="line">    #這兩個命令由於備份不只一個數據庫，所以會自動創建create databases命令，還原前就不用手動再指定庫了</span><br><span class="line">    --events：備份事件</span><br><span class="line">    --routines：備份存儲過程存儲函數</span><br><span class="line">    --triggers：備份觸發器</span><br></pre></td></tr></table></figure>
<h2 id="備份及即時點還原"><a href="#備份及即時點還原" class="headerlink" title="備份及即時點還原"></a>備份及即時點還原</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">備份及即時點還原</span><br><span class="line">備份策略：每周完全+每日增量</span><br><span class="line">    完全備份：mysqldump</span><br><span class="line">    增量備份：備份二進制日志文件（先flush logs）</span><br><span class="line">    </span><br><span class="line">步骤：</span><br><span class="line">1. 做全量备份</span><br><span class="line">2. 删除现有二进制日志之前的所有日志</span><br><span class="line">3. 删除某表中的一些行，以便下面测试</span><br><span class="line">4. 滚动日志</span><br><span class="line">5. 复制滚动前二进制日志到其他路径或将滚动前二进制日志转为sql文件保存到其他目录，实现增量备份</span><br><span class="line">6. 在删除了行的表中插入新行</span><br><span class="line">7. 将滚动后的日志（也是现在的日志）复制到其他路径</span><br><span class="line">8. 删除数据目录中的所有文件</span><br><span class="line">9. 停止、启动服务器，实现数据初始</span><br><span class="line">10. 修改root密码</span><br><span class="line">11. 导入全量备份的sql文件</span><br><span class="line">12. 导入增量备份的sql文件</span><br><span class="line">13. 将最新的日志文件转为sql文件并导入，实现即时点还原。</span><br><span class="line">14. 这里全量备份不存在对应的二进制日志，因为被删除了。删除后仅剩一个二进制日志，这个日志就是增量备份的日志。之后做其他操作后又滚动过一次日志，也就是最新的日志。这个过程涉及两个日志和一个全量备份的sql文件。</span><br><span class="line"></span><br><span class="line">mysqldump -uroot -p --master-data=2 --flush-logs --all-databases --lock-all-tables &gt; /root/alldatabases.sql</span><br><span class="line">mysql</span><br><span class="line"><span class="meta">#</span><span class="bash">建議在刪除備份前的二進制日志前先將其備份一份，可能以後有用。</span></span><br><span class="line">less /root/ alldatabases.sql</span><br><span class="line">PURGE BINARY LOGS TO 'mysql_bin.000011';             </span><br><span class="line"><span class="meta">#</span><span class="bash">刪除二進制文件，這是為了避免空間被佔滿，这是删除mysql_bin.000011之前的所有二进制日志</span></span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line">DELETE FROM tutors WHERE Age&gt;80;            </span><br><span class="line"><span class="meta">#</span><span class="bash">刪除一些行</span></span><br><span class="line">* 下面做增量備份</span><br><span class="line">mysql</span><br><span class="line">FLUSH LOGS;         </span><br><span class="line"><span class="meta">#</span><span class="bash">滾動</span></span><br><span class="line">quit        </span><br><span class="line"><span class="meta">#</span><span class="bash">退出mysql</span></span><br><span class="line">cd /mydata/data              </span><br><span class="line"><span class="meta">#</span><span class="bash">到數據目錄中</span></span><br><span class="line">cp mysql-bin.000011 /root/          </span><br><span class="line"><span class="meta">#</span><span class="bash">因之前已經滾動了日志，所以倒數第二個就是我們要增量備份的日志，將其拷貝到root目錄即可。</span></span><br><span class="line">或</span><br><span class="line">mysqlbinlog mysql-bin.000011 &gt; /root/mon-incremental.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">這種方式的增量備份更好一些</span></span><br><span class="line">mysql</span><br><span class="line">use studb;</span><br><span class="line">INSERT INTO tutors (Tname) Values (‘stu123’);</span><br><span class="line">退出</span><br><span class="line">* 模擬刪除了數據庫，而不能刪二進制日志</span><br><span class="line">cp mysql-bin.000012 /root           </span><br><span class="line"><span class="meta">#</span><span class="bash">將二進制日志拷出去</span></span><br><span class="line">rm -rf ./*        </span><br><span class="line"><span class="meta">#</span><span class="bash">刪除數據目錄中的所有文件</span></span><br><span class="line">service mysqld stop        </span><br><span class="line"><span class="meta">#</span><span class="bash">現在無法停止mysql</span></span><br><span class="line">killall mysqld              </span><br><span class="line"><span class="meta">#</span><span class="bash">殺死mysql進程</span></span><br><span class="line">cd /usr/local/mysql/            </span><br><span class="line"><span class="meta">#</span><span class="bash">到此目錄初始化mysql</span></span><br><span class="line">scripts/mysql_install_db --user=mysql --datadir=/mydata/data              </span><br><span class="line"><span class="meta">#</span><span class="bash">初始化，这是编译安装的。如果是yum安装的可以直接启动，就会初始化</span></span><br><span class="line">service mysqld start        </span><br><span class="line"><span class="meta">#</span><span class="bash">啟動mysql</span></span><br><span class="line">mysql</span><br><span class="line">UPDATE mysql.user SET PASSWORD=PASSWORD('centos') WHERE User='root';</span><br><span class="line"><span class="meta">#</span><span class="bash">设置root的密码</span></span><br><span class="line">mysql -uroot -p &lt; alldatabases.sql            </span><br><span class="line"><span class="meta">#</span><span class="bash">還原完全備份</span></span><br><span class="line">mysql</span><br><span class="line">mysql -uroot -p</span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line">退出             </span><br><span class="line"><span class="meta">#</span><span class="bash">這一過程是為了驗證增量備份恢復後的變化</span></span><br><span class="line">mysql -uroot -p &lt; mon-incremental.sql          </span><br><span class="line"><span class="meta">#</span><span class="bash">恢復增量備份</span></span><br><span class="line">mysql -uroot -p         </span><br><span class="line"><span class="meta">#</span><span class="bash">進入</span></span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;             </span><br><span class="line"><span class="meta">#</span><span class="bash">查看證明有變化</span></span><br><span class="line">退出</span><br><span class="line">mysqlbinlog mysql-bin.000012 &gt; temp.sql    </span><br><span class="line"><span class="meta">#</span><span class="bash">把日志文件導出為.sql文件</span></span><br><span class="line">mysql -uroot -p &lt; temp.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">即時點還原。</span></span><br><span class="line">或</span><br><span class="line">mysqlbinlog mysql-bin.000012 | mysql -uroot -p         </span><br><span class="line"><span class="meta">#</span><span class="bash">這樣一條命令即可實現即時點還原</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">上面這樣的試驗只適合在數據量小的時候，如果大的話，mysqldump備份會很慢。視頻中要求寫一個mysql完全備份腳本，增量備份寫成另一個腳本，盡量使用變量定義保存位置，使用日期保存備份的文件名稱。還可用腳本還原</span></span><br></pre></td></tr></table></figure>
<h1 id="xtrabackup"><a href="#xtrabackup" class="headerlink" title="xtrabackup"></a>xtrabackup</h1><h2 id="完全备份与恢复"><a href="#完全备份与恢复" class="headerlink" title="完全备份与恢复"></a>完全备份与恢复</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">* 安装</span><br><span class="line">wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.9/binary/redhat/7/x86_64/Percona-XtraBackup-2.4.9-ra467167cdd4-el7-x86_64-bundle.tar</span><br><span class="line">＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝</span><br><span class="line">* rpm包安装</span><br><span class="line">	* CentOS6</span><br><span class="line">yum install http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm</span><br><span class="line">yum list|grep percona</span><br><span class="line">yum install percona-xtrabackup</span><br><span class="line">	* CentOS7</span><br><span class="line">yum install http://www.percona.com/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm</span><br><span class="line">yum list|grep percona</span><br><span class="line">yum install percona-xtrabackup-24</span><br><span class="line"><span class="meta">#</span><span class="bash">阿里云建议MySQL5.6及之前的版本需要安装 Percona XtraBackup 2.3。MySQL5.7版本需要安装 Percona XtraBackup 2.4。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Percona XtraBackup 2.3地址：https://www.percona.com/doc/percona-xtrabackup/2.3/installation/yum_repo.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Percona XtraBackup 2.4地址：https://www.percona.com/doc/percona-xtrabackup/2.4/installation/yum_repo.html</span></span><br><span class="line">=======================================================================================</span><br><span class="line">innobackupex --help</span><br><span class="line">innobackupex --user=DBUSER --password=DBUSERPASS /path/to/BACKUP-DIR/(保存位置)</span><br><span class="line"><span class="meta">#</span><span class="bash">完全備份。innobackupex是一個腳本，在裡面封裝了一些命令行工具，--user=DBUSER --password=DBUSERPASS是連接服務器要用的帳號密碼。服務器可指定，如--host=localhost，這裡被省略了，因為一般都是在本機上進行備份。/path/to/BACKUP-DIR/指要保存的位置。備份的用戶要有權限，如果要使用一個最小權限的用戶進行備份，則可基於如下命令創建此類用戶。可以創建一個專門備份的用戶，或用管理員也可以</span></span><br><span class="line">=======================================================================================</span><br><span class="line">* 授权</span><br><span class="line">mysql</span><br><span class="line">MariaDB [(none)]&gt; CREATE USER 'bkpuser'@'localhost' IDENTIFIED BY 'centos';</span><br><span class="line"><span class="meta">#</span><span class="bash">创建用户</span></span><br><span class="line">MariaDB [(none)]&gt; REVOKE ALL PRIVILEGES,GRANT OPTION FROM 'bkpuser'@'localhost';</span><br><span class="line"><span class="meta">#</span><span class="bash">取消用户所有权限与授权权限</span></span><br><span class="line">MariaDB [(none)]&gt; GRANT RELOAD,LOCK TABLES,REPLICATION CLIENT ON *.* TO 'bkpuser'@'localhost';</span><br><span class="line"><span class="meta">#</span><span class="bash">只需要RELOAD, LOCK TABLES, REPLICATION CLIENT這三個權限就可備份了</span></span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line">MariaDB [(none)]&gt; SHOW GRANTS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看当前用户的授权</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW GRANTS FOR bkpuser@localhost;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看指定用户的授权</span></span><br><span class="line">* 备份</span><br><span class="line">innobackupex --user=root /backup          </span><br><span class="line"><span class="meta">#</span><span class="bash">備份數據庫，自動完成的。這裡的密碼是空，所以省略了，服務器是本機。另外，備份時需要mysql服務器是啟動狀態。備份好後在/backup下有一個以當前時間命名的目錄。使用上面的bkpuser用户备份时会提示有授权问题，也就是缺少某些权限，待解决</span></span><br><span class="line">cd /backup/2016-12-09_22-17-27           </span><br><span class="line"><span class="meta">#</span><span class="bash">目錄中的內容如下:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">jiaowu、mysql、<span class="built_in">test</span>、mydb等是數據庫，ibdata1是表空間文件，backup-my.cnf是服務器的配置文件， 備份好以後可以看到備份好的文件中有一個xtrabackup_binlog_info文件，這是二進制日志信息的文件，可用cat打開，裏面是備份這一刻的二進制文件名與相應的號碼。xtrabackup_binary中有在備份時使用了哪個命令進行的備份的信息，視頻中顯示的是xtrabackup 55。xtrabackup_logfile文件是data數據文件，不能用cat打開；xtrabackup_checkpoints文件裡有備份類型及從哪個邏輯版本號開始的備份，其中to_lsn指的是InnoDB的每一個數據塊InnoDB存儲引擎的數據要存儲在磁盤上，它是存儲數據塊的，每一個數據塊都有一個日志序列號，InnoDB會在內部維持着當前每一數據塊的日志序列號，如果這個塊上的數據發生了改變，這個號碼會加1,下一次可以根據這個號碼做增量備份。如果某一個塊的號碼發生了改變，可以將某一個塊備份一下。這就是可以對InnoDB存儲引擎做增量備份的原因；這裏的信息顯示從0號開始，到1637454結束，下一次就從1637454開始</span></span><br><span class="line"><span class="meta">#</span><span class="bash">這些備份的數據備份完以後是不能直接恢復的，因為備份的數據中有些事務可能只提交了一半，為了避免mysql啟動的修復過程，我們要對備份出來的文件做一些准備工作，然後才能恢復。准備工作包括：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    1.將已經提交的事務同步到數據文件，從日志文件同步到數據文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    2.將尚未提交的事務做回滾</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    用--apply-log選項可完成上面的兩項</span></span><br><span class="line"><span class="meta">#</span><span class="bash">innobackupex --apply-log /backup/*****         </span></span><br><span class="line"><span class="meta">#</span><span class="bash">最後的路徑是我們備份的數據的路徑。這樣就會完成上面提到的兩項工作，不做這項工作的話恢復後mysql是啟動不了的</span></span><br><span class="line">* 测试恢复</span><br><span class="line">mysql</span><br><span class="line">MariaDB [(none)]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0005');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0006');</span><br><span class="line"><span class="meta">#</span><span class="bash">插入两条数据</span></span><br><span class="line">MariaDB [jiaowu]&gt; FLUSH LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">做這步是因為備份當前使用的二進制日志會報錯，所以才滾動一次</span></span><br><span class="line">cp /var/lib/mysql/mysql_bin.000003 /root</span><br><span class="line"><span class="meta">#</span><span class="bash">复制滚动前的日志到其他路径，以备数据恢复时使用</span></span><br><span class="line">systemctl stop mariadb</span><br><span class="line">rm -rf rm -rf /var/lib/mysql/*</span><br><span class="line">innobackupex --copy-back /backup/2018-09-19_11-06-30</span><br><span class="line"><span class="meta">#</span><span class="bash">恢复数据。/恢復時用--copy-back選項，這樣就可以了。這時的數據文件存儲位置（/var/lib/mysql/）一定要是空的，不然會報錯</span></span><br><span class="line">cd /var/lib/mysql/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql/</span><br><span class="line"><span class="meta">#</span><span class="bash">修改数据目录中文件的属主属组为mysql</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line"><span class="meta">#</span><span class="bash">启动报错，无法启动。提示：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:48 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:48 [Note] /usr/libexec/mysqld (mysqld 5.5.60-MariaDB) starting as process 8893 ..</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: The InnoDB memory heap is disabled</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Mutexes and rw_locks use GCC atomic builtins</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Compressed tables use zlib 1.2.7</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Using Linux native AIO</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Initializing buffer pool, size = 2.0G</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:50 InnoDB: Completed initialization of buffer pool</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:51 InnoDB: highest supported file format is Barracuda.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: No valid checkpoint found.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If you are attempting downgrade from MySQL 5.7.9 or later,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: please refer to http://dev.mysql.com/doc/refman/5.5/en/upgrading-downgrading.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If this error appears when you are creating an InnoDB database,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: the problem may be that during an earlier attempt you managed</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: to create the InnoDB data files, but <span class="built_in">log</span> file creation failed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If that is the <span class="keyword">case</span>, please refer to</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: http://dev.mysql.com/doc/refman/5.5/en/error-creating-innodb.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Plugin <span class="string">'InnoDB'</span> init <span class="keyword">function</span> returned error.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Plugin <span class="string">'InnoDB'</span> registration as a STORAGE ENGINE failed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [Note] Plugin <span class="string">'FEEDBACK'</span> is disabled.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Unknown/unsupported storage engine: InnoDB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Aborting</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">	[mysqld]</span><br><span class="line">	innodb_force_recovery=6</span><br><span class="line">	log_bin = mysql_bin</span><br><span class="line"><span class="meta">#</span><span class="bash">加入上面一行后，就可以启动了。启动后可以取消这个选项。也可能是没有开启二进制日志的原因，所以可以加入log_bin = mysql_bin。测试发现，加入开启二进制日志后，就不需要innodb_force_recovery选项了，另外，使用innodb_force_recovery启动后，进入数据库是不能操作的，需要将innodb_force_recovery注释后，再重启才能操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">innodb_force_recovery可以设置为1-6,大的数字包含前面所有数字的影响。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1. (SRV_FORCE_IGNORE_CORRUPT):忽略检查到的corrupt页。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2. (SRV_FORCE_NO_BACKGROUND):阻止主线程的运行，如主线程需要执行full purge操作，会导致crash。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3. (SRV_FORCE_NO_TRX_UNDO):不执行事务回滚操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">4. (SRV_FORCE_NO_IBUF_MERGE):不执行插入缓冲的合并操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">5. (SRV_FORCE_NO_UNDO_LOG_SCAN):不查看重做日志，InnoDB存储引擎会将未提交的事务视为已提交。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">6. (SRV_FORCE_NO_LOG_REDO):不执行前滚的操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">参考：https://www.jb51.net/article/66951.htm</span></span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; SHOW DATABASES;</span><br><span class="line">MariaDB [jiaowu]&gt; USE jiaowu;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">這時是沒有後來加的00006和000005的，要把剛才備份的二進制日志導入即可</span></span><br><span class="line">mysqlbinlog /root/mysql-bin.000003 &gt; /tmp/abc.sql</span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; SET sql_log_bin=0;</span><br><span class="line"><span class="meta">#</span><span class="bash">临时关闭二进制日志</span></span><br><span class="line">MariaDB [jiaowu]&gt; SOURCE /tmp/abc.sql;</span><br><span class="line"><span class="meta">#</span><span class="bash">导入滚动后的二进制日志生成的sql文件，因为stu00005和00006是在完全备份后加入的</span></span><br><span class="line">MariaDB [jiaowu]&gt; SET sql_log_bin=1;</span><br><span class="line"><span class="meta">#</span><span class="bash">开启二进制日志</span></span><br><span class="line">MariaDB [jiaowu]&gt; USE jiaowu;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">现在有刚加入的00006和000005的信息了</span></span><br></pre></td></tr></table></figure>
<h2 id="增量备份"><a href="#增量备份" class="headerlink" title="增量备份"></a>增量备份</h2><p>xtrabackup支持對innodb做增量備份，對MyISAM不支持，對MyISAM如果有就做完全備份；MyISAM適合讀多寫少的情況</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0007');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0008');</span><br><span class="line"><span class="meta">#</span><span class="bash">加入两条数据</span></span><br><span class="line">innobackupex --user=root /backup    </span><br><span class="line"><span class="meta">#</span><span class="bash">恢復過一次後必須再重新做一次完全備份，因爲當前的數據庫沒有完全備份</span></span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0009');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00010');</span><br><span class="line">innobackupex --incremental /backup --incremental-basedir=/backup/2018-09-19_16-04-31/</span><br><span class="line"><span class="meta">#</span><span class="bash">先要指定增量備份的保存位置/backup，--incremental-basedir是指定完全備份的保存位置，它會針對完全備份以後的數據做備份，備份後保存在/backup目錄下。這是第一次增量備份。如果是再一次增量備份時，--incremental-basedir應該指向上一次的增量備份所在的目錄；如果數據庫再次損壞且沒有數據增長，用完全和增量備份就能恢復，如果有數據增長就要再加上二進制日志才能恢復。</span></span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00011');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00012');</span><br><span class="line">innobackupex --incremental /backup --incremental-basedir=/backup/2018-09-19_16-05-33/</span><br><span class="line"><span class="meta">#</span><span class="bash">最後指定的是上一次的增量備份位置,2018-09-19_16-05-33是上一次備份後的目錄。如果之前未做過增量備份，就要指向完全備份</span></span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/</span><br><span class="line"><span class="meta">#</span><span class="bash">/如果有增量備份，這裡一定要指定--redo-only選項；2018-09-19_16-04-34是第一次完全備份；有增量備份的時候我們在實現提交的情況時，只執行redo不要執行endo。这里一定要用--apply-log选项，实现1.將已經提交的事務同步到數據文件，從日志文件同步到數據文件；2.將尚未提交的事務做回滾。不然下面的命令是不能执行的。</span></span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/ --incremental-dir=/backup/2018-09-19_16-05-33/</span><br><span class="line"><span class="meta">#</span><span class="bash">在准備第一次增量備份時要將完全備份寫在前面，還要將增量備份位置寫在最後，用</span></span><br><span class="line">--incremental-dir選項。这是将第一次增量备份合并到完全备份</span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/ --incremental-dir=/backup/2018-09-19_16-06-15</span><br><span class="line"><span class="meta">#</span><span class="bash">這是第二次增量備份，還是前面寫完全備份位置，後面是第二次增量備份的位置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">之後的還原只需要還原完全備份即可，因為此時所有的提交操作都已合並到完全備份上去了，所以在還原時兩個增量備份就用不上了</span></span><br><span class="line">systemctl stop mariadb</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">innobackupex --copy-back /backup/2018-09-19_16-04-34/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql/</span><br><span class="line">systemctl start mariadb</span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">这里有上面插入的所有数据</span></span><br></pre></td></tr></table></figure>
<h2 id="導入或導出單張表，前提是每表一個表空間才可以"><a href="#導入或導出單張表，前提是每表一個表空間才可以" class="headerlink" title="導入或導出單張表，前提是每表一個表空間才可以"></a>導入或導出單張表，前提是每表一個表空間才可以</h2><p>&emsp;&emsp;默認情況下，InnoDB表不能通過直接復制表文件的方式在mysql服務器之間進行移植，即便使用了innodb_file_per_table選項。而使用xtrabackup工具可以實現此種功能，不過，此時需要導出表的mysql服務器啟用了innodb_file_per_table選項（嚴格來說，是要導出的表在其創建之前，mysql服務器就啟用了innodb_file_per_table選項），並且導入表的服務器同時啟用了innodb_file_per_table和innodb_expand_import選項</p>
<ol>
<li>導出表</li>
</ol>
<p>導出表是在備份的prepare階段進行的，因此，一旦完全備份完成，就可以在prepare過程中通過–export選項將某表導出了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innobackupex --apply-log --export /path/to/backup</span><br><span class="line"><span class="meta">#</span><span class="bash">此命令會為每個innodb表的表空間創建一個以.exp結尾的文件，這些以.exp結尾的文件則可以用於導入至其它服務器。</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>導入表</li>
</ol>
<p>要在mysql服務器上導入來自於其它服務器的某innodb表，需要先在當前服務器上創建一個跟原表表結構一致的表，而後才能實現將表導入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash">CREATE TABLE mytable (…) ENGINE=InnoDB;</span></span><br></pre></td></tr></table></figure>
<p>然後將此表的表空間刪除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash">ALTER TABLE mydatabase.mytable DISCARD TABLESPACE;</span></span><br></pre></td></tr></table></figure>
<p>接下來，將來自於導出表的服務器的mytable表的mytable.ibd和mytable.exp文件復制到當前服務器的數據目錄，然後使用如下命令將其導入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> ALTER TABLE mydatabase.mytable IMPORT TABLESPACE;</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
