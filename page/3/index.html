<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="ruopu&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="ruopu&#39;s blog">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ruopu&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/3/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ruopu's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ruopu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首頁</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />標籤</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分類</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />歸檔</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/iptables概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/iptables概念/" itemprop="url">
                  iptables概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-27 10:49:11" itemprop="dateCreated datePublished" datetime="2018-09-27T10:49:11+08:00">2018-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-12 13:54:16" itemprop="dateModified" datetime="2018-10-12T13:54:16+08:00">2018-10-12</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/防火墙/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="防火墙概念"><a href="#防火墙概念" class="headerlink" title="防火墙概念"></a>防火墙概念</h1><ul>
<li><p>主机防火墙：针对于单个主机进行防护。</p>
</li>
<li><p>网络防火墙：往往处于网络入口或边缘，针对于网络入口进行防护，服务于防火墙背后的本地局域网。网络防火墙和主机防火墙并不冲突，可以理解为，网络防火墙主外（集体）， 主机防火墙主内（个人）。</p>
</li>
<li><p>iptables是工作在linux内核中的网络防火墙，netfilter才是防火墙真正的安全框架（framework），iptables和netfilter是一组工具，真正起到防火墙作用的是netfilter，netfilter是内核中的一個過濾框架，iptables是一個生成防火牆規則，並能將其符加在netfilter上，真正實現數據報文過濾、NAT、mangle等規則生成的工具。</p>
</li>
<li><p>防火牆工作在主機或網絡的邊緣，對進出的數據報文進行檢查監控，按事先定義的規則進行相應處理。防火牆可以是硬件或軟件，規則包括匹配標準和處理辦法。</p>
</li>
<li><p>防火牆規則必須放在內核上，因爲我們是不能和內核打交道的，有人在內核的TCP/IP協議棧上開放了幾個位置，開放給用戶空間的應用程序</p>
</li>
<li><p>netfile就是內核中可以放規則的位置；iptables是工作在用戶空間可以寫規則並可通過系統調用放置在內核相應位置的應用程序；報文流向有三種：進來的，出去的和轉發的，在<code>/proc/sys/net/ipv4/ip_forward</code>中就是定義是否轉發的；根據IP地址完成路由表中的路由決策，無論從哪進來的只要到了TCPIP協議棧後，下一個就是路由決策</p>
</li>
<li><p>Netfilter是Linux操作系统核心层内部的一个数据包处理模块，它具有如下功能：</p>
<p>网络地址转换(Network Address Translate)</p>
<p>数据包内容修改</p>
<p>以及数据包过滤的防火墙功能</p>
</li>
</ul>
<h1 id="iptables概念"><a href="#iptables概念" class="headerlink" title="iptables概念"></a>iptables概念</h1><ul>
<li>当客户端访问服务器的web服务时，客户端发送报文到网卡，而tcp/ip协议栈是属于内核的一部分，所以，客户端的信息会通过内核的TCP协议传输到用户空间中的web服务中，而此时，客户端报文的目标终点为web服务所监听的套接字（IP：Port）上，当web服务需要响应客户端请求时，web服务发出的响应报文的目标终点则为客户端，这个时候，web服务所监听的IP与端口反而变成了原点，我们说过，netfilter才是真正的防火墙，它是内核的一部分，所以，如果我们想要防火墙能够达到”防火”的目的，则需要在内核中设置关卡，所有进出的报文都要通过这些关卡，经过检查后，符合放行条件的才能放行，符合阻拦条件的则需要被阻止，于是，就出现了input关卡和output关卡，而这些关卡在iptables中不被称为”关卡”,而被称为”链”。当客户端发来的报文访问的目标地址是其他服务器时，本机的内核要支持IP_FORWARD，我们就可以将报文转发给其他服务器，所以，这个时候，我们就会提到iptables中的其他”链”，他们就是  “路由前”、”转发”、”路由后”，他们的英文名是：PREROUTING、FORWARD、POSTROUTING。如果报文需要转发，那么报文则不会经过input链发往用户空间，而是直接在内核空间中经过forward链和postrouting链转发出去的。</li>
</ul>
<p><img src="/images/iptables/朱双印2.jpg"></p>
<ul>
<li><p>报文的流向：</p>
<p>到本机某进程的报文：PREROUTING –&gt; INPUT</p>
<p>由本机转发的报文：PREROUTING –&gt; FORWARD –&gt; POSTROUTING</p>
<p>由本机的某进程发出报文（通常为响应报文）：OUTPUT –&gt; POSTROUTING</p>
</li>
<li><p>将具有相同功能的规则放在一起就是“表”</p>
</li>
<li><p>hook function：鈎子函數，有五個位置。分別是input（進）, output（出）, forward（轉發）, prerouting（路由做出前）, postrouting（路由之後再發出）</p>
</li>
<li><p>鈎子函數的規則鏈：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；</p>
</li>
<li><p>PREROUTING的规则可以存在于：raw表，mangle表，nat表。</p>
<p>INPUT的规则可以存在于：mangle表，filter表，（centos7中还有nat表，centos6中没有）。</p>
<p>FORWARD的规则可以存在于：mangle表，filter表。</p>
<p>OUTPUT的规则可以存在于：raw表mangle表，nat表，filter表。</p>
<p>POSTROUTING的规则可以存在于：mangle表，nat表。</p>
</li>
<li><p>filter表：INPUT，OUTPUT，FORWARD；负责过滤功能；内核模块：iptables_filter</p>
</li>
<li><p>nat表：PREROUTING，POSTROUTING，OUTPUT（centos7中还有INPUT，centos6中没有）；network address translation，网络地址转换功能；内核模块：iptable_nat</p>
</li>
<li><p>mangle表：INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING；拆解报文，做出修改，并重新封装報文首部的功能；内核模块：iptable_mangle</p>
</li>
<li><p>過濾與mangle是不能放在一起的；</p>
</li>
<li><p>raw表：PREROUTING，OUTPUT；关闭nat表上启用的连接追踪机制；iptable_raw</p>
</li>
<li><p>iptables为我们定义了4张”表”,当他们处于同一条”链”时，执行的优先级如下。</p>
<p>优先级次序（由高而低）：</p>
<p>raw –&gt; mangle –&gt; nat –&gt; filter</p>
<p>某些链天生就不能使用某些表中的规则，所以，4张表中的规则处于同一条链的目前只有output链</p>
</li>
<li><p>数据转发流程</p>
</li>
</ul>
<p><img src="/images/iptables/朱双印数据转发流程.jpg"></p>
<ul>
<li>INPUT、OUTPUT是從內核空間到用戶空間實現過濾的，是主機防火牆設置，通過本機轉發的通過FORWARD鏈，是網絡防火牆的設置。路由的轉發功能可以是一臺主機上的兩個網段的地址.一臺交換機上可以配置多個網段的地址，但它們之間不能通信，但如果不同網段的主機的網關指向了一臺網關服務器上一塊網卡的兩個不同網段的地址，且服務器上開通了路由的功能，那麼就可以通信了；因爲IP地址不是屬於網卡的，而是屬於主機的，所以一塊網卡可以邊接兩個網絡</li>
<li>啓用了ip_forward鏈，默認所有報文都要轉發</li>
<li>應該隔離可以被公網訪問的主機與不能被公網訪問的主機，如在網關服務器上放三塊網卡，其中一塊是面對互聯網的，另一塊是面對內網的，最後一塊面對服務器，開放互聯網訪問時只能從面對互聯網的網卡到面對服務器的網卡；所有在面對內網網卡上的報文要想進來必須得是一個響應，其他不允許，網關服務器被叫做三宿主的主機</li>
<li>netfilter:是一個框架，在TCP/IP協議橈上有5個鈎子函數分別對應5個規則鏈，工作在內核中。不能手動向netfilter中添加數據，要用iptables編寫規則送達netfilter的某個鏈上，但它必須先屬於某張表。默認表是filter，還有nat、mangle表</li>
<li>目標地址轉換在進入時改，源地址轉換在出去的時候改。</li>
<li>可以使用自定義鏈，但只在被默認鏈調用時才能發揮作用，而且如果沒有自定義鏈中的任何規則匹配，還應該有返回機制。用戶可以刪除自定義的空鏈，默認鏈不能刪除。</li>
<li>每個規則都有兩個內置的計數器，一個記錄被匹配的報文個數，一個記錄被匹配的報文大小之和</li>
<li>DNAT：目標地址轉換，轉換IP報文中的目標IP地址。目標地址轉換DNAT，指在返回結果時將地址轉換爲請求的地址。如一臺服務器上沒有服務，但将其設置成轉換到后端兩臺服務器的地址，一臺80一臺21,用户訪問時訪問的是這臺沒有服務的主機，但返回結果是有服務的兩臺主機的內容，在返回結果時就要將地址轉換成沒有服務的主機的IP。也就是当用户访问一个地址时，这个地址本没有服务，但可将此请求转到相应的地址服务上，并在服务返回结果时自动将源地址转为用户请求的地址，这就是目标地址转换。源地址转换与目标地址转换效果相反。我们只操作一半，另一半转换由服务器自动完成</li>
<li>SNAT：源地址轉換，轉換IP報文中的源IP地址（可在POSTROUTING或OUTPUT上做，對網關來講只在POSTROUTING上作）。雖然稱爲源地址轉換，但目標IP地址也會轉換，只不過回程的目標地址會轉換</li>
<li>在互聯網上發送報文的時候，無論經過任何路由設備源IP與目標IP是不會改變的</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>對linux主機而言，IP地址是屬於主機的，不屬於網卡,配在什麼網卡上並不重要，關鍵是是否屬於這臺主機，無論是否打開轉發功能。這裏所說指一臺主機ping自己的網關地址，在網關這臺主機上的IP網關地址即使不在一個網段上也沒有開轉發功能，同樣可以被ping通。只有在ping第三臺網關指向了這臺網關主機另一個網段IP的主機時，才需要轉發。</li>
<li>涉及到轉發與本機無關時一定是在FORWARD鏈上做</li>
<li>iptables在二三四層上進行過濾</li>
</ul>
<h2 id="处理动作"><a href="#处理动作" class="headerlink" title="处理动作"></a>处理动作</h2><ul>
<li><p>ACCEPT：允许数据包通过。</p>
</li>
<li><p>DROP：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。</p>
</li>
<li><p>REJECT：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</p>
</li>
<li><p>SNAT：源地址转换，解决内网用户用同一个公网地址上网的问题。</p>
</li>
<li><p>MASQUERADE：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。</p>
</li>
<li><p>DNAT：目标地址转换。</p>
</li>
<li><p>REDIRECT：在本机做端口映射。</p>
</li>
<li><p>LOG：在/var/log/messages文件中记录日志信息，然后将数据包传递给下一条规则，也就是说除了记录以外不对数据包做任何其他操作，仍然让下一条规则去匹配。</p>
</li>
</ul>
<h2 id="四表五链"><a href="#四表五链" class="headerlink" title="四表五链"></a>四表五链</h2><ul>
<li><p>filter表——过滤数据包</p>
</li>
<li><p>Nat表——用于网络地址转换（IP、端口）</p>
</li>
<li><p>Mangle表——修改数据包的服务类型、TTL、并且可以配置路由实现QOS</p>
</li>
<li><p>Raw表——决定数据包是否被状态跟踪机制处理</p>
</li>
</ul>
<ul>
<li>INPUT链——进来的数据包应用此规则链中的策略</li>
<li>OUTPUT链——外出的数据包应用此规则链中的策略</li>
<li>FORWARD链——转发数据包时应用此规则链中的策略</li>
<li>PREROUTING链——对数据包作路由选择前应用此链中的规则（所有的数据包进来的时侯都先由这个链处理）</li>
<li>POSTROUTING链——对数据包作路由选择后应用此链中的规则（所有的数据包出来的时侯都先由这个链处理）</li>
</ul>
<p><img src="/images/iptables/四表五链详细.jpg" alt=""></p>
<p><img src="/images/iptables/四表五链.png" alt=""></p>
<p><img src="/images/iptables/四表五链鸟哥.jpg" alt=""></p>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><ul>
<li>NEW：新連接請求。主机连接目标主机，在目标主机上看到的第一个想要连接的包</li>
<li>ESTABLISHED：已建立的連接。主机已与目标主机进行通信，判断标准只要目标主机回应了第一个包，就进入该状态。</li>
<li>INVALID：非法連接請求。无效的封包，例如数据破损的封包状态</li>
<li>RELATED：相關聯的。主机已与目标主机进行通信，目标主机发起新的链接方式，例如ftp</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/ip命令的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/ip命令的使用/" itemprop="url">
                  ip命令的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-27 08:37:10" itemprop="dateCreated datePublished" datetime="2018-09-27T08:37:10+08:00">2018-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-16 13:56:20" itemprop="dateModified" datetime="2018-10-16T13:56:20+08:00">2018-10-16</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y iproute</span><br><span class="line">rpm -qi iproute</span><br><span class="line"><span class="meta">#</span><span class="bash">这个软件的版本与内核版本是一样的，因为它要将信息写入内核</span></span><br></pre></td></tr></table></figure>
<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip [ OPTIONS ] OBJECT &#123; COMMAND | help &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">OBJECT := &#123; link | addr | route | netns &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">OBJECT可简写，各OBJECT的子命令也可简写；</span></span><br></pre></td></tr></table></figure>
<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><h2 id="link"><a href="#link" class="headerlink" title="link"></a>link</h2><h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ip  link  set - change device attributes</span><br><span class="line"><span class="meta">#</span><span class="bash">网络设备配置，<span class="built_in">set</span>是修改设备属性</span></span><br><span class="line">	dev NAME (default)：指明要管理的设备，dev关键字可省略；</span><br><span class="line">	up和down：</span><br><span class="line">	multicast on或multicast off：启用或禁用多播功能；</span><br><span class="line">	name NAME：重命名接口</span><br><span class="line">	mtu NUMBER：设置MTU的大小，默认为1500；</span><br><span class="line">	netns PID：ns为namespace，用于将接口移动到指定的网络名称空间；只能在centos7上做</span><br><span class="line">	address：改地址</span><br><span class="line">ip  link  show  - display device attributes</span><br><span class="line"><span class="meta">#</span><span class="bash">show是显示设备属性的，state是状态。显示的是二层设备属性的，与IP无关</span></span><br><span class="line">ip  link  help -  显示简要使用帮助；</span><br></pre></td></tr></table></figure>
<h3 id="例"><a href="#例" class="headerlink" title="例"></a>例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ip link set eth1 down/up</span><br><span class="line"><span class="meta">#</span><span class="bash">关闭或开启eth1网卡</span></span><br><span class="line">ip link set eth1 multicast off/on</span><br><span class="line"><span class="meta">#</span><span class="bash">关闭或开启多播功能</span></span><br><span class="line">ip link set eth2 down</span><br><span class="line">ip link set eth1 name eno6668889999</span><br><span class="line"><span class="meta">#</span><span class="bash">先down掉网卡再改名，不然会报错</span></span><br><span class="line">ip netns list</span><br><span class="line"><span class="meta">#</span><span class="bash">查看网络空间名称</span></span><br><span class="line">ip link add mynet</span><br><span class="line"><span class="meta">#</span><span class="bash">添加一个叫mynet的网络空间</span></span><br><span class="line">ip link set eno16777736 netns mynet</span><br><span class="line"><span class="meta">#</span><span class="bash">将16777736放入mynet空间</span></span><br><span class="line">ip netns exec mynet ip link show</span><br><span class="line"><span class="meta">#</span><span class="bash">这时用普通的命令是查看不到16777736网卡的，用此命令才能查看到此网卡，这像是一个虚拟机一样。这是用来创建虚拟网络的</span></span><br><span class="line">ip netns del mynet</span><br><span class="line"><span class="meta">#</span><span class="bash">删除网络空间</span></span><br></pre></td></tr></table></figure>
<h2 id="netns"><a href="#netns" class="headerlink" title="netns"></a>netns</h2><h3 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ip netns：  - manage network namespaces.</span><br><span class="line">				</span><br><span class="line">ip netns list</span><br><span class="line"><span class="meta">#</span><span class="bash">列出所有的netns</span></span><br><span class="line">ip netns add NAME</span><br><span class="line"><span class="meta">#</span><span class="bash">创建指定的netns</span></span><br><span class="line">ip netns del NAME</span><br><span class="line"><span class="meta">#</span><span class="bash">删除指定的netns</span></span><br><span class="line">ip netns exec NAME COMMAND</span><br><span class="line"><span class="meta">#</span><span class="bash">在指定的netns中运行命令</span></span><br></pre></td></tr></table></figure>
<h2 id="address"><a href="#address" class="headerlink" title="address"></a>address</h2><h3 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ip address - protocol address management.</span><br><span class="line">					</span><br><span class="line">ip address add - add new protocol address</span><br><span class="line">ip addr add IFADDR dev IFACE</span><br><span class="line">    [label NAME]：为额外添加的地址指明接口别名；</span><br><span class="line">    [broadcast ADDRESS]：广播地址；会根据IP和NETMASK自动计算得到；</span><br><span class="line">    [scope SCOPE_VALUE]：</span><br><span class="line">        global：全局可用；</span><br><span class="line">        link：接口可用；</span><br><span class="line">        host：仅本机可用；</span><br><span class="line">        </span><br><span class="line">ip address delete - delete protocol address</span><br><span class="line">ip addr  delete  IFADDR  dev  IFACE </span><br><span class="line">							</span><br><span class="line">ip address show - look at protocol addresses</span><br><span class="line">ip addr list  [IFACE]：显示接口的地址；</span><br><span class="line">						</span><br><span class="line">ip address flush - flush protocol addresses</span><br><span class="line">ip addr flush dev IFACE</span><br><span class="line"><span class="meta">#</span><span class="bash">清空接口上的所有地址</span></span><br></pre></td></tr></table></figure>
<h3 id="例-1"><a href="#例-1" class="headerlink" title="例"></a>例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ip addr show</span><br><span class="line"><span class="meta">#</span><span class="bash">显示所有IP地址</span></span><br><span class="line">ip addr list</span><br><span class="line">ifconfig eth1 0</span><br><span class="line"><span class="meta">#</span><span class="bash">删除eth1上的地址</span></span><br><span class="line">ip addr add 192.168.1.22/24 dev eno16777736</span><br><span class="line"><span class="meta">#</span><span class="bash">添加地址，可以在一块网卡上添加多个地址，只有在一个网段的地址上才会有secondary，不同网段不会有。添加的地址用ifconfig是显示不了的，如果要显示需要加接口别名</span></span><br><span class="line">ip addr add 192.168.1.43/24 dev eno16777736 lable eno16777736:0</span><br><span class="line"><span class="meta">#</span><span class="bash">这样用ifconfig就能显示了</span></span><br><span class="line">ip link show</span><br><span class="line"><span class="meta">#</span><span class="bash">这样可以查看到地址</span></span><br><span class="line">ip addr del 192.168.1.43/24 dev eno16777736</span><br><span class="line"><span class="meta">#</span><span class="bash">删除地址</span></span><br><span class="line">ip addr flush dev eth1</span><br><span class="line"><span class="meta">#</span><span class="bash">清空eth1上的所有地址</span></span><br></pre></td></tr></table></figure>
<h2 id="route"><a href="#route" class="headerlink" title="route"></a>route</h2><h3 id="语法-4"><a href="#语法-4" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ip route - routing table management</span><br><span class="line">				</span><br><span class="line">ip route add - add new route</span><br><span class="line"><span class="meta">#</span><span class="bash">添加路由</span></span><br><span class="line">ip route change - change route</span><br><span class="line"><span class="meta">#</span><span class="bash">修改路由</span></span><br><span class="line">ip route delete - delete route</span><br><span class="line">ip  route  del  TYPE PRIFIX</span><br><span class="line"><span class="meta">#</span><span class="bash">删除路由</span></span><br><span class="line">ip route show - list routes</span><br><span class="line"><span class="meta">#</span><span class="bash">显示路由	</span></span><br><span class="line">ip route flush - flush routing tables</span><br><span class="line"><span class="meta">#</span><span class="bash">清空路由表</span></span><br><span class="line">ip route get - get a single route</span><br><span class="line">ip route get TYPE PRIFIX</span><br><span class="line"><span class="meta">#</span><span class="bash">获取单条路由</span></span><br><span class="line">ip route replace - change or add new one</span><br><span class="line"><span class="meta">#</span><span class="bash">替换路由，有老的就改老的，没有就加新的</span></span><br><span class="line">ip route add TYPE PREFIX  via GW  [dev  IFACE]  [src SOURCE_IP]</span><br><span class="line">ip route add default via GW	</span><br><span class="line"><span class="meta">#</span><span class="bash">添加默认网关</span></span><br></pre></td></tr></table></figure>
<h3 id="例-2"><a href="#例-2" class="headerlink" title="例"></a>例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ip route add 192.168.0.0/24 via 10.0.0.1 dev eth1 src 10.0.20.100</span><br><span class="line"><span class="meta">#</span><span class="bash">添加一条到192.168.0.0/24网络的路由，（via是指明下一跳地址的）下一跳的地址是10.0.0.1，设备是eth1，源地址是10.0.20.100。（src指定源地址，源地址应该是本地网卡上的地址中的一个）也就是本机地址是10.0.20.100，如果想到达192的网络，就要通过eth1设备，走10.0.0.1这个网关。</span></span><br><span class="line">ip route delete 192.168.1.0/24</span><br><span class="line">ip route get 192.168.0.0/24</span><br><span class="line">ip route list</span><br><span class="line"><span class="meta">#</span><span class="bash">显示路由</span></span><br><span class="line">ip route add 192.168.122.0/24 via 192.168.1.10 dev eno16777736 src 192.168.1.109</span><br><span class="line"><span class="meta">#</span><span class="bash">有两个虚拟机，分别位于两台主机上，一台主机地址是192.168.1.10，一台是192.168.1.4，10主机上的虚拟机是用NAT方式联网的，地址是192.168.122.103/24；4主机上的虚拟机是桥接联网的，地址是192.168.1.109/24。现在要用109地址ssh登录192.168.122.103.添加路由，意为到192.168.122.0网络的下一跳地址是192.168.1.10，通过本机的eno16777736网卡，源地址是192.168.1.109。加完此条路由后，可以ping通192.168.122.1，但ping 192.168.122.103时显示Destination Port Unreachable。原因是在192.168.1.10的ubuntu主机上有iptables规则，用/sbin/iptables -F清除规则后，暂时解决了问题</span></span><br><span class="line">ip route add default via 172.16.0.1 dev eno16777736</span><br><span class="line"><span class="meta">#</span><span class="bash">添加默认网关</span></span><br><span class="line">ip route delete 192.168.1.0/24</span><br><span class="line"><span class="meta">#</span><span class="bash">删除到192网络的路由</span></span><br><span class="line">ip route show src 172.16.100.6</span><br><span class="line"><span class="meta">#</span><span class="bash">只显示源地址是172的路由条目</span></span><br><span class="line">ip route get 192.168.0.0/24</span><br><span class="line"><span class="meta">#</span><span class="bash">显示到192网络的路由</span></span><br><span class="line">ip route flush 10/8</span><br><span class="line"><span class="meta">#</span><span class="bash">清除10开头的网络路由，如果删除不了，就要将地址写的再详细些</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/21/阿里云创建pptp-vpn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/21/阿里云创建pptp-vpn/" itemprop="url">
                  阿里云创建pptp_vpn
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-21 09:12:17" itemprop="dateCreated datePublished" datetime="2018-09-21T09:12:17+08:00">2018-09-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-15 13:05:09" itemprop="dateModified" datetime="2018-11-15T13:05:09+08:00">2018-11-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云创建pptp-vpn/" itemprop="url" rel="index"><span itemprop="name">阿里云创建pptp_vpn</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ppp pptpd</span><br></pre></td></tr></table></figure>
<h2 id="配置pptpd文件"><a href="#配置pptpd文件" class="headerlink" title="配置pptpd文件"></a>配置pptpd文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pptpd.conf</span><br><span class="line">	localip 172.17.89.106</span><br><span class="line">	remoteip 172.17.0.120-123</span><br><span class="line"><span class="meta">#</span><span class="bash">localip 172.17.89.106和remoteip 172.17.0.120-123分别是VPN的网关地址和VPN拨号获取地址段。</span></span><br><span class="line"></span><br><span class="line">vim /etc/ppp/options.pptpd</span><br><span class="line">	ms-dns 223.5.5.5</span><br><span class="line">	ms-dns 223.6.6.6</span><br><span class="line"><span class="meta">#</span><span class="bash">IP 地址 223.5.5.5 和 223.6.6.6是阿里云的公共 DNS 服务器地址，您可以根据需要调整为其它公共 DNS 服务地址。</span></span><br><span class="line"></span><br><span class="line">vim /etc/ppp/chap-secrets</span><br><span class="line">	test    *       123456     *</span><br><span class="line"><span class="meta">#</span><span class="bash">设置 pptpd 的用户名和密码。根据需要添加账号，一行只添加一个用户账号。按照 用户名 pptpd 密码 IP地址 的格式输入，每一项用空格隔开。保存后退出。示例：<span class="built_in">test</span> pptpd 123456 *，其中 * 表示所有IP。</span></span><br><span class="line"></span><br><span class="line">vim /etc/ppp/ip-up</span><br><span class="line">	ifconfig ppp0 mtu 1472</span><br><span class="line"><span class="meta">#</span><span class="bash">设置最大传输单元 MTU，在命令符 [ -x /etc/ppp/ip-up.local ] &amp;&amp; /etc/ppp/ip-up.local “<span class="variable">$@</span>” 下面添加 ifconfig ppp0 mtu 1472。</span></span><br></pre></td></tr></table></figure>
<h2 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">	net.ipv4.ip_forward = 1</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta">#</span><span class="bash">临时生效</span></span><br></pre></td></tr></table></figure>
<h2 id="添加防火墙规则"><a href="#添加防火墙规则" class="headerlink" title="添加防火墙规则"></a>添加防火墙规则</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j MASQUERADE</span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/255.255.255.0 -j SNAT --to-source 123.127.82.11</span><br><span class="line"><span class="meta">#</span><span class="bash">添加 NAT 转发规则，其中123.127.82.11为您的实例公网 IP 地址</span></span><br><span class="line">iptables-save</span><br></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start pptpd</span><br><span class="line">systemctl enable pptpd</span><br></pre></td></tr></table></figure>
<h1 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h1><h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ppp pptp pptp-setup</span><br></pre></td></tr></table></figure>
<h2 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pptpsetup --create test --server 123.127.82.11 --username test --password 123456 --encrypt --start</span><br><span class="line"><span class="meta">#</span><span class="bash">创建后会自动连接</span></span><br><span class="line">vim /etc/ppp/options.pptpd</span><br><span class="line">	require-mppe-128</span><br><span class="line"><span class="meta">#</span><span class="bash">如果有报错，要加入这一行。</span></span><br></pre></td></tr></table></figure>
<h2 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 实际情况，因为测试发现连接VPN后，可以连接kafka，但硬件设备不能向netty发送数据。但不连接VPN时，硬件设备可以向netty发送数据，但连接不上阿里云的kafka。判断认为，这是由于使用了阿里云提供的添加路由的方法，替换了默认网关。所以有此现象。重新调整了添加路由的命令如下</span><br><span class="line">ip route add 172.17.0.0/16 via 172.17.89.106 dev ppp0</span><br><span class="line"><span class="meta">#</span><span class="bash">添加一条路由，到172.17.0.0/16网络，下一跳地址是172.17.89.106，设备是ppp0。使用via指定下一跳地址。</span></span><br><span class="line">* 阿里云方法，实际中这样是不行的</span><br><span class="line">ip route replace default dev ppp0</span><br><span class="line"><span class="meta">#</span><span class="bash">测试发现，要先连接VPN，再添加路由。如果VPN断开，要重新添加路由。添加后会有三条信息加入，如下第一条和最后两条</span></span><br><span class="line">[root@bogon ~]# ip route l</span><br><span class="line">default dev ppp0 scope link </span><br><span class="line">default via 10.5.5.1 dev ens160 proto static metric 100 </span><br><span class="line">10.5.5.0/24 dev ens160 proto kernel scope link src 10.5.5.25 metric 100 </span><br><span class="line">113.52.7.78 via 10.5.5.1 dev ens160 src 10.5.5.25 </span><br><span class="line">172.17.89.106 dev ppp0 proto kernel scope link src 172.17.0.120</span><br></pre></td></tr></table></figure>
<h2 id="添加命令"><a href="#添加命令" class="headerlink" title="添加命令"></a>添加命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/doc/ppp-2.4.5/scripts/pon /usr/sbin</span><br><span class="line">cp /usr/share/doc/ppp-2.4.5/scripts/poff /usr/sbin</span><br><span class="line">chmod +x /usr/sbin/pon /usr/sbin/poff</span><br></pre></td></tr></table></figure>
<h2 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pon test</span><br><span class="line"><span class="meta">#</span><span class="bash">连接vpn</span></span><br><span class="line">poff test</span><br><span class="line"><span class="meta">#</span><span class="bash">关闭vpn连接</span></span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://help.aliyun.com/knowledge_detail/41345.html?spm=5176.11065259.1996646101.searchclickresult.7c0b72c0WCltyE&amp;accounttraceid=1de748fe-9665-48c9-972a-021e6cfdf811#CentOSVPNclient" target="_blank" rel="noopener">https://help.aliyun.com/knowledge_detail/41345.html?spm=5176.11065259.1996646101.searchclickresult.7c0b72c0WCltyE&amp;accounttraceid=1de748fe-9665-48c9-972a-021e6cfdf811#CentOSVPNclient</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/20/docker学习三：使用镜像/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/20/docker学习三：使用镜像/" itemprop="url">
                  docker学习三：使用镜像
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-20 14:26:06" itemprop="dateCreated datePublished" datetime="2018-09-20T14:26:06+08:00">2018-09-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-16 16:43:25" itemprop="dateModified" datetime="2018-11-16T16:43:25+08:00">2018-11-16</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* 命令格式</span><br><span class="line">docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 具体的选项可以通过docker pull --<span class="built_in">help</span>命令看到</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Docker 镜像仓库地址:地址的格式一般是&lt;域名/IP&gt;[:端口号]。默认地址是 Docker Hub。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 仓库名:这里的仓库名是两段式名称,即&lt;用户名&gt;/&lt;软件名&gt;。对于 Docker Hub,如果不给出用户名,则默认为library,也就是官方镜像。</span></span><br><span class="line"></span><br><span class="line">* 例：</span><br><span class="line">root@test:~# docker pull ubuntu:16.04</span><br><span class="line">16.04: Pulling from library/ubuntu</span><br><span class="line">18d680d61657: Pull complete </span><br><span class="line">0addb6fece63: Pull complete </span><br><span class="line">78e58219b215: Pull complete </span><br><span class="line">eb6959a66df2: Pull complete </span><br><span class="line">Digest: sha256:76702ec53c5e7771ba3f2c4f6152c3796c142af2b3cb1a02fce66c697db24f12</span><br><span class="line">Status: Downloaded newer image for ubuntu:16.04</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的命令中没有给出 Docker 镜像仓库地址,因此将会从 Docker Hub 获取镜像。而镜像名称是ubuntu:16.04,因此将会获取官方镜像library/ubuntu仓库中标签为16.04的镜像。</span></span><br></pre></td></tr></table></figure>
<blockquote>
<font color="red">从下载过程中可以看到我们之前提及的分层存储的概念,镜像是由多层存储所构成。下载也是一层层的去下载,并非单一文件。下载过程中给出了每一层的 ID 的前 12 位。并且下载结束后,给出该镜像完整的sha256的摘要,以确保下载一致性。层 ID 以及<br>sha256<br>的摘要不总是一样的。这是因为官方镜像是一直在维护的,有任何新的 bug,或者版本更新,都会进行修复再以原来的标签发布,这样可以确保任何使用这个标签的用户可以获得更安全、更稳定的镜像。</font>
</blockquote>
<h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# docker run -it --rm ubuntu:16.04 bash</span><br><span class="line">root@82e7f3542e12:/# cat /etc/os-release </span><br><span class="line">NAME="Ubuntu"</span><br><span class="line">VERSION="16.04.5 LTS (Xenial Xerus)"</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">PRETTY_NAME="Ubuntu 16.04.5 LTS"</span><br><span class="line">VERSION_ID="16.04"</span><br><span class="line">HOME_URL="http://www.ubuntu.com/"</span><br><span class="line">SUPPORT_URL="http://help.ubuntu.com/"</span><br><span class="line">BUG_REPORT_URL="http://bugs.launchpad.net/ubuntu/"</span><br><span class="line">VERSION_CODENAME=xenial</span><br><span class="line">UBUNTU_CODENAME=xenial</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以上面的ubuntu:16.04为基础，使用上面命令进行交互式操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker run是运行容器的命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -it:这是两个参数,一个是-i：交互式操作,一个是-t：终端。我们这里打算进入bash执行一些命令并查看返回结果,因此我们需要交互式终端。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --rm:这个参数是说容器退出后随之将其删除。默认情况下,为了排障需求,退出的容器并不会立即删除,除非手动docker rm。我们这里只是随便执行个命令,看看结果,因此使用--rm可以避免浪费空间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ubuntu:16.04：这是指用ubuntu:16.04镜像为基础来启动容器</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bash：放在镜像名后的是命令，这里我们希望有个交互式shell，因此用的是bash。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入容器后,我们可以在 Shell 下操作,执行任何所需的命令。这里,我们执行了cat /etc/os-release,这是 Linux 常用的查看当前系统版本的命令,从返回的结果可以看到容器内是Ubuntu 16.04.4 LTS系统。最后我们通过<span class="built_in">exit</span>退出了这个容器。</span></span><br></pre></td></tr></table></figure>
<h3 id="列出镜像"><a href="#列出镜像" class="headerlink" title="列出镜像"></a>列出镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# docker image ls</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              16.04               4a689991aa24        4 weeks ago         116MB</span><br><span class="line">ubuntu              latest              4a689991aa24        4 weeks ago         116MB</span><br><span class="line">hello-world         latest              4ab4c602aa5e        2 months ago        1.84kB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出已经下载下来的镜像。列表包含了仓库名、标签、镜像 ID、创建时间以及所占用的空间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 镜像 ID 则是镜像的唯一标识,一个镜像可以对应多个标签。因此,在上面的例子中,我们可以看到ubuntu:latest和ubuntu:16.04拥有相同的 ID,因为它们对应的是同一个镜像。</span></span><br></pre></td></tr></table></figure>
<h4 id="镜像体积"><a href="#镜像体积" class="headerlink" title="镜像体积"></a>镜像体积</h4><blockquote>
<font color="red">如果仔细观察,会注意到,这里标识的所占用空间和在 Docker Hub 上看到的镜像大小不同。比如,ubuntu:16.04<br>镜像大小,在这里是<br>116MB<br>,但是在 Docker Hub 显示的却是<br>50<br>。这是因为 Docker Hub 中显示的体积是压缩后的体积。在镜像下载和上传过程中镜像是保持着压缩状态的,因此 Docker Hub 所显示的大小是网络传输中更关心的流量大小。而<br>docker image ls<br>显示的是镜像下载到本地后,展开的大小,准确说,是展开后的各层所占空间的总和,因为镜像到本地后,查看空间的时候,更关心的是本地磁盘空间占用的大小。另外一个需要注意的问题是,<br>docker image ls<br>列表中的镜像体积总和并非是所有镜像实际硬盘消耗。由于 Docker 镜像是多层存储结构,并且可以继承、复用,因此不同镜像可能会因为使用相同的基础镜像,从而拥有共同的层。由于 Docker 使用 Union FS,相同的层只需要保存一份即可,因此实际镜像硬盘占用空间很可能要比这个列表镜像大小的总和要小的多。 </font>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# docker system df</span><br><span class="line">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class="line">Images              2                   1                   116MB               116MB (99%)</span><br><span class="line">Containers          2                   0                   0B                  0B</span><br><span class="line">Local Volumes       0                   0                   0B                  0B</span><br><span class="line">Build Cache         0                   0                   0B                  0B</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用此命令可以便捷的查看镜像、容器、数据卷所占用的空间。</span></span><br></pre></td></tr></table></figure>
<h4 id="虚悬镜像"><a href="#虚悬镜像" class="headerlink" title="虚悬镜像"></a>虚悬镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">&lt;none&gt;				&lt;none&gt;				00285df0df87		5 days ago			342 MB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用docker image ls命令查看时，可能会出现上面的结果。这个镜像既没有仓库名,也没有标签,均为&lt;none&gt;。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个镜像原本是有镜像名和标签的，随着官方镜像维护，发布新版本后，重新执行<span class="string">"docker pull 镜像名"</span>命令时，这个镜像名被转移到了新下载的镜像身上，而旧的镜像上的这个名称则被取消，从而成为了&lt;none&gt;。除了docker pull命令可能导致这种情况，docker build命令也同样可以导致这种现象。由于新旧镜像同名，旧镜像名称被取水，从而出现仓库名、标签均为&lt;none&gt;的镜像。这类无标签镜像也被称为虚悬镜像(dangling image)</span></span><br><span class="line"></span><br><span class="line">root@test:~# docker image ls -f dangling=true</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">&lt;none&gt;				&lt;none&gt;				00285df0df87		5 days ago			342 MB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用上面命令可以显示出虚悬镜像。一般虚悬镜像已经推动了存在的价值，可以随意删除。</span></span><br><span class="line"></span><br><span class="line">root@test:~# docker image prune </span><br><span class="line">WARNING! This will remove all dangling images.</span><br><span class="line">Are you sure you want to continue? [y/N] y</span><br><span class="line">Total reclaimed space: 0B</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除所有的虚悬镜像</span></span><br></pre></td></tr></table></figure>
<h4 id="中间层镜像"><a href="#中间层镜像" class="headerlink" title="中间层镜像"></a>中间层镜像</h4><blockquote>
<font color="red">为了加速镜像构建、重复利用资源,Docker 会利用中间层镜像。所以在使用一段时间后,可能会看到一些依赖的中间层镜像。默认的docker image ls列表中只会显示顶层镜像,如果希望显示包括中间层镜像在内的所有镜像的话,需要加-a参数。</font>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# docker image ls -a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样会看到很多无标签的镜像,与之前的虚悬镜像不同,这些无标签的镜像很多都是中间层镜像,是其它镜像所依赖的镜像。这些无标签镜像不应该删除,否则会导致上层镜像因为依赖丢失而出错。实际上,这些镜像也没必要删除,因为之前说过,相同的层只会存一遍,而这些镜像是别的镜像的依赖,因此并不会因为它们被列出来而多存了一份,无论如何你也会需要它们。只要删除那些依赖它们的镜像后,这些依赖的中间层镜像也会被连带删除。</span></span><br></pre></td></tr></table></figure>
<h4 id="列出部分镜像"><a href="#列出部分镜像" class="headerlink" title="列出部分镜像"></a>列出部分镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# docker image ls ubuntu</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              16.04               4a689991aa24        4 weeks ago         116MB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据仓库名列出镜像</span></span><br><span class="line"></span><br><span class="line">root@test:~# docker image ls ubuntu:16.04</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              16.04               4a689991aa24        4 weeks ago         116MB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定仓库名和标签，列出特定的某个镜像</span></span><br><span class="line"></span><br><span class="line">root@test:~# docker image ls -f since=ubuntu:16.04</span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤器参数--filter,或者简写为-f。查询在ubuntu:16.04之后建立的镜像。</span></span><br><span class="line"></span><br><span class="line">root@test:~# docker image ls -f before=ubuntu:16.04</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将since改为before，可以查询在ubuntu:16.04之前建立的镜像。</span></span><br><span class="line"></span><br><span class="line">root@test:~# docker image ls -f label=com.example.version=0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果镜像构建时，定义了LABEL，还可以通过LABEL来过滤。</span></span><br></pre></td></tr></table></figure>
<h4 id="以特定格式显示"><a href="#以特定格式显示" class="headerlink" title="以特定格式显示"></a>以特定格式显示</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# docker image ls -q</span><br><span class="line">4a689991aa24</span><br><span class="line">4ab4c602aa5e</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下,docker image ls会输出一个完整的表格,但是我们并非所有时候都会需要这些内容。比如,刚才删除虚悬镜像的时候,我们需要利用docker image ls把所有的虚悬镜像的 ID 列出来,然后才可以交给docker image rm命令作为参数来删除指定的这些镜像,这个时候就用到了-q参数。--filter配合-q产生出指定范围的 ID 列表,然后送给另一个docker命令作为参数,从而针对这组实体成批的进行某种操作的做法在 Docker 命令行使用过程中非常常见</span></span><br><span class="line"></span><br><span class="line">root@test:~# docker image ls --format "&#123;&#123;.ID&#125;&#125;: &#123;&#123;.Repository&#125;&#125;"</span><br><span class="line">4a689991aa24: ubuntu</span><br><span class="line">4ab4c602aa5e: hello-world</span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们可能只是对表格的结构不满意,希望自己组织列;或者不希望有标题,这样方便其它程序解析结果等,这就用到了 Go 的模板语法。上面的命令会直接列出镜像结果,并且只包含镜像ID和仓库名</span></span><br><span class="line"></span><br><span class="line">root@test:~# docker image ls --format "table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Repository&#125;&#125;\t&#123;&#123;.Tag&#125;&#125;"</span><br><span class="line">IMAGE ID            REPOSITORY          TAG</span><br><span class="line">4a689991aa24        ubuntu              16.04</span><br><span class="line">4ab4c602aa5e        hello-world         latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以表格等距显示,并且有标题行,和默认一样,不过列为自定义</span></span><br></pre></td></tr></table></figure>
<h3 id="删除本地镜像"><a href="#删除本地镜像" class="headerlink" title="删除本地镜像"></a>删除本地镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 命令格式</span><br><span class="line">docker image rm [选项] &lt;镜像1&gt; [&lt;镜像2&gt; ...]</span><br></pre></td></tr></table></figure>
<h4 id="用-ID、镜像名、摘要删除镜像"><a href="#用-ID、镜像名、摘要删除镜像" class="headerlink" title="用 ID、镜像名、摘要删除镜像"></a>用 ID、镜像名、摘要删除镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">* 使用ID删除镜像</span><br><span class="line">root@test:~# docker image ls</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              16.04               4a689991aa24        4 weeks ago         116MB</span><br><span class="line">hello-world         latest              4ab4c602aa5e        2 months ago        1.84kB</span><br><span class="line">root@test:~# docker image rm 4ab</span><br><span class="line">Error response from daemon: conflict: unable to delete 4ab4c602aa5e (must be forced) - image is being used by stopped container 641b04116b0a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们可以通过镜像的ID号删除镜像，并且ID号可以只使用前几位。但上面删除时有报错，说明有容器在依赖此镜像，需要先停止这个容器才能删除镜像。</span></span><br><span class="line">root@test:~# docker rm 641b04116b0a</span><br><span class="line">641b04116b0a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除容器</span></span><br><span class="line">root@test:~# docker image rm 4ab</span><br><span class="line">Error response from daemon: conflict: unable to delete 4ab4c602aa5e (must be forced) - image is being used by stopped container 41a0dff7c649</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次删除镜像时依然有此报错，但这次容器的ID变了</span></span><br><span class="line">root@test:~# docker rm 41a0dff7c649</span><br><span class="line">41a0dff7c649</span><br><span class="line">root@test:~# docker image rm 4ab   </span><br><span class="line">Untagged: hello-world:latest</span><br><span class="line">Untagged: hello-world@sha256:0add3ace90ecb4adbf7777e9aacf18357296e799f81cabc9fde470971e499788</span><br><span class="line">Deleted: sha256:4ab4c602aa5eed5528a6620ff18a1dc4faef0e1ab3a5eddeddb410714478c67f</span><br><span class="line">Deleted: sha256:428c97da766c4c13b19088a471de6b622b038f3ae8efa10ec5a37d6d31a2df0b</span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次删除容器后就可以删除镜像了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们可以用镜像的完整 ID,也称为长 ID,来删除镜像。使用脚本的时候可能会用长 ID,但是人工输入就太累了,所以更多的时候是用短 ID来删除镜像。docker image ls默认列出的就已经是短 ID 了,一般取前3个字符以上,只要足够区分于别的镜像就可以了。</span></span><br><span class="line"></span><br><span class="line">* 使用镜像名删除镜像</span><br><span class="line">root@test:~# docker image ls</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              16.04               4a689991aa24        4 weeks ago         116MB</span><br><span class="line">hello-world         latest              4ab4c602aa5e        2 months ago        1.84kB</span><br><span class="line">root@test:~# docker image rm hello-world</span><br><span class="line">Untagged: hello-world:latest</span><br><span class="line">Untagged: hello-world@sha256:0add3ace90ecb4adbf7777e9aacf18357296e799f81cabc9fde470971e499788</span><br><span class="line">Deleted: sha256:4ab4c602aa5eed5528a6620ff18a1dc4faef0e1ab3a5eddeddb410714478c67f</span><br><span class="line">Deleted: sha256:428c97da766c4c13b19088a471de6b622b038f3ae8efa10ec5a37d6d31a2df0b</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用镜像名,也就是&lt;仓库名&gt;:&lt;标签&gt;,来删除镜像。</span></span><br><span class="line"></span><br><span class="line">* 使用镜像摘要删除镜像</span><br><span class="line">root@test:~# docker image ls --digests </span><br><span class="line">REPOSITORY          TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              16.04               sha256:76702ec53c5e7771ba3f2c4f6152c3796c142af2b3cb1a02fce66c697db24f12   4a689991aa24        4 weeks ago         116MB</span><br><span class="line">hello-world         latest              sha256:0add3ace90ecb4adbf7777e9aacf18357296e799f81cabc9fde470971e499788   4ab4c602aa5e        2 months ago        1.84kB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询镜像摘要</span></span><br><span class="line">root@test:~# docker image rm node@sha256:0add3ace90ecb4adbf7777e9aacf18357296e799f81cabc9fde470971e499788</span><br><span class="line">Error: No such image: node@sha256:0add3ace90ecb4adbf7777e9aacf18357296e799f81cabc9fde470971e499788</span><br><span class="line"><span class="meta">#</span><span class="bash"> 按镜像摘要删除镜像，但测试失败，提示没有这个镜像</span></span><br><span class="line"></span><br><span class="line">* Untagged 和 Deleted</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果观察上面这几个命令的运行输出信息的话,你会注意到删除行为分为两类,一类是Untagged,另一类是Deleted。我们之前介绍过,镜像的唯一标识是其 ID 和摘要,而一个镜像可以有多个标签。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 因此当我们使用上面命令删除镜像的时候,实际上是在要求删除某个标签的镜像。所以首先需要做的是将满足我们要求的所有镜像标签都取消,这就是我们看到的Untagged的信息。因为一个镜像可以对应多个标签,因此当我们删除了所指定的标签后,可能还有别的标签指向了这个镜像,如果是这种情况,那么Delete行为就不会发生。所以并非所有的docker image rm都会产生删除镜像的行为,有可能仅仅是取消了某个标签而已。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当该镜像所有的标签都被取消了,该镜像很可能会失去了存在的意义,因此会触发删除行为。镜像是多层存储结构,因此在删除的时候也是从上层向基础层方向依次进行判断删除。镜像的多层结构让镜像复用变动非常容易,因此很有可能某个其它镜像正依赖于当前镜像的某一层。这种情况,依旧不会触发删除该层的行为。直到没有任何层依赖当前层时,才会真实的删除当前层。这就是为什么,有时候会奇怪,为什么明明没有别的标签指向这个镜像,但是它还是存在的原因,也是为什么有时候会发现所删除的层数和自己docker pull看到的层数不一样的原因。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 除了镜像依赖以外,还需要注意的是容器对镜像的依赖。如果有用这个镜像启动的容器存在(即使容器没有运行),那么同样不可以删除这个镜像。之前讲过,容器是以镜像为基础,再加一层容器存储层,组成这样的多层存储结构去运行的。因此该镜像如果被这个容器所依赖的,那么删除必然会导致故障。如果这些容器是不需要的,应该先将它们删除,然后再来删除镜像。</span></span><br></pre></td></tr></table></figure>
<h4 id="用-docker-image-ls-命令来配合"><a href="#用-docker-image-ls-命令来配合" class="headerlink" title="用 docker image ls 命令来配合"></a>用 docker image ls 命令来配合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker image rm $(docker image ls -q redis)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除所有仓库名为redis的镜像。$()表示输入结果，同``。</span></span><br><span class="line">docker image rm $(docker image ls -q -f before=mongo:3.2)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除所有在mongo:3.2之前创建的镜像</span></span><br></pre></td></tr></table></figure>
<h4 id="CentOS-RHEL-的用户需要注意的事项"><a href="#CentOS-RHEL-的用户需要注意的事项" class="headerlink" title="CentOS/RHEL 的用户需要注意的事项"></a>CentOS/RHEL 的用户需要注意的事项</h4><blockquote>
<p>在 Ubuntu/Debian 上有UnionFS可以使用,如aufs或者overlay2,而 CentOS 和 RHEL的内核中没有相关驱动。因此对于这类系统,一般使用devicemapper驱动利用 LVM 的一些机制来模拟分层存储。这样的做法除了性能比较差外,稳定性一般也不好,而且配置相对复杂。Docker 安装在 CentOS/RHEL 上后,会默认选择devicemapper,但是为了简化配置,其devicemapper是跑在一个稀疏文件模拟的块设备上,也被称为loop-lvm。这样的选择是因为不需要额外配置就可以运行 Docker,这是自动配置唯一能做到的事情。但是loop-lvm的做法非常不好,其稳定性、性能更差,无论是日志还是docker info中都会看到警告信息。官方文档有明确的文章讲解了如何配置块设备给devicemapper驱动做存储层的做法,这类做法也被称为配置direct-lvm。<br>除了前面说到的问题外,devicemapper+loop-lvm还有一个缺陷,因为它是稀疏文件,所以它会不断增长。用户在使用过程中会注意到/var/lib/docker/devicemapper/devicemapper/data不断增长,而且无法控制。很多人会希望删除镜像或者可以解决这个问题,结果发现效果并不明显。原因就是这个稀疏文件的空间释放后基本不进行垃圾回收的问题。因此往往会出现即使删除了文件内容,空间却无法回收,随着使用这个稀疏文件一直在不断增长。<br>所以对于 CentOS/RHEL 的用户来说,在没有办法使用UnionFS的情况下,一定要配置direct-lvm给devicemapper,无论是为了性能、稳定性还是空间利用率。<br>或许有人注意到了 CentOS 7 中存在被 backports 回来的overlay驱动,不过 CentOS 里的这个驱动达不到生产环境使用的稳定程度,所以不推荐使用。</p>
</blockquote>
<h3 id="利用-commit-理解镜像构成"><a href="#利用-commit-理解镜像构成" class="headerlink" title="利用 commit 理解镜像构成"></a>利用 commit 理解镜像构成</h3><blockquote>
<p>注意:docker commit命令除了学习之外,还有一些特殊的应用场合,比如被入侵后保存现场等。但是,不要使用<br>docker commit定制镜像,定制镜像应该使用Dockerfile来完成。</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/20/docker学习二：安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/20/docker学习二：安装/" itemprop="url">
                  docker安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-20 13:01:32" itemprop="dateCreated datePublished" datetime="2018-09-20T13:01:32+08:00">2018-09-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-16 13:40:54" itemprop="dateModified" datetime="2018-11-16T13:40:54+08:00">2018-11-16</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Container/" itemprop="url" rel="index"><span itemprop="name">Container</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ubuntu18-04-Server"><a href="#ubuntu18-04-Server" class="headerlink" title="ubuntu18.04_Server"></a>ubuntu18.04_Server</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apt install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"><span class="meta">#</span><span class="bash"> 由于apt源使用 HTTPS 以确保软件下载过程中不被篡改。因此,我们首先需要添加使用HTTPS 传输的软件包以及 CA 证书。</span></span><br><span class="line">curl -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为了确认所下载软件包的合法性,需要添加软件源的GPG密钥。</span></span><br><span class="line">add-apt-repository  "deb [arch=amd64] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu $(lsb_release -cs) stable"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 向source.list中添加 Docker 软件源</span></span><br><span class="line">apt update</span><br><span class="line">apt install docker-ce</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装docker</span></span><br><span class="line">groupadd docker</span><br><span class="line">usermod -aG docker test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将当前用户加入docker组</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下,docker命令会使用 Unix socket 与 Docker 引擎通讯。而只有root用户和组的用户才可以访问 Docker 引擎的 Unix socket。出于安全考虑,一般 Linux 系统上不会直接使用root用户。因此,更好地做法是将需要使用docker的用户加入docker用户组。</span></span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">    &#123;</span><br><span class="line">      "registry-mirrors":[</span><br><span class="line">        "https://87uxhe05.mirror.aliyuncs.com"</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置docker加速器，地址是从阿里云的容器镜像服务器得到的</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker</span><br><span class="line">docker run hello-world</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试docker安装是否成功。如果安装成功，会输入下列内容</span></span><br><span class="line">    Hello from Docker!</span><br><span class="line">    This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">    To generate this message, Docker took the following steps:</span><br><span class="line">     1. The Docker client contacted the Docker daemon.</span><br><span class="line">     2. The Docker daemon pulled the "hello-world" image from the Docker Hub.</span><br><span class="line">        (amd64)</span><br><span class="line">     3. The Docker daemon created a new container from that image which runs the</span><br><span class="line">        executable that produces the output you are currently reading.</span><br><span class="line">     4. The Docker daemon streamed that output to the Docker client, which sent it</span><br><span class="line">        to your terminal.</span><br><span class="line"></span><br><span class="line">    To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line">     $ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">    Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line">     https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">    For more examples and ideas, visit:</span><br><span class="line">     https://docs.docker.com/get-started/</span><br></pre></td></tr></table></figure>
<h1 id="Windows7"><a href="#Windows7" class="headerlink" title="Windows7"></a>Windows7</h1><ol>
<li>下载DockerToolbox，地址：<a href="https://github.com/docker/toolbox/releases" target="_blank" rel="noopener">https://github.com/docker/toolbox/releases</a></li>
<li>安装中，如果VirualBox和Git已经安装，可以不选</li>
</ol>
<p><img src="\images\docker\docker1.jpg" alt=""></p>
<ol start="3">
<li>安装完成后，桌面上会多出3各图标，如下。其中VirtualBox提供了linux虚拟机的运行环境，Docker Quickstart Terminal用于快速介入linux虚拟机，提供命令行交互，Kitematic是docker GUI很少用到。</li>
</ol>
<p><img src="\images\docker\docker2.jpg" alt=""></p>
<ol start="4">
<li>使用命令创建default虚拟机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">打开cmd</span><br><span class="line">docker-machine create default</span><br></pre></td></tr></table></figure>
<p><img src="\images\docker\docker3.jpg" alt=""></p>
<p>启动时会进行Docker环境的初始化，会在VirtualBox中自动创建名字为default的linux虚拟机，在此过程中会用到boot2docker.iso镜像文件。默认情况下，启动程序会从GitHub上下载此文件的最新版，但由于文件相对较大且速度不给力，多数情况下会下载失败，造成Docker环境无法启动。解决办法：其实DockerToolbox安装文件自带了boot2docker.iso镜像文件，位于安装目录下（如C:\Program Files\Docker Toolbox） ，将此文件拷至C:\Users\Administrator.docker\machine\cache目录下，然后在<strong>网络断开</strong>的情况下重新启动，便可初始化成功。</p>
<ol start="5">
<li>查看default虚拟机的IP地址，使用Xshell连接</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">打开cmd</span><br><span class="line">docker-machine ls</span><br><span class="line"><span class="meta">#</span><span class="bash">查看default地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash">登录default信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash">用户名：docker</span></span><br><span class="line"><span class="meta">#</span><span class="bash">密码：tcuser</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>更改虚拟磁盘存储位置</li>
</ol>
<p>虚拟机的默认存储位置是C:\Users\Administrator.docker\machine\machines ，后期docke镜像文件会不断增加，为了给系统盘减负，最好将磁盘移动到其他位置。</p>
<ul>
<li>首先通过PowerShell或cmd终端中执行【docker-machine stop default】命令停止default虚拟机。</li>
</ul>
<p><img src="\images\docker\docker4.jpg" alt=""></p>
<ul>
<li>通过VirtualBox”管理”–&gt;”虚拟介质管理”界面对虚拟磁盘进行复制。之后添加新磁盘，删除旧磁盘即可</li>
</ul>
<p><img src="\images\docker\docker5.jpg" alt=""></p>
<p><img src="\images\docker\docker6.jpg" alt=""></p>
<p><img src="\images\docker\docker7.jpg" alt=""></p>
<p><img src="\images\docker\docker8.jpg" alt=""></p>
<p><img src="\images\docker\docker9.jpg" alt=""></p>
<p><img src="\images\docker\docker10.jpg" alt=""></p>
<p><img src="\images\docker\docker11.jpg" alt=""></p>
<p><img src="\images\docker\docker12.jpg" alt=""></p>
<p><img src="\images\docker\docker13.jpg" alt=""></p>
<p><img src="\images\docker\docker14.jpg" alt=""></p>
<p><img src="\images\docker\docker15.jpg" alt=""></p>
<ol start="7">
<li>配置镜像加速器</li>
</ol>
<p>登录阿里云<a href="https://cr.console.aliyun.com，点击右侧的镜像加速器，复制地址。最后用命令修改镜像地址即可" target="_blank" rel="noopener">https://cr.console.aliyun.com，点击右侧的镜像加速器，复制地址。最后用命令修改镜像地址即可</a></p>
<p><img src="\images\docker\docker16.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">登录虚拟机default</span><br><span class="line">sudo sed -i "s|EXTRA_ARGS='|EXTRA_ARGS='--registry-mirror=加速地址 |g" /var/lib/boot2docker/profile</span><br><span class="line"><span class="meta">#</span><span class="bash">修改后，可调整default的硬件配置，如CPU，memory，disk等，disk可以不用复制，创建一个新的，大一点的空间。另外，不可取消光驱的启动，因为启动时要用到boot2docker.iso文件</span></span><br><span class="line">打开cmd</span><br><span class="line">docker-machine restart default</span><br><span class="line"><span class="meta">#</span><span class="bash">重启docker服务</span></span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://www.cnblogs.com/canger/p/9028723.html" target="_blank" rel="noopener">https://www.cnblogs.com/canger/p/9028723.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/18/阿里云日志文件备份/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/阿里云日志文件备份/" itemprop="url">
                  阿里云日志文件备份
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-18 16:09:41" itemprop="dateCreated datePublished" datetime="2018-09-18T16:09:41+08:00">2018-09-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-15 13:05:02" itemprop="dateModified" datetime="2018-11-15T13:05:02+08:00">2018-11-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云日志文件备份/" itemprop="url" rel="index"><span itemprop="name">阿里云日志文件备份</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>密钥访问</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 准备备份日志的服务器</span><br><span class="line">ssh-keygen -t rsa -P ''</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.2.250</span><br></pre></td></tr></table></figure>
<ul>
<li>脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim /root/sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    #</span><br><span class="line">    nettylog=/apps/echarging/log/nettylog</span><br><span class="line">    processorlog=/apps/echarging/log/processor_1_log</span><br><span class="line">    nettyback=/home/nettylog</span><br><span class="line">    processorback=/home/processorlog1</span><br><span class="line">    nettybackR=/home/logbackup/nettylog</span><br><span class="line">    processorbackR=/home/logbackup/processorlog1</span><br><span class="line"></span><br><span class="line">    cd $nettylog</span><br><span class="line">    find ./ -name netty.log-`date -d yesterday +%F`."*".log -exec cp &#123;&#125; $nettyback \;</span><br><span class="line">    tar -zcf $nettyback/netty-log.`date -d yesterday +%F`.tar.gz $nettyback/*.log</span><br><span class="line">    scp $nettyback/netty-log.`date -d yesterday +%F`.tar.gz 192.168.2.250:$nettybackR</span><br><span class="line">    rm -rf $nettyback/*</span><br><span class="line"></span><br><span class="line">    cd $processorlog</span><br><span class="line">    find ./ -name processor_1.log-`date -d yesterday +%F`."*".log -exec cp &#123;&#125; $processorback \;</span><br><span class="line">    tar -zcf $processorback/processor_1.log-`date -d yesterday +%F`.tar.gz $processorback/*.log</span><br><span class="line">    scp $processorback/processor_1.log-`date  -d yesterday +%F`.tar.gz 192.168.2.250:$processorbackR</span><br><span class="line">    rm -rf $processorback/*</span><br><span class="line"><span class="meta">#</span><span class="bash">本打算使用find ./ -name processor_1.log-`date -d yesterday +%F`.<span class="string">"*"</span>.<span class="built_in">log</span> -<span class="built_in">exec</span> tar -zcf processor_log-`date -d yesterday +%F`.tar.gz &#123;&#125; \;命令来直接打包，但测试发现打出的包中只有find查到的最后一个文件。所以将命令改为了两条，先将找到的文件移到一个临时目录，再打包发送。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>定时任务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line">	* 4 * * * /bin/bash /root/sh/scplog.sh</span><br><span class="line">crontab -l</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/18/阿里云RDS数据库备份下载/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/阿里云RDS数据库备份下载/" itemprop="url">
                  阿里云RDS数据库备份下载
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-18 10:20:56" itemprop="dateCreated datePublished" datetime="2018-09-18T10:20:56+08:00">2018-09-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-15 13:05:28" itemprop="dateModified" datetime="2018-11-15T13:05:28+08:00">2018-11-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云RDS数据库备份下载/" itemprop="url" rel="index"><span itemprop="name">阿里云RDS数据库备份下载</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>下载RDS数据备份或日志备份</p>
<ol>
<li>登录RDS管理控制台</li>
<li>选择目标实例所在地域。</li>
<li>单击目标实例的ID，进入基本信息页面</li>
<li>在左侧导航栏中，选择备份恢复，进入备份恢复页面</li>
<li>选择数据备份标签页</li>
<li>选择查询的时间范围，然后单击查询。</li>
<li>在数据备份列表中，找到要下载的数据备份，并单击其对应的下载</li>
<li>在实例备份文件下载窗口，单击复制外网地址，获取数据备份文件外网下载地址。这里可以直接下载到本地，也可以通过内网或外网地址下载</li>
<li>登录云服务器ECS</li>
<li>下载数据备份文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -c '&lt;数据备份文件内网或外网下载地址&gt;' -O &lt;自定义文件名&gt;.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash">-c：启用断点续传模式。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-O：将下载的结果保存为指定的文件（建议使用URL中包含的文件名）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">说明：若提示显示100%进度，则表示文件下载完成。</span></span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/mysql备份与还原/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/17/mysql备份与还原/" itemprop="url">
                  mysql备份与还原
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-17 14:08:03" itemprop="dateCreated datePublished" datetime="2018-09-17T14:08:03+08:00">2018-09-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-10-12 10:45:21" itemprop="dateModified" datetime="2018-10-12T10:45:21+08:00">2018-10-12</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="mysqldump"><a href="#mysqldump" class="headerlink" title="mysqldump"></a>mysqldump</h1><h2 id="mysqldump备份恢复"><a href="#mysqldump备份恢复" class="headerlink" title="mysqldump备份恢复"></a>mysqldump备份恢复</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf.d/server.cnf</span><br><span class="line">    [mysqld]</span><br><span class="line">    log_bin = mysql_bin</span><br><span class="line"><span class="meta">#</span><span class="bash">开启二进制日志</span></span><br><span class="line">vim /root/.my.cnf</span><br><span class="line">	[client]</span><br><span class="line">    user = 'root'</span><br><span class="line">    password = 'centos'</span><br><span class="line">    host = 'localhost'</span><br><span class="line"><span class="meta">#</span><span class="bash">实现免用户名密码登录</span></span><br><span class="line">mysql -uroot -p &lt; /root/jiaowu.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">将jiaowu.sql文件导入到数据库中</span></span><br><span class="line">mysql</span><br><span class="line">SHOW DATABASES;</span><br><span class="line"><span class="meta">#</span><span class="bash">有jiaowu库了</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看二进制日志位置</span></span><br><span class="line">FLUSH TABLES WITH READ LOCK;</span><br><span class="line"><span class="meta">#</span><span class="bash">再打开一个终端执行此命令，刷新表並且以只讀的方式鎖定所有表，這時再備分</span></span><br><span class="line">mysqldump -uroot -p jiaowu &gt; /tmp/jiaowu.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">导出jiaowu库</span></span><br><span class="line">FLUSH LOGS;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line"><span class="meta">#</span><span class="bash">備份完成後立即釋放鎖</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看二进制日志位置，只取滾動後新建的日志</span></span><br></pre></td></tr></table></figure>
<h2 id="mysqldump命令选项"><a href="#mysqldump命令选项" class="headerlink" title="mysqldump命令选项"></a>mysqldump命令选项</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p jiaowu &gt; /root/jiaowu-`date +%F-%H-%M-%S`.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">備份</span></span><br><span class="line">mysqldump -uroot -p --master-data=2 jiaowu &gt; /root/jiaowu-`date +%F-%H-%M-%S`.sql</span><br><span class="line"><span class="meta">#</span><span class="bash">用了第二條命令會在備份的文件中有CHANGE MASTER TO NASTER_LOG_FILE=`mysql-bin.000008, MASTER_LOG_POS=107`指明現在的日志名稱及位置</span></span><br><span class="line">mysqldump -uroot -p --lock-all-tables --flush-logs --all-databases &gt; /root/all.sql  </span><br><span class="line"><span class="meta">#</span><span class="bash">因為不是所有庫都是InnoDB引擎的，所以要用--lock-all-tables選項，之後備份所有庫，還可以加上--master-data=2選項</span></span><br><span class="line">mysqldump -uroot -p --lock-all-tables --flush-logs --all-databases --master-data=2 &gt; /root/all.sql</span><br><span class="line">less /root/all.sql         </span><br><span class="line"><span class="meta">#</span><span class="bash">查看</span></span><br><span class="line">=======================================================================================</span><br><span class="line">mysqldump</span><br><span class="line">    --master-data=n	    n=&#123;0、1、2&#125;</span><br><span class="line">        0表示不記錄二進制日志文件记录位置</span><br><span class="line">        1表示以CHNAGER MASTER TO的方式記錄位置，可用於恢復後直接啟動從服務器</span><br><span class="line">        2表示以CHNAGER MASTER TO的方式記錄位置，但默認被注釋了</span><br><span class="line">    --lock-all-tables：備份前鎖定所有表</span><br><span class="line">    --flush-logs：備份前鎖完表執行日志滾動             flush滾動</span><br><span class="line">    #如果指定庫中的表類型均為InnoDB，可使用--single-transaction啟動熱備，這時就不用鎖定表了--lock-all-tables，這個過程可能很長</span><br><span class="line">    * 備份多個庫</span><br><span class="line">    --all-databases：備份所有庫</span><br><span class="line">    --databases DB_NAME,DB_NAME,…：備份指定庫              </span><br><span class="line">    #這兩個命令由於備份不只一個數據庫，所以會自動創建create databases命令，還原前就不用手動再指定庫了</span><br><span class="line">    --events：備份事件</span><br><span class="line">    --routines：備份存儲過程存儲函數</span><br><span class="line">    --triggers：備份觸發器</span><br></pre></td></tr></table></figure>
<h2 id="備份及即時點還原"><a href="#備份及即時點還原" class="headerlink" title="備份及即時點還原"></a>備份及即時點還原</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">備份及即時點還原</span><br><span class="line">備份策略：每周完全+每日增量</span><br><span class="line">    完全備份：mysqldump</span><br><span class="line">    增量備份：備份二進制日志文件（先flush logs）</span><br><span class="line">    </span><br><span class="line">步骤：</span><br><span class="line">1. 做全量备份</span><br><span class="line">2. 删除现有二进制日志之前的所有日志</span><br><span class="line">3. 删除某表中的一些行，以便下面测试</span><br><span class="line">4. 滚动日志</span><br><span class="line">5. 复制滚动前二进制日志到其他路径或将滚动前二进制日志转为sql文件保存到其他目录，实现增量备份</span><br><span class="line">6. 在删除了行的表中插入新行</span><br><span class="line">7. 将滚动后的日志（也是现在的日志）复制到其他路径</span><br><span class="line">8. 删除数据目录中的所有文件</span><br><span class="line">9. 停止、启动服务器，实现数据初始</span><br><span class="line">10. 修改root密码</span><br><span class="line">11. 导入全量备份的sql文件</span><br><span class="line">12. 导入增量备份的sql文件</span><br><span class="line">13. 将最新的日志文件转为sql文件并导入，实现即时点还原。</span><br><span class="line">14. 这里全量备份不存在对应的二进制日志，因为被删除了。删除后仅剩一个二进制日志，这个日志就是增量备份的日志。之后做其他操作后又滚动过一次日志，也就是最新的日志。这个过程涉及两个日志和一个全量备份的sql文件。</span><br><span class="line"></span><br><span class="line">mysqldump -uroot -p --master-data=2 --flush-logs --all-databases --lock-all-tables &gt; /root/alldatabases.sql</span><br><span class="line">mysql</span><br><span class="line"><span class="meta">#</span><span class="bash">建議在刪除備份前的二進制日志前先將其備份一份，可能以後有用。</span></span><br><span class="line">less /root/ alldatabases.sql</span><br><span class="line">PURGE BINARY LOGS TO 'mysql_bin.000011';             </span><br><span class="line"><span class="meta">#</span><span class="bash">刪除二進制文件，這是為了避免空間被佔滿，这是删除mysql_bin.000011之前的所有二进制日志</span></span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line">DELETE FROM tutors WHERE Age&gt;80;            </span><br><span class="line"><span class="meta">#</span><span class="bash">刪除一些行</span></span><br><span class="line">* 下面做增量備份</span><br><span class="line">mysql</span><br><span class="line">FLUSH LOGS;         </span><br><span class="line"><span class="meta">#</span><span class="bash">滾動</span></span><br><span class="line">quit        </span><br><span class="line"><span class="meta">#</span><span class="bash">退出mysql</span></span><br><span class="line">cd /mydata/data              </span><br><span class="line"><span class="meta">#</span><span class="bash">到數據目錄中</span></span><br><span class="line">cp mysql-bin.000011 /root/          </span><br><span class="line"><span class="meta">#</span><span class="bash">因之前已經滾動了日志，所以倒數第二個就是我們要增量備份的日志，將其拷貝到root目錄即可。</span></span><br><span class="line">或</span><br><span class="line">mysqlbinlog mysql-bin.000011 &gt; /root/mon-incremental.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">這種方式的增量備份更好一些</span></span><br><span class="line">mysql</span><br><span class="line">use studb;</span><br><span class="line">INSERT INTO tutors (Tname) Values (‘stu123’);</span><br><span class="line">退出</span><br><span class="line">* 模擬刪除了數據庫，而不能刪二進制日志</span><br><span class="line">cp mysql-bin.000012 /root           </span><br><span class="line"><span class="meta">#</span><span class="bash">將二進制日志拷出去</span></span><br><span class="line">rm -rf ./*        </span><br><span class="line"><span class="meta">#</span><span class="bash">刪除數據目錄中的所有文件</span></span><br><span class="line">service mysqld stop        </span><br><span class="line"><span class="meta">#</span><span class="bash">現在無法停止mysql</span></span><br><span class="line">killall mysqld              </span><br><span class="line"><span class="meta">#</span><span class="bash">殺死mysql進程</span></span><br><span class="line">cd /usr/local/mysql/            </span><br><span class="line"><span class="meta">#</span><span class="bash">到此目錄初始化mysql</span></span><br><span class="line">scripts/mysql_install_db --user=mysql --datadir=/mydata/data              </span><br><span class="line"><span class="meta">#</span><span class="bash">初始化，这是编译安装的。如果是yum安装的可以直接启动，就会初始化</span></span><br><span class="line">service mysqld start        </span><br><span class="line"><span class="meta">#</span><span class="bash">啟動mysql</span></span><br><span class="line">mysql</span><br><span class="line">UPDATE mysql.user SET PASSWORD=PASSWORD('centos') WHERE User='root';</span><br><span class="line"><span class="meta">#</span><span class="bash">设置root的密码</span></span><br><span class="line">mysql -uroot -p &lt; alldatabases.sql            </span><br><span class="line"><span class="meta">#</span><span class="bash">還原完全備份</span></span><br><span class="line">mysql</span><br><span class="line">mysql -uroot -p</span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line">退出             </span><br><span class="line"><span class="meta">#</span><span class="bash">這一過程是為了驗證增量備份恢復後的變化</span></span><br><span class="line">mysql -uroot -p &lt; mon-incremental.sql          </span><br><span class="line"><span class="meta">#</span><span class="bash">恢復增量備份</span></span><br><span class="line">mysql -uroot -p         </span><br><span class="line"><span class="meta">#</span><span class="bash">進入</span></span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;             </span><br><span class="line"><span class="meta">#</span><span class="bash">查看證明有變化</span></span><br><span class="line">退出</span><br><span class="line">mysqlbinlog mysql-bin.000012 &gt; temp.sql    </span><br><span class="line"><span class="meta">#</span><span class="bash">把日志文件導出為.sql文件</span></span><br><span class="line">mysql -uroot -p &lt; temp.sql           </span><br><span class="line"><span class="meta">#</span><span class="bash">即時點還原。</span></span><br><span class="line">或</span><br><span class="line">mysqlbinlog mysql-bin.000012 | mysql -uroot -p         </span><br><span class="line"><span class="meta">#</span><span class="bash">這樣一條命令即可實現即時點還原</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line">use studb;</span><br><span class="line">SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">上面這樣的試驗只適合在數據量小的時候，如果大的話，mysqldump備份會很慢。視頻中要求寫一個mysql完全備份腳本，增量備份寫成另一個腳本，盡量使用變量定義保存位置，使用日期保存備份的文件名稱。還可用腳本還原</span></span><br></pre></td></tr></table></figure>
<h1 id="xtrabackup"><a href="#xtrabackup" class="headerlink" title="xtrabackup"></a>xtrabackup</h1><h2 id="完全备份与恢复"><a href="#完全备份与恢复" class="headerlink" title="完全备份与恢复"></a>完全备份与恢复</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">* 安装</span><br><span class="line">wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.9/binary/redhat/7/x86_64/Percona-XtraBackup-2.4.9-ra467167cdd4-el7-x86_64-bundle.tar</span><br><span class="line">＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝</span><br><span class="line">* rpm包安装</span><br><span class="line">	* CentOS6</span><br><span class="line">yum install http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm</span><br><span class="line">yum list|grep percona</span><br><span class="line">yum install percona-xtrabackup</span><br><span class="line">	* CentOS7</span><br><span class="line">yum install http://www.percona.com/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm</span><br><span class="line">yum list|grep percona</span><br><span class="line">yum install percona-xtrabackup-24</span><br><span class="line"><span class="meta">#</span><span class="bash">阿里云建议MySQL5.6及之前的版本需要安装 Percona XtraBackup 2.3。MySQL5.7版本需要安装 Percona XtraBackup 2.4。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Percona XtraBackup 2.3地址：https://www.percona.com/doc/percona-xtrabackup/2.3/installation/yum_repo.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Percona XtraBackup 2.4地址：https://www.percona.com/doc/percona-xtrabackup/2.4/installation/yum_repo.html</span></span><br><span class="line">=======================================================================================</span><br><span class="line">innobackupex --help</span><br><span class="line">innobackupex --user=DBUSER --password=DBUSERPASS /path/to/BACKUP-DIR/(保存位置)</span><br><span class="line"><span class="meta">#</span><span class="bash">完全備份。innobackupex是一個腳本，在裡面封裝了一些命令行工具，--user=DBUSER --password=DBUSERPASS是連接服務器要用的帳號密碼。服務器可指定，如--host=localhost，這裡被省略了，因為一般都是在本機上進行備份。/path/to/BACKUP-DIR/指要保存的位置。備份的用戶要有權限，如果要使用一個最小權限的用戶進行備份，則可基於如下命令創建此類用戶。可以創建一個專門備份的用戶，或用管理員也可以</span></span><br><span class="line">=======================================================================================</span><br><span class="line">* 授权</span><br><span class="line">mysql</span><br><span class="line">MariaDB [(none)]&gt; CREATE USER 'bkpuser'@'localhost' IDENTIFIED BY 'centos';</span><br><span class="line"><span class="meta">#</span><span class="bash">创建用户</span></span><br><span class="line">MariaDB [(none)]&gt; REVOKE ALL PRIVILEGES,GRANT OPTION FROM 'bkpuser'@'localhost';</span><br><span class="line"><span class="meta">#</span><span class="bash">取消用户所有权限与授权权限</span></span><br><span class="line">MariaDB [(none)]&gt; GRANT RELOAD,LOCK TABLES,REPLICATION CLIENT ON *.* TO 'bkpuser'@'localhost';</span><br><span class="line"><span class="meta">#</span><span class="bash">只需要RELOAD, LOCK TABLES, REPLICATION CLIENT這三個權限就可備份了</span></span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line">MariaDB [(none)]&gt; SHOW GRANTS;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看当前用户的授权</span></span><br><span class="line">MariaDB [(none)]&gt; SHOW GRANTS FOR bkpuser@localhost;</span><br><span class="line"><span class="meta">#</span><span class="bash">查看指定用户的授权</span></span><br><span class="line">* 备份</span><br><span class="line">innobackupex --user=root /backup          </span><br><span class="line"><span class="meta">#</span><span class="bash">備份數據庫，自動完成的。這裡的密碼是空，所以省略了，服務器是本機。另外，備份時需要mysql服務器是啟動狀態。備份好後在/backup下有一個以當前時間命名的目錄。使用上面的bkpuser用户备份时会提示有授权问题，也就是缺少某些权限，待解决</span></span><br><span class="line">cd /backup/2016-12-09_22-17-27           </span><br><span class="line"><span class="meta">#</span><span class="bash">目錄中的內容如下:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">jiaowu、mysql、<span class="built_in">test</span>、mydb等是數據庫，ibdata1是表空間文件，backup-my.cnf是服務器的配置文件， 備份好以後可以看到備份好的文件中有一個xtrabackup_binlog_info文件，這是二進制日志信息的文件，可用cat打開，裏面是備份這一刻的二進制文件名與相應的號碼。xtrabackup_binary中有在備份時使用了哪個命令進行的備份的信息，視頻中顯示的是xtrabackup 55。xtrabackup_logfile文件是data數據文件，不能用cat打開；xtrabackup_checkpoints文件裡有備份類型及從哪個邏輯版本號開始的備份，其中to_lsn指的是InnoDB的每一個數據塊InnoDB存儲引擎的數據要存儲在磁盤上，它是存儲數據塊的，每一個數據塊都有一個日志序列號，InnoDB會在內部維持着當前每一數據塊的日志序列號，如果這個塊上的數據發生了改變，這個號碼會加1,下一次可以根據這個號碼做增量備份。如果某一個塊的號碼發生了改變，可以將某一個塊備份一下。這就是可以對InnoDB存儲引擎做增量備份的原因；這裏的信息顯示從0號開始，到1637454結束，下一次就從1637454開始</span></span><br><span class="line"><span class="meta">#</span><span class="bash">這些備份的數據備份完以後是不能直接恢復的，因為備份的數據中有些事務可能只提交了一半，為了避免mysql啟動的修復過程，我們要對備份出來的文件做一些准備工作，然後才能恢復。准備工作包括：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    1.將已經提交的事務同步到數據文件，從日志文件同步到數據文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    2.將尚未提交的事務做回滾</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    用--apply-log選項可完成上面的兩項</span></span><br><span class="line"><span class="meta">#</span><span class="bash">innobackupex --apply-log /backup/*****         </span></span><br><span class="line"><span class="meta">#</span><span class="bash">最後的路徑是我們備份的數據的路徑。這樣就會完成上面提到的兩項工作，不做這項工作的話恢復後mysql是啟動不了的</span></span><br><span class="line">* 测试恢复</span><br><span class="line">mysql</span><br><span class="line">MariaDB [(none)]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0005');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0006');</span><br><span class="line"><span class="meta">#</span><span class="bash">插入两条数据</span></span><br><span class="line">MariaDB [jiaowu]&gt; FLUSH LOGS;</span><br><span class="line"><span class="meta">#</span><span class="bash">做這步是因為備份當前使用的二進制日志會報錯，所以才滾動一次</span></span><br><span class="line">cp /var/lib/mysql/mysql_bin.000003 /root</span><br><span class="line"><span class="meta">#</span><span class="bash">复制滚动前的日志到其他路径，以备数据恢复时使用</span></span><br><span class="line">systemctl stop mariadb</span><br><span class="line">rm -rf rm -rf /var/lib/mysql/*</span><br><span class="line">innobackupex --copy-back /backup/2018-09-19_11-06-30</span><br><span class="line"><span class="meta">#</span><span class="bash">恢复数据。/恢復時用--copy-back選項，這樣就可以了。這時的數據文件存儲位置（/var/lib/mysql/）一定要是空的，不然會報錯</span></span><br><span class="line">cd /var/lib/mysql/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql/</span><br><span class="line"><span class="meta">#</span><span class="bash">修改数据目录中文件的属主属组为mysql</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line"><span class="meta">#</span><span class="bash">启动报错，无法启动。提示：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:48 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:48 [Note] /usr/libexec/mysqld (mysqld 5.5.60-MariaDB) starting as process 8893 ..</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: The InnoDB memory heap is disabled</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Mutexes and rw_locks use GCC atomic builtins</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Compressed tables use zlib 1.2.7</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Using Linux native AIO</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:49 InnoDB: Initializing buffer pool, size = 2.0G</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:50 InnoDB: Completed initialization of buffer pool</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:51:51 InnoDB: highest supported file format is Barracuda.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: No valid checkpoint found.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If you are attempting downgrade from MySQL 5.7.9 or later,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: please refer to http://dev.mysql.com/doc/refman/5.5/en/upgrading-downgrading.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If this error appears when you are creating an InnoDB database,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: the problem may be that during an earlier attempt you managed</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: to create the InnoDB data files, but <span class="built_in">log</span> file creation failed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: If that is the <span class="keyword">case</span>, please refer to</span></span><br><span class="line"><span class="meta">#</span><span class="bash">InnoDB: http://dev.mysql.com/doc/refman/5.5/en/error-creating-innodb.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Plugin <span class="string">'InnoDB'</span> init <span class="keyword">function</span> returned error.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Plugin <span class="string">'InnoDB'</span> registration as a STORAGE ENGINE failed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [Note] Plugin <span class="string">'FEEDBACK'</span> is disabled.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Unknown/unsupported storage engine: InnoDB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">180919 11:52:00 [ERROR] Aborting</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">	[mysqld]</span><br><span class="line">	innodb_force_recovery=6</span><br><span class="line">	log_bin = mysql_bin</span><br><span class="line"><span class="meta">#</span><span class="bash">加入上面一行后，就可以启动了。启动后可以取消这个选项。也可能是没有开启二进制日志的原因，所以可以加入log_bin = mysql_bin。测试发现，加入开启二进制日志后，就不需要innodb_force_recovery选项了，另外，使用innodb_force_recovery启动后，进入数据库是不能操作的，需要将innodb_force_recovery注释后，再重启才能操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">innodb_force_recovery可以设置为1-6,大的数字包含前面所有数字的影响。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1. (SRV_FORCE_IGNORE_CORRUPT):忽略检查到的corrupt页。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2. (SRV_FORCE_NO_BACKGROUND):阻止主线程的运行，如主线程需要执行full purge操作，会导致crash。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3. (SRV_FORCE_NO_TRX_UNDO):不执行事务回滚操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">4. (SRV_FORCE_NO_IBUF_MERGE):不执行插入缓冲的合并操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">5. (SRV_FORCE_NO_UNDO_LOG_SCAN):不查看重做日志，InnoDB存储引擎会将未提交的事务视为已提交。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">6. (SRV_FORCE_NO_LOG_REDO):不执行前滚的操作。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">参考：https://www.jb51.net/article/66951.htm</span></span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; SHOW DATABASES;</span><br><span class="line">MariaDB [jiaowu]&gt; USE jiaowu;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">這時是沒有後來加的00006和000005的，要把剛才備份的二進制日志導入即可</span></span><br><span class="line">mysqlbinlog /root/mysql-bin.000003 &gt; /tmp/abc.sql</span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; SET sql_log_bin=0;</span><br><span class="line"><span class="meta">#</span><span class="bash">临时关闭二进制日志</span></span><br><span class="line">MariaDB [jiaowu]&gt; SOURCE /tmp/abc.sql;</span><br><span class="line"><span class="meta">#</span><span class="bash">导入滚动后的二进制日志生成的sql文件，因为stu00005和00006是在完全备份后加入的</span></span><br><span class="line">MariaDB [jiaowu]&gt; SET sql_log_bin=1;</span><br><span class="line"><span class="meta">#</span><span class="bash">开启二进制日志</span></span><br><span class="line">MariaDB [jiaowu]&gt; USE jiaowu;</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">现在有刚加入的00006和000005的信息了</span></span><br></pre></td></tr></table></figure>
<h2 id="增量备份"><a href="#增量备份" class="headerlink" title="增量备份"></a>增量备份</h2><p>xtrabackup支持對innodb做增量備份，對MyISAM不支持，對MyISAM如果有就做完全備份；MyISAM適合讀多寫少的情況</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0007');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0008');</span><br><span class="line"><span class="meta">#</span><span class="bash">加入两条数据</span></span><br><span class="line">innobackupex --user=root /backup    </span><br><span class="line"><span class="meta">#</span><span class="bash">恢復過一次後必須再重新做一次完全備份，因爲當前的數據庫沒有完全備份</span></span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu0009');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00010');</span><br><span class="line">innobackupex --incremental /backup --incremental-basedir=/backup/2018-09-19_16-04-31/</span><br><span class="line"><span class="meta">#</span><span class="bash">先要指定增量備份的保存位置/backup，--incremental-basedir是指定完全備份的保存位置，它會針對完全備份以後的數據做備份，備份後保存在/backup目錄下。這是第一次增量備份。如果是再一次增量備份時，--incremental-basedir應該指向上一次的增量備份所在的目錄；如果數據庫再次損壞且沒有數據增長，用完全和增量備份就能恢復，如果有數據增長就要再加上二進制日志才能恢復。</span></span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00011');</span><br><span class="line">MariaDB [jiaowu]&gt; INSERT INTO tutors (Tname) VALUES ('stu00012');</span><br><span class="line">innobackupex --incremental /backup --incremental-basedir=/backup/2018-09-19_16-05-33/</span><br><span class="line"><span class="meta">#</span><span class="bash">最後指定的是上一次的增量備份位置,2018-09-19_16-05-33是上一次備份後的目錄。如果之前未做過增量備份，就要指向完全備份</span></span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/</span><br><span class="line"><span class="meta">#</span><span class="bash">/如果有增量備份，這裡一定要指定--redo-only選項；2018-09-19_16-04-34是第一次完全備份；有增量備份的時候我們在實現提交的情況時，只執行redo不要執行endo。这里一定要用--apply-log选项，实现1.將已經提交的事務同步到數據文件，從日志文件同步到數據文件；2.將尚未提交的事務做回滾。不然下面的命令是不能执行的。</span></span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/ --incremental-dir=/backup/2018-09-19_16-05-33/</span><br><span class="line"><span class="meta">#</span><span class="bash">在准備第一次增量備份時要將完全備份寫在前面，還要將增量備份位置寫在最後，用</span></span><br><span class="line">--incremental-dir選項。这是将第一次增量备份合并到完全备份</span><br><span class="line">innobackupex --apply-log --redo-only /backup/2018-09-19_16-04-34/ --incremental-dir=/backup/2018-09-19_16-06-15</span><br><span class="line"><span class="meta">#</span><span class="bash">這是第二次增量備份，還是前面寫完全備份位置，後面是第二次增量備份的位置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">之後的還原只需要還原完全備份即可，因為此時所有的提交操作都已合並到完全備份上去了，所以在還原時兩個增量備份就用不上了</span></span><br><span class="line">systemctl stop mariadb</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">innobackupex --copy-back /backup/2018-09-19_16-04-34/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql/</span><br><span class="line">systemctl start mariadb</span><br><span class="line">mysql</span><br><span class="line">MariaDB [jiaowu]&gt; use jiaowu</span><br><span class="line">MariaDB [jiaowu]&gt; SELECT * FROM tutors;</span><br><span class="line"><span class="meta">#</span><span class="bash">这里有上面插入的所有数据</span></span><br></pre></td></tr></table></figure>
<h2 id="導入或導出單張表，前提是每表一個表空間才可以"><a href="#導入或導出單張表，前提是每表一個表空間才可以" class="headerlink" title="導入或導出單張表，前提是每表一個表空間才可以"></a>導入或導出單張表，前提是每表一個表空間才可以</h2><p>&emsp;&emsp;默認情況下，InnoDB表不能通過直接復制表文件的方式在mysql服務器之間進行移植，即便使用了innodb_file_per_table選項。而使用xtrabackup工具可以實現此種功能，不過，此時需要導出表的mysql服務器啟用了innodb_file_per_table選項（嚴格來說，是要導出的表在其創建之前，mysql服務器就啟用了innodb_file_per_table選項），並且導入表的服務器同時啟用了innodb_file_per_table和innodb_expand_import選項</p>
<ol>
<li>導出表</li>
</ol>
<p>導出表是在備份的prepare階段進行的，因此，一旦完全備份完成，就可以在prepare過程中通過–export選項將某表導出了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innobackupex --apply-log --export /path/to/backup</span><br><span class="line"><span class="meta">#</span><span class="bash">此命令會為每個innodb表的表空間創建一個以.exp結尾的文件，這些以.exp結尾的文件則可以用於導入至其它服務器。</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>導入表</li>
</ol>
<p>要在mysql服務器上導入來自於其它服務器的某innodb表，需要先在當前服務器上創建一個跟原表表結構一致的表，而後才能實現將表導入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash">CREATE TABLE mytable (…) ENGINE=InnoDB;</span></span><br></pre></td></tr></table></figure>
<p>然後將此表的表空間刪除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash">ALTER TABLE mydatabase.mytable DISCARD TABLESPACE;</span></span><br></pre></td></tr></table></figure>
<p>接下來，將來自於導出表的服務器的mytable表的mytable.ibd和mytable.exp文件復制到當前服務器的數據目錄，然後使用如下命令將其導入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> ALTER TABLE mydatabase.mytable IMPORT TABLESPACE;</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/nginx功能测试二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/17/nginx功能测试二/" itemprop="url">
                  nginx功能测试二
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-17 11:10:22" itemprop="dateCreated datePublished" datetime="2018-09-17T11:10:22+08:00">2018-09-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-09-29 16:25:46" itemprop="dateModified" datetime="2018-09-29T16:25:46+08:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="https"><a href="#https" class="headerlink" title="https"></a>https</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">* 创建CA服务器</span><br><span class="line">cd /etc/pki/CA</span><br><span class="line">(umask 077;openssl genrsa -out private/cakey.pem 2048)</span><br><span class="line">openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 365</span><br><span class="line">touch index.txt serial</span><br><span class="line">echo 01 &gt; serial</span><br><span class="line">* 到web服务器</span><br><span class="line">mkdir /etc/nginx/ssl</span><br><span class="line">cd /etc/nginx/ssl</span><br><span class="line">(umask 077;openssl genrsa -out nginx.key 2048)</span><br><span class="line">openssl req -new -key http.key -out nginx.csr</span><br><span class="line">scp nginx.csr 192.168.1.2:/tmp</span><br><span class="line">* 到CA服务器</span><br><span class="line">openssl ca -in /tmp/nginx.csr -out /etc/pki/CA/certs/nginx.crt -days 365</span><br><span class="line"><span class="meta">#</span><span class="bash">newcerts中的也是证书，是pem格式的</span></span><br><span class="line">scp certs/nginx.crt 192.168.1.3:/etc/nginx/ssl</span><br><span class="line">* 到web服务器</span><br><span class="line">cp conf.d/vhost1.conf conf.d/vhost1_ssl.conf</span><br><span class="line">vim conf.d/vhost1_ssl.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name www.ruopu.com;</span><br><span class="line">        root /data/nginx/vhost1;</span><br><span class="line">        access_log /var/log/nginx/vhost1_ssl_access.log main;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">        #当前虚拟主机使用PEM格式的证书文件</span><br><span class="line">        ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">        #当前虚拟主机上与其证书匹配的私钥文件</span><br><span class="line">        ssl_protocols sslv3 tlsv1 tlsv1.1 tlsv1.2;</span><br><span class="line">        #支持ssl协议版本，默认为后三个</span><br><span class="line">        ssl_session_cache shared:SSL:10m;</span><br><span class="line">        #在各worker之间使用一个共享的缓存。SSL是自定义的名字，1m内存空间可以缓存4000个会话，这里定义10M。</span><br><span class="line">    &#125;    </span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line">ss -tln</span><br><span class="line">访问https://www.ruopu.com，将cacert.pem传到主机，这里定义的CA服务器与客户端的主机名是一样的，访问时通过了。</span><br></pre></td></tr></table></figure>
<h1 id="重写"><a href="#重写" class="headerlink" title="重写"></a><strong>重写</strong></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    server&#123;</span><br><span class="line">    	rewrite /(.*)\.png$ /$1.jpg;</span><br><span class="line">    	#rewrite放在server中，另外放在location或if中也可以。上面配置表示，所有以.png结尾的文件都转成.jpg格式的。括号是为了后面的$1引用，/是根，png前面的点需要转义，后面的.jpg的点不需要转义</span><br><span class="line">    &#125;</span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line">访问www.ruopu.com/images/fish.png，这里实际访问的是一个叫fish.jpg的文件，名字一样但格式不同。</span><br><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name www.ruopu.com;</span><br><span class="line">       root /data/nginx/vhost1;</span><br><span class="line">       error_page 404 /notfound.html;</span><br><span class="line">    #   rewrite /(.*)$ https://www.ruopu.com/$1;</span><br><span class="line">       rewrite /(.*)\.png$ https://www.ruopu.com/$1.jpg;</span><br><span class="line">       #用户请求任何内容，都转到https的页面上。但两条不要一起写，如果一起写，在访问www.ruopu.com/images/night.png时会先匹配上面的规则，下面的规则就不会生效了。</span><br><span class="line">       location = /notfound.html &#123;</span><br><span class="line">            root /data/nginx/error_pages;</span><br><span class="line">       &#125;</span><br><span class="line">       location ^~ /images/ &#123;</span><br><span class="line">            alias /data/pictures/;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~* ^/(admin|login) &#123;</span><br><span class="line">            auth_basic "admin area or login url";</span><br><span class="line">            auth_basic_user_file /etc/nginx/.ngxpasswd;</span><br><span class="line">       &#125;</span><br><span class="line">       location /ngxstatus &#123;</span><br><span class="line">            stub_status;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">vim /etc/nginx/conf.d/vhost1_ssl.conf</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 443 ssl;</span><br><span class="line">       server_name www.ruopu.com;</span><br><span class="line">       root /data/nginx/vhost1;</span><br><span class="line">       location ^~ /images/ &#123;</span><br><span class="line">            alias /data/pictures/;</span><br><span class="line">       &#125;</span><br><span class="line">       access_log /var/log/nginx/vhost1_ssl_access.log main;</span><br><span class="line">       ssl on;</span><br><span class="line">       ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">       ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">       ssl_protocols sslv3 tlsv1 tlsv1.1 tlsv1.2;</span><br><span class="line">       ssl_session_cache shared:SSL:10m;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">vhost1_ssl.conf配置文件中也要有与vhost1.conf中相同的配置，这样才能正常访问，这里是定义的别名与vhost1.conf中是一样的，也就是要有相同的访问路径，不然不能正常访问，会有404的错误提示。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">上面的重写要写在监听80端口的server中，不能写在监听在443端口的server中，如果写在监听在443端口的server中，那么请求会无限重定向，最后是无法访问的。监听80端口与监听443端口的两个server中定义的内容应该是一样的。不然访问80端口时能访问的路径被重定向到443端口时就访问不到了。如果想让访问80端口的任何以png结尾的文件，都被重定向到443端口的.jpg文件，那么就要在监听443端口的配置文件中加入 rewrite /(.*)\.png$ /<span class="variable">$1</span>.jpg;，如果在监听80端口的server中定义是不起作用的。这是在要将所有访问的内容都重定向到443端口，并且还要让访问png文件的请求重定向到443端口的jpg文件，这两个条件都存在的情况下需要的配置。但如果只是将访问80端口的以png结尾的文件重定向到443端口的jpg文件的话，只要在监听80端口的server中写入 rewrite /(.*)\.png$ https://www.ruopu.com/<span class="variable">$1</span>.jpg; 就行了。</span></span><br><span class="line">nginx -s reload</span><br><span class="line">访问https://www.ruopu.com/images/night.png，rewrite规则可以写多条，rewrite匹配并重写url后会以新的url地址重新匹配配置文件或重新检查location的规则，如果可以匹配到，就会再重写一遍，直到匹配不到。默认的行为是last，就是重写的url会被重新再匹配一遍规则。还有break、redirect、permanent</span><br><span class="line">vim /etc/nginx/conf.d/vhost1.conf</span><br><span class="line">    server&#123;</span><br><span class="line">		rewrite /(.*)\.png$ /$1.jpg redirect;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">redirect是重定向，客户端要重新发起请求。如果是permanent就是永久重定向，也需要客户端重新发请求。last和<span class="built_in">break</span>是不需要客户端重新发请求的，只是服务器内部做了转换</span></span><br><span class="line">=======================================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash">[flag]：</span></span><br><span class="line">	last：重写完成后停止对当前URI在当前location中后续的其它重写操作，而后对新的URI启动新一轮重写检查；提前重启新一轮循环；</span><br><span class="line">    break：重写完成后停止对当前URI在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置；结束循环；</span><br><span class="line">    redirect：重写完成后以临时重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；不能以http://或https://开头；302</span><br><span class="line">    permanent：重写完成后以永久重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；301</span><br></pre></td></tr></table></figure>
<h1 id="反代"><a href="#反代" class="headerlink" title="反代"></a>反代</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">* 准备三台主机，一台反代，两台web服务，反代服务器的地址有两个，一个外网192.168.1.90，一个内网172.16.0.1。web服务器有两个内网地址，一个172.16.0.2，一个172.16.0.3。设置内网地址，就是将虚拟机网卡改为仅主机，然后设置仅主机的IP地址</span><br><span class="line">yum install httpd mod_ssl</span><br><span class="line">//到web服务器上安装httpd，mod_ssl，并提供主页，最后改为内网网卡并配置地址。改为内网地址172.16.0.2</span><br><span class="line">vim /var/www/html/index.html</span><br><span class="line">	&lt;h1&gt;Real Server 1&lt;/h1&gt;</span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eno16777736</span><br><span class="line">    IPADDR=172.16.0.2</span><br><span class="line">    NETMASK=255.255.0.0</span><br><span class="line">systemctl start httpd</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">* 到反代服务器</span><br><span class="line">vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">    [nginx]</span><br><span class="line">    name=nginx repository</span><br><span class="line">    baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">    gpgcheck=0</span><br><span class="line">    enabled=1</span><br><span class="line">yum install nginx</span><br><span class="line">vim /etc/nginx/conf.d/ruopu.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name www.ruopu.com</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://172.16.0.2:80；</span><br><span class="line">        //这里要看web服务器是基于什么做的虚拟主机，是IP，port还是FQDN，是哪个就在http后输入哪个</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">nginx -t</span><br><span class="line">systemctl start nginx</span><br><span class="line">* 修改客户端hosts文件，让主机可以解析nginx的域名</span><br><span class="line">* 访问测试</span><br><span class="line">* 到web服务器上</span><br><span class="line">tcpdump -i eno16777736 tcp port 80</span><br><span class="line">//监听80端口，看一下请求是否为反代服务器发来的</span><br><span class="line">* 到第二台web服务器上</span><br><span class="line">yum install httpd</span><br><span class="line">改为内网地址172.16.0.3</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">vim /var/www/html/index.html</span><br><span class="line">	&lt;h1&gt;Real Server 2&lt;/h1&gt;</span><br><span class="line">find /usr/share -iname "*.jpg" -exec cp &#123;&#125; /var/www/html \;</span><br><span class="line">//这一次准备将图片文件都反代到这台服务器</span><br><span class="line">systemctl start httpd</span><br><span class="line">* 到反代服务器，加入</span><br><span class="line">vim /etc/nginx/conf.d/ruopu.conf</span><br><span class="line">    location ~* \.(jpg|jpeg|png)$ &#123;</span><br><span class="line">        proxy_pass http://172.16.0.3:80;</span><br><span class="line">    //将访问图片的请求代理到另一台服务器上</span><br><span class="line">    &#125;</span><br><span class="line">* 到客户端访问，如果是访问域名就返回第一台web服务器的内容，如果访问域名/*.jpg就返回第二台服务器的内容。在配置文件中，如果location中用了正则表达式，在proxy_pass指向的地址中的80端口后是不能加斜线/的，如果没用正则表达式，可以加斜线。像上边的第一个location设置，如果80后有斜线，表示将location中的斜线替换成80后的斜线，如果没有斜线，表示将location中的斜线补在80后</span><br><span class="line">* 测试斜线的功能，到反代服务器上</span><br><span class="line">vim /etc/nginx/conf.d/ruopu.com</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name www.ruopu.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">        	root /data/nginx/html;</span><br><span class="line">        &#125;</span><br><span class="line">        location /admin/ &#123;</span><br><span class="line">            proxy_pass http://172.16.0.2:80;</span><br><span class="line">            //这个反代的意思是在172.16.0.2的根目录下找admin目录，下面的反代是在访问以jpg等为后缀名的文件时到172.16.0.3:80的根目录下找</span><br><span class="line">        &#125;</span><br><span class="line">        location ~* \.(jpg|jpeg|png)$ &#123;</span><br><span class="line">        	proxy_pass http://172.16.0.3:80;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //修改配置文件，将admin代理过去</span><br><span class="line">mkdir -pv /data/nginx/html</span><br><span class="line">nginx -s reload</span><br><span class="line">* 到客户端访问www.ruopu.com/admin，提示Not Found，因为web服务器上没有admin目录。但是，如果location /admin/中的80后有斜线，那么访问的就是172.16.0.2的根目录，也就是/var/www/html/index.html文件。也就是，没有斜线，就将/admin补在80后，因为172.16.0.2中没有admin目录，所以提示Not Found。如果有斜线，就表示访问http://172.16.0.2/admin就是在访问172.16.0.2的根目录，/admin/就等于/。</span><br><span class="line">* 到web服务器上</span><br><span class="line">mkdir /var/www/html/admin</span><br><span class="line">vim /var/www/html/admin/index.html</span><br><span class="line">	admin</span><br><span class="line">* 到客户端测试，这时显示admin</span><br><span class="line">* 到反代服务器上加一个斜线</span><br><span class="line">vim /etc/nginx/conf.d/ruopu.com</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name www.ruopu.com;</span><br><span class="line">       location / &#123;</span><br><span class="line">            root /data/nginx/html;</span><br><span class="line">       &#125;</span><br><span class="line">       location /admin/ &#123;</span><br><span class="line">            proxy_pass http://10.5.5.204:80/;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~* \.(jpg|jpeg|png)$ &#123;</span><br><span class="line">            proxy_pass http://10.5.5.205:80;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line">* 到客户端访问www.ruopu.com/admin，这时显示的是Real Server 1，也就是web服务器上html中定义的内容，配置的意思就是，当访问admin时，就替换成web服务器根下的内容。当location中定义的是根时，这个斜线就没有意义了，因为访问的都是根</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/14/阿里云数据库连接与设置阿里云RDS字符集/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ruopu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ruopu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/14/阿里云数据库连接与设置阿里云RDS字符集/" itemprop="url">
                  阿里云数据库连接与设置阿里云RDS字符集
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-09-14 13:32:44" itemprop="dateCreated datePublished" datetime="2018-09-14T13:32:44+08:00">2018-09-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新於</span>
                
                <time title="修改時間：2018-11-15 13:04:54" itemprop="dateModified" datetime="2018-11-15T13:04:54+08:00">2018-11-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/阿里云数据库连接/" itemprop="url" rel="index"><span itemprop="name">阿里云数据库连接</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="测试数据库连接"><a href="#测试数据库连接" class="headerlink" title="测试数据库连接"></a>测试数据库连接</h1><p>注：阿里云在添加白名单时，如果是内网主机，就选专有网络。因为虚拟机与阿里云RDS都使用的是专有网络。如果用外网连接数据库，就将外网的地址添加到白名单的经典网络。另外，还要注意数据库中的用户应该有从外网地址连接的权限。</p>
<p><img src="/images/aliRDS/设置白名单.jpg" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# traceroute -n -T -p 3306 rm-2zeik6f1smno.mysql.rds.aliyuncs.com</span><br><span class="line">traceroute to rm-2zeiks9o06fas81smno.mysql.rds.aliyuncs.com (0.90.0.18), 30 hops max, 60 byte packets</span><br><span class="line"> 1  * * *</span><br><span class="line"> 2  123.127.52.225  1.151 ms  1.556 ms  1.948 ms</span><br><span class="line"> 3  124.65.151.117  9.099 ms  9.282 ms  9.376 ms</span><br><span class="line"> 4  124.65.226.253  3.983 ms  4.504 ms  4.656 ms</span><br><span class="line"> 5  * * *</span><br><span class="line"> 6  * 61.51.169.69  5.301 ms *</span><br><span class="line"> 7  * * *</span><br><span class="line"> 8  * * *</span><br><span class="line"> 9  123.56.34.25  6.576 ms 101.200.109.133  5.156 ms  4.126 ms</span><br><span class="line">10  * * 123.56.34.89  4.640 ms</span><br><span class="line">11  * * *</span><br><span class="line">12  * * *</span><br><span class="line">13  * * *</span><br><span class="line">14  * * *</span><br><span class="line">15  * * *</span><br><span class="line">16  * * *</span><br><span class="line">17  * * *</span><br><span class="line">18  * * *</span><br><span class="line">19  * * *</span><br><span class="line">20  * * *</span><br><span class="line">21  * * *</span><br><span class="line">22  * * *</span><br><span class="line">23  * * *</span><br><span class="line">24  * * *</span><br><span class="line">25  * * *</span><br><span class="line">26  * * *</span><br><span class="line">27  * * *</span><br><span class="line">28  * * *</span><br><span class="line">29  * * *</span><br><span class="line">30  * * *</span><br><span class="line"><span class="meta">#</span><span class="bash">上述探测数据中，目标端口在第 11 跳之后就没有数据返回。说明相应端口在该节点被阻断。</span></span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://help.aliyun.com/knowledge_detail/40572.html?spm=5176.11065259.1996646101.searchclickresult.4ffa1754h73l7T（能" target="_blank" rel="noopener">https://help.aliyun.com/knowledge_detail/40572.html?spm=5176.11065259.1996646101.searchclickresult.4ffa1754h73l7T（能</a> ping 通但端口不通时端口可用性探测说明）</p>
<h1 id="修改字符集"><a href="#修改字符集" class="headerlink" title="修改字符集"></a>修改字符集</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1. 连接数据库</span><br><span class="line">mysql -hrm-2zeiks9sm.mysql.rds.aliyuncs.com -uroot -p</span><br><span class="line">2. 查看字符集</span><br><span class="line">MySQL [(none)]&gt; show variables like '%char%';</span><br><span class="line">+--------------------------+---------------------------------------+</span><br><span class="line">| Variable_name            | Value                                 |</span><br><span class="line">+--------------------------+---------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                  |</span><br><span class="line">| character_set_connection | utf8                                  |</span><br><span class="line">| character_set_database   | utf8                                  |</span><br><span class="line">| character_set_filesystem | binary                                |</span><br><span class="line">| character_set_results    | utf8                                  |</span><br><span class="line">| character_set_server     | utf8                                  |</span><br><span class="line">| character_set_system     | utf8                                  |</span><br><span class="line">| character_sets_dir       | /u01/mysql57_20180725/share/charsets/ |</span><br><span class="line">+--------------------------+---------------------------------------+</span><br><span class="line">3. 修改字符集</span><br><span class="line">MySQL [echarging]&gt; set character_set_client=utf8mb4;</span><br><span class="line">MySQL [echarging]&gt; set character_set_connection=utf8mb4;</span><br><span class="line">MySQL [echarging]&gt; set character_set_results=utf8mb4;</span><br><span class="line">MySQL [echarging]&gt; set character_set_database=utf8mb4; </span><br><span class="line">MySQL [echarging]&gt; set character_set_server=utf8mb4;</span><br><span class="line">4. 修改character_set_server也可以在阿里云的控制台操作</span><br></pre></td></tr></table></figure>
<p><img src="/images/aliRDS/设置mysql参数1.jpg" alt="打开设置参数"></p>
<p><img src="/images/aliRDS/设置mysql参数2.jpg" alt="找到要修改的项进行修改"></p>
<p><img src="/images/aliRDS/设置mysql参数3.jpg" alt="修改后提交"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ruopu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">41</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ruopu</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
